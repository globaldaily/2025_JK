<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>JAPANKURU Wallet (Demo)</title>
<style>
/* --- ë””ìì¸ í† í° --- */
:root{
  --primary:#007AFF;--secondary:#5856D6;--success:#34C759;--warning:#FF9500;--danger:#FF3B30;
  --gray-50:#F2F2F7;--gray-100:#E5E5EA;--gray-200:#D1D1D6;--gray-300:#C7C7CC;--gray-400:#AEAEB2;
  --gray-500:#8E8E93;--gray-600:#636366;--gray-700:#48484A;--gray-800:#2C2C2E;--gray-900:#1C1C1E;
  --bg:#fff;--surface:#F2F2F7;--text:#000;--text-secondary:#8E8E93;
  --r:20px;--r-sm:12px;--r-xs:8px;--shadow:0 4px 12px rgba(0,0,0,.08);--shadow-lg:0 10px 40px rgba(0,0,0,.12);
  --font:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",sans-serif;
}
@media(prefers-color-scheme:dark){
  :root{--bg:#000;--surface:#1C1C1E;--text:#fff;--gray-50:#1C1C1E;--gray-100:#2C2C2E;}
}
*{box-sizing:border-box}body{margin:0;font-family:var(--font);background:var(--surface);color:var(--text);font-size:17px;line-height:1.5}
.container{max-width:1200px;margin:0 auto;padding:0 20px}

/* í—¤ë” */
header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.8);backdrop-filter:blur(20px);border-bottom:0.5px solid var(--gray-200)}
@media(prefers-color-scheme:dark){header{background:rgba(28,28,30,.8)}}
.header-inner{display:flex;align-items:center;justify-content:space-between;height:52px}
.logo{display:flex;align-items:center;gap:10px;color:inherit;text-decoration:none;font-weight:600;font-size:19px}
.logo img{height:28px}
.lang-select{padding:6px 12px;border:none;border-radius:var(--r-xs);background:var(--gray-100);color:inherit;min-width:120px}

/* íˆì–´ë¡œ */
.hero{margin:30px 0;padding:60px 40px;border-radius:var(--r);color:#fff;background:linear-gradient(135deg,var(--primary),var(--secondary));text-align:center}
.hero h1{margin:0 0 12px;font-size:48px;font-weight:700;letter-spacing:-.02em}
.hero p{font-size:21px;opacity:.95}
@media(max-width:768px){.hero{padding:40px 20px}.hero h1{font-size:32px}.hero p{font-size:17px}}

/* ê²€ìƒ‰/íƒ­ */
.search-wrapper{position:relative;margin-bottom:20px}
.search-input{width:100%;padding:16px 20px 16px 48px;border:none;border-radius:12px;background:var(--bg);box-shadow:var(--shadow);font-size:17px}
.search-icon{position:absolute;left:16px;top:50%;transform:translateY(-50%);opacity:.5}
.tabs{display:flex;gap:10px;overflow-x:auto;padding-bottom:10px;margin-bottom:24px}
.tab{padding:10px 20px;border:none;border-radius:999px;background:var(--bg);box-shadow:0 1px 3px rgba(0,0,0,.12);white-space:nowrap;cursor:pointer}
.tab.active{background:var(--primary);color:#fff;box-shadow:0 4px 12px rgba(0,122,255,.3)}
.tab .badge{margin-left:6px;padding:2px 8px;border-radius:999px;background:rgba(0,0,0,.08);font-size:12px;font-weight:700}

/* ê·¸ë¦¬ë“œ/ì¹´ë“œ */
.coupon-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:24px;margin-bottom:60px}
@media(max-width:768px){.coupon-grid{grid-template-columns:1fr;gap:16px}}
.coupon-card{background:var(--bg);border-radius:12px;overflow:hidden;box-shadow:var(--shadow);cursor:pointer;position:relative;transition:transform .2s}
.coupon-card:hover{transform:translateY(-6px)}
.coupon-card img{width:100%;height:200px;object-fit:cover}
.expiry-badge{position:absolute;top:12px;right:12px;background:var(--danger);color:#fff;padding:6px 12px;border-radius:999px;font-size:13px;font-weight:700}
.coupon-body{padding:20px}
.coupon-title{font-size:22px;font-weight:600}
.coupon-offer{margin:6px 0 10px;color:var(--danger);font-size:26px;font-weight:800}
.coupon-desc{color:var(--text-secondary);font-size:15px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.coupon-footer{display:flex;align-items:center;justify-content:space-between;margin-top:14px;padding-top:14px;border-top:1px solid var(--gray-100)}
.save-btn{padding:8px 14px;border:none;border-radius:999px;background:var(--gray-100);cursor:pointer}
.save-btn.saved{background:var(--warning);color:#fff}

/* ì €ì¥ ì •ë³´/ì—†ìŒ */
.saved-info{display:none;background:linear-gradient(135deg,var(--warning),#FF8800);color:#fff;padding:12px 16px;border-radius:12px;margin-bottom:16px}
.saved-info.show{display:block}
.no-results{display:none;text-align:center;padding:60px 20px}.no-results.show{display:block}

/* ëª¨ë‹¬ */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(10px);z-index:1000;align-items:center;justify-content:center;padding:20px}
.modal.show{display:flex}
.modal-content{background:var(--bg);border-radius:20px;box-shadow:var(--shadow-lg);max-width:520px;width:100%;max-height:90vh;overflow:auto;position:relative}
.modal-body{padding:28px}
.modal-close{position:absolute;right:16px;top:16px;width:36px;height:36px;border:none;border-radius:50%;background:var(--gray-100);font-size:18px;cursor:pointer}
.modal-title{font-size:24px;font-weight:700;margin-bottom:6px}
.modal-offer{font-size:30px;font-weight:800;color:var(--danger);margin-bottom:16px}
.backimg-wrap{background:var(--surface);border-radius:12px;padding:16px;text-align:center}
.backimg{max-width:100%;height:auto;border-radius:8px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 18px;border:none;border-radius:999px;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff}
.btn-secondary{background:var(--gray-100)}
.links-section{display:flex;flex-direction:column;gap:10px;margin:16px 0}
.link-item{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-radius:10px;background:var(--bg);border:1px solid var(--gray-100);text-decoration:none;color:inherit}
.modal-section h3{margin:16px 0 8px;font-size:16px;color:var(--text-secondary)}
</style>
</head>
<body>
<header>
  <div class="container">
    <div class="header-inner">
      <a class="logo" href="/"><img src="https://japankuru.com/gld-kanri/data/themes/japankuru/assets/images/logo.svg" alt="Japankuru"><span>Wallet</span></a>
      <select id="langSelect" class="lang-select" aria-label="Language">
        <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option><option value="en">ğŸ‡ºğŸ‡¸ English</option>
        <option value="zh">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</option><option value="zh-tw">ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡</option>
        <option value="th">ğŸ‡¹ğŸ‡­ à¹„à¸—à¸¢</option><option value="id">ğŸ‡®ğŸ‡© Indonesia</option>
      </select>
    </div>
  </div>
</header>

<div class="container">
  <div class="hero">
    <h1 data-i18n="hero_title">ì¼ë³¸ ì—¬í–‰ í• ì¸ ì¿ í°</h1>
    <p data-i18n="hero_desc">ì¸ê¸° ë§¤ì¥ì—ì„œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ í• ì¸ ì¿ í°</p>
  </div>

  <div class="search-wrapper">
    <span class="search-icon">ğŸ”</span>
    <input id="searchInput" class="search-input" type="search" placeholder="ë§¤ì¥ëª…, ì§€ì—­ìœ¼ë¡œ ê²€ìƒ‰..." data-i18n-placeholder="search_placeholder">
  </div>

  <div class="tabs">
    <button class="tab active" data-category="all"><span data-i18n="cat_all">ì „ì²´</span> <span class="badge">0</span></button>
    <button class="tab" data-category="electronics">ğŸ”Œ <span data-i18n="cat_electronics">ì „ìì œí’ˆ</span> <span class="badge">0</span></button>
    <button class="tab" data-category="fashion">ğŸ‘• <span data-i18n="cat_fashion">íŒ¨ì…˜</span> <span class="badge">0</span></button>
    <button class="tab" data-category="dining">ğŸ½ï¸ <span data-i18n="cat_dining">ë§›ì§‘</span> <span class="badge">0</span></button>
    <button class="tab" data-category="transport">ğŸš‡ <span data-i18n="cat_transport">êµí†µ</span> <span class="badge">0</span></button>
    <button class="tab" data-category="saved">â­ <span data-i18n="cat_saved">ì €ì¥ë¨</span> <span class="badge" id="savedBadge">0</span></button>
  </div>

  <div class="saved-info" id="savedInfo"><span data-i18n="saved_info">ì €ì¥ëœ ì¿ í°</span> <strong id="savedCount">0</strong><span data-i18n="saved_unit">ê°œ</span></div>

  <div id="couponGrid" class="coupon-grid"></div>

  <div id="noResults" class="no-results">
    <div style="font-size:72px;opacity:.5">ğŸ”</div>
    <h3 data-i18n="no_results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
    <p data-i18n="no_results_desc">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”</p>
  </div>
</div>

<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <button class="modal-close" onclick="closeModal()" aria-label="Close">Ã—</button>
    <div id="modalBody" class="modal-body"></div>
  </div>
</div>

<script>
/* ===== ì•ˆì „ ì´ìŠ¤ì¼€ì´í”„ ===== */
const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* ===== ë²ˆì—­ ===== */
const translations = {
  ko:{hero_title:'ì¼ë³¸ ì—¬í–‰ í• ì¸ ì¿ í°',hero_desc:'ì¸ê¸° ë§¤ì¥ì—ì„œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ í• ì¸ ì¿ í°',search_placeholder:'ë§¤ì¥ëª…, ì§€ì—­ìœ¼ë¡œ ê²€ìƒ‰...',cat_all:'ì „ì²´',cat_electronics:'ì „ìì œí’ˆ',cat_fashion:'íŒ¨ì…˜',cat_dining:'ë§›ì§‘',cat_transport:'êµí†µ',cat_saved:'ì €ì¥ë¨',saved_info:'ì €ì¥ëœ ì¿ í°',saved_unit:'ê°œ',no_results:'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤',no_results_desc:'ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”',save:'ì €ì¥',unsave:'ì €ì¥ í•´ì œ',close:'ë‹«ê¸°',terms:'ì´ìš©ì¡°ê±´',expiry:'ìœ íš¨ê¸°í•œ',no_expiry:'ë¬´ì œí•œ',share:'ê³µìœ ',view_article:'ê´€ë ¨ ê¸°ì‚¬',visit_website:'ê³µì‹ í™ˆí˜ì´ì§€',view_map:'ì§€ë„ ë³´ê¸°',days_left:'ì¼ ë‚¨ìŒ',expires_today:'ì˜¤ëŠ˜ ë§ˆê°',view_back:'ì¿ í° ì´ë¯¸ì§€ ë³´ê¸°',download:'ì´ë¯¸ì§€ ì €ì¥'},
  en:{hero_title:'Japan Travel Discount Coupons',hero_desc:'Instant discounts at popular stores',search_placeholder:'Search by store or area...',cat_all:'All',cat_electronics:'Electronics',cat_fashion:'Fashion',cat_dining:'Dining',cat_transport:'Transport',cat_saved:'Saved',saved_info:'Saved coupons',saved_unit:'',no_results:'No results found',no_results_desc:'Try different search terms',save:'Save',unsave:'Unsave',close:'Close',terms:'Terms',expiry:'Expiry',no_expiry:'No expiry',share:'Share',view_article:'Related Article',visit_website:'Official Website',view_map:'View Map',days_left:'days left',expires_today:'Ends today',view_back:'View coupon image',download:'Download'},
  zh:{hero_title:'æ—¥æœ¬æ—…è¡Œä¼˜æƒ åˆ¸',hero_desc:'çƒ­é—¨å•†åº—å³æ—¶æŠ˜æ‰£',search_placeholder:'æŒ‰åº—åæˆ–åœ°åŒºæœç´¢...',cat_all:'å…¨éƒ¨',cat_electronics:'ç”µå­äº§å“',cat_fashion:'æ—¶å°š',cat_dining:'ç¾é£Ÿ',cat_transport:'äº¤é€š',cat_saved:'å·²ä¿å­˜',saved_info:'å·²ä¿å­˜çš„ä¼˜æƒ åˆ¸',saved_unit:'å¼ ',no_results:'æ²¡æœ‰æ‰¾åˆ°ç»“æœ',no_results_desc:'å°è¯•å…¶ä»–æœç´¢è¯',save:'ä¿å­˜',unsave:'å–æ¶ˆä¿å­˜',close:'å…³é—­',terms:'ä½¿ç”¨æ¡æ¬¾',expiry:'æœ‰æ•ˆæœŸ',no_expiry:'æ— æœŸé™',share:'åˆ†äº«',view_article:'ç›¸å…³æ–‡ç« ',visit_website:'å®˜æ–¹ç½‘ç«™',view_map:'æŸ¥çœ‹åœ°å›¾',days_left:'å¤©å‰©ä½™',expires_today:'ä»Šå¤©åˆ°æœŸ',view_back:'æŸ¥çœ‹ä¼˜æƒ åˆ¸å›¾ç‰‡',download:'ä¸‹è½½'},
  'zh-tw':{hero_title:'æ—¥æœ¬æ—…è¡Œå„ªæƒ åˆ¸',hero_desc:'ç†±é–€å•†åº—å³æ™‚æŠ˜æ‰£',search_placeholder:'æŒ‰åº—åæˆ–åœ°å€æœç´¢...',cat_all:'å…¨éƒ¨',cat_electronics:'é›»å­ç”¢å“',cat_fashion:'æ™‚å°š',cat_dining:'ç¾é£Ÿ',cat_transport:'äº¤é€š',cat_saved:'å·²ä¿å­˜',saved_info:'å·²ä¿å­˜çš„å„ªæƒ åˆ¸',saved_unit:'å¼µ',no_results:'æ²’æœ‰æ‰¾åˆ°çµæœ',no_results_desc:'å˜—è©¦å…¶ä»–æœç´¢è©',save:'ä¿å­˜',unsave:'å–æ¶ˆä¿å­˜',close:'é—œé–‰',terms:'ä½¿ç”¨æ¢æ¬¾',expiry:'æœ‰æ•ˆæœŸ',no_expiry:'ç„¡æœŸé™',share:'åˆ†äº«',view_article:'ç›¸é—œæ–‡ç« ',visit_website:'å®˜æ–¹ç¶²ç«™',view_map:'æŸ¥çœ‹åœ°åœ–',days_left:'å¤©å‰©é¤˜',expires_today:'ä»Šå¤©åˆ°æœŸ',view_back:'æŸ¥çœ‹å„ªæƒ åˆ¸åœ–ç‰‡',download:'ä¸‹è¼‰'},
  th:{hero_title:'à¸„à¸¹à¸›à¸­à¸‡à¸ªà¹ˆà¸§à¸™à¸¥à¸”à¸à¸²à¸£à¸—à¹ˆà¸­à¸‡à¹€à¸—à¸µà¹ˆà¸¢à¸§à¸à¸µà¹ˆà¸›à¸¸à¹ˆà¸™',hero_desc:'à¸ªà¹ˆà¸§à¸™à¸¥à¸”à¸—à¸±à¸™à¸—à¸µà¸—à¸µà¹ˆà¸£à¹‰à¸²à¸™à¸„à¹‰à¸²à¸¢à¸­à¸”à¸™à¸´à¸¢à¸¡',search_placeholder:'à¸„à¹‰à¸™à¸«à¸²à¸•à¸²à¸¡à¸Šà¸·à¹ˆà¸­à¸£à¹‰à¸²à¸™à¸«à¸£à¸·à¸­à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆ...',cat_all:'à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”',cat_electronics:'à¸­à¸´à¹€à¸¥à¹‡à¸à¸—à¸£à¸­à¸™à¸´à¸à¸ªà¹Œ',cat_fashion:'à¹à¸Ÿà¸Šà¸±à¹ˆà¸™',cat_dining:'à¸­à¸²à¸«à¸²à¸£',cat_transport:'à¸à¸²à¸£à¹€à¸”à¸´à¸™à¸—à¸²à¸‡',cat_saved:'à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¹‰à¸§',saved_info:'à¸„à¸¹à¸›à¸­à¸‡à¸—à¸µà¹ˆà¸šà¸±à¸™à¸—à¸¶à¸',saved_unit:'à¹ƒà¸š',no_results:'à¹„à¸¡à¹ˆà¸à¸šà¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ',no_results_desc:'à¸¥à¸­à¸‡à¸„à¸³à¸„à¹‰à¸™à¸«à¸²à¸­à¸·à¹ˆà¸™',save:'à¸šà¸±à¸™à¸—à¸¶à¸',unsave:'à¸¢à¸à¹€à¸¥à¸´à¸à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸',close:'à¸›à¸´à¸”',terms:'à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚',expiry:'à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸',no_expiry:'à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸³à¸«à¸™à¸”',share:'à¹à¸Šà¸£à¹Œ',view_article:'à¸šà¸—à¸„à¸§à¸²à¸¡à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡',visit_website:'à¹€à¸§à¹‡à¸šà¹„à¸‹à¸•à¹Œà¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸à¸²à¸£',view_map:'à¸”à¸¹à¹à¸œà¸™à¸—à¸µà¹ˆ',days_left:'à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­',expires_today:'à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸à¸§à¸±à¸™à¸™à¸µà¹‰',view_back:'à¸”à¸¹à¸ à¸²à¸à¸„à¸¹à¸›à¸­à¸‡',download:'à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”'},
  id:{hero_title:'Kupon Diskon Perjalanan Jepang',hero_desc:'Diskon instan di toko-toko populer',search_placeholder:'Cari berdasarkan nama toko atau area...',cat_all:'Semua',cat_electronics:'Elektronik',cat_fashion:'Fashion',cat_dining:'Kuliner',cat_transport:'Transportasi',cat_saved:'Tersimpan',saved_info:'Kupon tersimpan',saved_unit:'',no_results:'Tidak ada hasil',no_results_desc:'Coba kata kunci lain',save:'Simpan',unsave:'Batal simpan',close:'Tutup',terms:'Syarat',expiry:'Berlaku hingga',no_expiry:'Tidak terbatas',share:'Bagikan',view_article:'Artikel Terkait',visit_website:'Situs Resmi',view_map:'Lihat Peta',days_left:'hari tersisa',expires_today:'Berakhir hari ini',view_back:'Lihat gambar kupon',download:'Unduh'}
};

/* ===== ìƒíƒœ ===== */
let currentLang='ko';
let savedCoupons=JSON.parse(localStorage.getItem('savedCoupons')||'[]');
let filteredCoupons=[];
let currentCategory='all';
let searchTimer=null;
const getText=(k)=>translations[currentLang][k]||k;

/* ===== ìƒ˜í”Œ ë°ì´í„° (ë°ëª¨ ì „ìš©) ===== */
const couponsData=[
 {id:1,category:'electronics',expiry:'2025-12-31',
  store_ko:'ì½”ì§€ë§ˆ x ë¹…ì¹´ë©”ë¼',store_en:'Kojima x BicCamera',store_zh:'å°å²› x Bic Camera',store_zh_tw:'å°å³¶ x Bic Camera',store_th:'à¹‚à¸„à¸ˆà¸´à¸¡à¸° x à¸šà¸´à¸à¸„à¸²à¹€à¸¡à¸£à¹ˆà¸²',store_id:'Kojima x BicCamera',
  offer:'ìµœëŒ€ 17% OFF',offer_en:'Up to 17% OFF',
  description_ko:'ë©´ì„¸ 10% + ì¶”ê°€ 7% í• ì¸! ìµœì‹  ì „ìì œí’ˆì„ ì €ë ´í•˜ê²Œ.',description_en:'Tax-free 10% + Additional 7% discount!',
  area_ko:'ì•„í‚¤í•˜ë°”ë¼',area_en:'Akihabara',
  image:'https://japankuru.com/gld-kanri/data/uploads/2023/11/kojima%E8%8B%B1%E8%AA%9E%E7%89%88%E4%BC%81%E6%A5%AD%E6%9C%89_kojima_EN_B-2.jpg',
  back_image:'https://img.japankuru.com/prg_img/img/img2024011517461371466800.jpg',
  article_url:'https://www.japankuru.com/en/e2290.html',official_url:'https://www.biccamera.com',maps_url:'https://maps.google.com/?q=35.6909,139.7003'
 },
 {id:2,category:'fashion',expiry:'2025-02-05',
  store_ko:'ì§„ìŠ¤ (JINS)',store_en:'JINS',offer:'10% OFF',offer_en:'10% OFF',
  description_ko:'ë©´ì„¸+í• ì¸ ì•ˆê²½.',description_en:'Tax-free + discount glasses.',
  area_ko:'ì‹œë¶€ì•¼',area_en:'Shibuya',
  image:'https://japankuru.com/gld-kanri/data/uploads/2024/06/japankuru_1800-1200-1536x1024.jpg',
  back_image:'https://img.japankuru.com/prg_img/thumbnail1/img2023112417190332724100.png',
  maps_url:'https://maps.google.com/?q=35.6581,139.6986'
 }
];

/* ===== ì´ˆê¸°í™” ===== */
document.addEventListener('DOMContentLoaded',()=>{
  detectLanguage(); updateLanguage();
  filteredCoupons=[...couponsData];
  renderCoupons(); updateSavedInfo(); updateBadges();
  setupEvents(); applyDeepLink();
});

/* ì–¸ì–´ ê°ì§€/ì ìš© */
function detectLanguage(){
  const saved=localStorage.getItem('selectedLang');
  if(saved && ['ko','en','zh','zh-tw','th','id'].includes(saved)) currentLang=saved;
  else{
    const br=navigator.language.toLowerCase();
    if(br.includes('zh-tw')||br.includes('zh-hk')) currentLang='zh-tw';
    else{
      const two=br.slice(0,2); if(['ko','en','zh','th','id'].includes(two)) currentLang=two;
    }
  }
  document.documentElement.lang=currentLang;
  const sel=document.getElementById('langSelect'); if(sel) sel.value=currentLang;
}
function updateLanguage(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); if(translations[currentLang][k]) el.textContent=translations[currentLang][k]; });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{ const k=el.getAttribute('data-i18n-placeholder'); if(translations[currentLang][k]) el.placeholder=translations[currentLang][k]; });
}

/* ì´ë²¤íŠ¸ */
function setupEvents(){
  document.getElementById('langSelect').addEventListener('change',e=>{
    currentLang=e.target.value; localStorage.setItem('selectedLang',currentLang);
    document.documentElement.lang=currentLang; updateLanguage(); renderCoupons();
  });
  document.getElementById('searchInput').addEventListener('input',e=>{
    clearTimeout(searchTimer); searchTimer=setTimeout(()=>filterBySearch(e.target.value),120);
  });
  document.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); tab.classList.add('active');
      currentCategory=tab.dataset.category; filterByCategory(currentCategory);
    });
  });
  document.getElementById('modal').addEventListener('click',e=>{ if(e.target.id==='modal') closeModal(); });
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeModal(); });
}

/* D-Day(JST) */
function getDaysLeft(dateStr){
  if(!dateStr||dateStr==='9999-12-31') return 999;
  const end=new Date(`${dateStr}T23:59:59+09:00`);
  const now=new Date(); const jst= new Date(now.getTime() + (9*60 + now.getTimezoneOffset())*60000);
  const diff=end-jst; const d=Math.ceil(diff/86400000); return d>0?d:0;
}

/* ë Œë” */
function renderCoupons(){
  const grid=document.getElementById('couponGrid'); const empty=document.getElementById('noResults');
  if(filteredCoupons.length===0){ grid.style.display='none'; empty.classList.add('show'); return; }
  grid.style.display='grid'; empty.classList.remove('show');
  grid.innerHTML=filteredCoupons.map(c=>{
    const isSaved=savedCoupons.includes(c.id);
    const store=c[`store_${currentLang}`]||c.store_ko||c.store_en||'';
    const offer=c[`offer_${currentLang}`]||c.offer||c.offer_en||'';
    const desc=c[`description_${currentLang}`]||c.description_ko||c.description_en||'';
    const area=c[`area_${currentLang}`]||c.area_ko||c.area_en||'';
    const d=getDaysLeft(c.expiry);
    const badge=(d===999)?'':(d===0?translations[currentLang].expires_today:`${d} ${translations[currentLang].days_left}`);
    return `
    <div class="coupon-card" role="button" tabindex="0" onclick="showModal(${c.id})"
         onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();showModal(${c.id});}">
      ${badge?`<div class="expiry-badge">ğŸ”¥ ${esc(badge)}</div>`:''}
      <img src="${esc(c.image)}" alt="${esc(store)}" loading="lazy">
      <div class="coupon-body">
        <div class="coupon-title">${esc(store)}</div>
        <div class="coupon-offer">${esc(offer)}</div>
        <div class="coupon-desc">${esc(desc)}</div>
        <div class="coupon-footer">
          <span class="coupon-area">ğŸ“ ${esc(area)}</span>
          <button class="save-btn ${isSaved?'saved':''}" onclick="event.stopPropagation();toggleSave(${c.id})">
            ${isSaved?'â­':'â˜†'} ${translations[currentLang][isSaved?'unsave':'save']}
          </button>
        </div>
      </div>
    </div>`;
  }).join('');
  updateBadges();
}

/* í•„í„° */
function scoreCoupon(c,tokens){
  const f=(k)=>String(c[k]||'').toLowerCase();
  const store=(c[`store_${currentLang}`]||c.store_ko||c.store_en||'').toLowerCase();
  const area=(c[`area_${currentLang}`]||c.area_ko||c.area_en||'').toLowerCase();
  const desc=(c[`description_${currentLang}`]||c.description_ko||c.description_en||'').toLowerCase();
  let score=0;
  tokens.forEach(t=>{
    if(!t) return;
    if(store.includes(t)) score+=3;
    if(area.includes(t))  score+=2;
    if(desc.includes(t))  score+=1;
  });
  return score;
}
function filterBySearch(q){
  q=(q||'').toLowerCase().trim();
  const tokens=q.split(/\s+/).filter(Boolean);
  const match=(c)=> tokens.length===0 ? true : scoreCoupon(c,tokens)>0;
  if(currentCategory==='saved') filteredCoupons=couponsData.filter(c=>savedCoupons.includes(c.id)&&match(c));
  else if(currentCategory==='all') filteredCoupons=couponsData.filter(match);
  else filteredCoupons=couponsData.filter(c=>c.category===currentCategory&&match(c));
  filteredCoupons.sort((a,b)=>scoreCoupon(b,tokens)-scoreCoupon(a,tokens));
  renderCoupons();
}
function filterByCategory(cat){
  const q=document.getElementById('searchInput').value;
  if(cat==='all') filteredCoupons=[...couponsData];
  else if(cat==='saved') filteredCoupons=couponsData.filter(c=>savedCoupons.includes(c.id));
  else filteredCoupons=couponsData.filter(c=>c.category===cat);
  if(q) filterBySearch(q); else renderCoupons();
}

/* ì €ì¥ */
function toggleSave(id){
  if(savedCoupons.includes(id)) savedCoupons=savedCoupons.filter(x=>x!==id);
  else savedCoupons.push(id);
  localStorage.setItem('savedCoupons',JSON.stringify(savedCoupons));
  updateSavedInfo(); updateBadges(); renderCoupons();
}
function updateSavedInfo(){
  const info=document.getElementById('savedInfo'); const count=document.getElementById('savedCount'); const badge=document.getElementById('savedBadge');
  const n=savedCoupons.length; if(n>0){info.classList.add('show');count.textContent=n;badge.textContent=n;} else{info.classList.remove('show');badge.textContent='0';}
}
function updateBadges(){
  const counts={all:couponsData.length,electronics:couponsData.filter(c=>c.category==='electronics').length,fashion:couponsData.filter(c=>c.category==='fashion').length,dining:couponsData.filter(c=>c.category==='dining').length,transport:couponsData.filter(c=>c.category==='transport').length,saved:savedCoupons.length};
  Object.keys(counts).forEach(cat=>{const el=document.querySelector(`.tab[data-category="${cat}"] .badge`); if(el) el.textContent=counts[cat];});
}

/* ëª¨ë‹¬ (ë°±ë©´=ì´ë¯¸ì§€) */
function showModal(id){
  const c=couponsData.find(x=>x.id===id); if(!c) return;
  const m=document.getElementById('modal'); const body=document.getElementById('modalBody');
  const store=c[`store_${currentLang}`]||c.store_ko||c.store_en||''; const offer=c[`offer_${currentLang}`]||c.offer||c.offer_en||'';
  const area=c[`area_${currentLang}`]||c.area_ko||c.area_en||''; const d=getDaysLeft(c.expiry);
  const badge=(d===999)?getText('no_expiry'):(d===0?getText('expires_today'):`${d} ${getText('days_left')}`);
  const terms=(c[`terms_${currentLang}`]||c.terms_ko||c.terms_en||'').split('|').map(s=>s.trim()).filter(Boolean);

  body.innerHTML=`
    <div class="modal-title" id="modalTitle">${esc(store)}</div>
    <div class="modal-offer">${esc(offer)}</div>

    ${c.back_image?`
    <div class="backimg-wrap">
      <img class="backimg" src="${esc(c.back_image)}" alt="${esc(store)} coupon image">
      <div style="margin-top:10px;">
        <a class="btn btn-secondary" href="${esc(c.back_image)}" download>${getText('download')}</a>
      </div>
    </div>`:''}

    ${(c.article_url||c.official_url||c.maps_url)?`
    <div class="links-section">
      ${c.article_url?`<a class="link-item" href="${esc(c.article_url)}" target="_blank" rel="noopener">
        <span>ğŸ“° ${esc(getText('view_article'))}</span><span>â†’</span></a>`:''}
      ${c.official_url?`<a class="link-item" href="${esc(c.official_url)}" target="_blank" rel="noopener">
        <span>ğŸŒ ${esc(getText('visit_website'))}</span><span>â†’</span></a>`:''}
      ${c.maps_url?`<a class="link-item" href="${esc(c.maps_url)}" target="_blank" rel="noopener">
        <span>ğŸ“ ${esc(getText('view_map'))}</span><span>â†’</span></a>`:''}
    </div>`:''}

    ${terms.length?`<div class="modal-section">
      <h3>${esc(getText('terms'))}</h3>
      <ul>${terms.map(t=>`<li>${esc(t)}</li>`).join('')}</ul>
    </div>`:''}

    <div class="modal-section"><div>ğŸ“ ${esc(area)}</div>
    <div>ğŸ“… ${esc(getText('expiry'))}: ${esc(badge)}</div></div>

    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeModal()">${esc(getText('close'))}</button>
    </div>
  `;
  m.classList.add('show'); m.removeAttribute('aria-hidden'); document.body.style.overflow='hidden';
}
function closeModal(){ const m=document.getElementById('modal'); m.classList.remove('show'); m.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }

/* ë”¥ë§í¬ */
function applyDeepLink(){
  const p=new URLSearchParams(location.search); const lang=p.get('lang'); const id=parseInt(p.get('coupon'),10);
  if(lang && ['ko','en','zh','zh-tw','th','id'].includes(lang)){ currentLang=lang; localStorage.setItem('selectedLang',lang); document.documentElement.lang=lang; const sel=document.getElementById('langSelect'); if(sel) sel.value=lang; updateLanguage(); }
  if(id) showModal(id);
}
</script>
</body>
</html>
