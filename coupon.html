<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>Japankuru ã‚¯ãƒ¼ãƒãƒ³ã‚¦ã‚©ãƒ¬ãƒƒãƒˆ</title>

  <!-- ìµœì†Œ í•µì‹¬ ìŠ¤íƒ€ì¼ -->
  <style>
    :root {
      --primary:#2563eb;
      --bg:#f3f4f6;
      --card:#ffffff;
      --radius:.75rem;
      --shadow:0 4px 12px rgba(0,0,0,0.08);
      --text:#111827;
      --muted:#6b7280;
      --border:#d1d5db;
      --gray-100:#f3f4f6;
      --gray-700:#374151;
    }
    .dark-mode {
      --bg:#0f172a;
      --card:#1e293b;
      --text:#f1f5f9;
      --muted:#94a3b8;
      --border:#334155;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);line-height:1.4;min-height:100vh;padding-bottom:100px;transition:background .3s,color .3s;}
    .container{max-width:1000px;margin:0 auto;padding:0 1rem;}
    .header{display:flex;justify-content:space-between;align-items:center;padding:1rem 0;}
    .logo{font-weight:700;display:flex;align-items:center;gap:.5rem;font-size:1.25rem;color:var(--primary);}
    .btn{padding:.5rem 1rem;border:none;border-radius:.5rem;cursor:pointer;font-size:.9rem;display:inline-flex;align-items:center;gap:.25rem;transition:transform .2s;}
    .btn:hover{transform:scale(1.02);}
    .btn:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .btn-primary{background:var(--primary);color:#fff;}
    .search{margin:1rem 0;display:flex;gap:.5rem;flex-wrap:wrap;}
    .search input{flex:1;min-width:150px;padding:.75rem 1rem;border:1px solid var(--border);border-radius:.5rem;font-size:1rem;outline:none;background:var(--card);color:var(--text);transition:border-color .2s;}
    .search input:focus{border-color:var(--primary);}
    .filters{display:flex;gap:.5rem;overflow-x:auto;margin-bottom:1rem;-webkit-overflow-scrolling:touch;}
    .pill{padding:.5rem .75rem;border-radius:9999px;border:1px solid var(--border);background:var(--card);cursor:pointer;font-size:.75rem;display:flex;align-items:center;gap:4px;transition:all .2s;white-space:nowrap;}
    .pill:hover{transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,0,0,0.1);}
    .pill:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .pill.active{background:var(--primary);color:#fff;border-color:var(--primary);}
    .flex{display:flex;gap:1rem;flex-wrap:wrap;}
    .coupon-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;margin-top:0;}
    .card{background:var(--card);border-radius:var(--radius);overflow:visible;box-shadow:var(--shadow);position:relative;height:380px;font-size:.9rem;cursor:pointer;transition:transform .2s,box-shadow .2s;perspective:1000px;}
    .card:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,0.12);}
    .card:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .card.flipped .card-inner{transform:rotateY(180deg);}
    .card-inner{position:absolute;width:100%;height:100%;transform-style:preserve-3d;transition:transform .6s;}
    .card-face{position:absolute;width:100%;height:100%;-webkit-backface-visibility:hidden;backface-visibility:hidden;display:flex;flex-direction:column;border-radius:var(--radius);overflow:hidden;background:var(--card);}
    .card-front{background:var(--card);}
    .card-back{background:var(--card);transform:rotateY(180deg);padding:1.5rem;}
    .card img{width:100%;height:160px;object-fit:cover;display:block;}
    .card-body{padding:1rem;flex:1;display:flex;flex-direction:column;gap:.5rem;}
    .title{font-weight:700;font-size:1.1rem;margin-bottom:2px;}
    .offer{color:#dc2626;font-weight:700;margin:4px 0;}
    .desc{flex:1;color:var(--muted);font-size:.8rem;margin-bottom:4px;}
    .footer{display:flex;justify-content:space-between;font-size:.7rem;gap:.5rem;flex-wrap:wrap;}
    .badge{background:#f59e0b;color:#fff;padding:2px 6px;border-radius:4px;font-size:.6rem;display:inline-block;}
    .small{font-size:.65rem;color:var(--muted);}
    .save{position:absolute;top:8px;right:8px;background:#fff;border:none;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.2);transition:all .2s;z-index:20;pointer-events:all;font-size:1.25rem;-webkit-tap-highlight-color:transparent;}
    .save:hover{transform:scale(1.1);}
    .save:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .save.saved{background:#10b981;color:#fff;}
    .dark-mode .save{background:var(--card);color:var(--text);}
    .dark-mode .save.saved{background:#10b981;color:#fff;}
    .qr-section{text-align:center;margin-bottom:1rem;}
    .qr-code{font-size:3rem;margin:1rem 0;background:#f0f0f0;padding:1rem;border-radius:0.5rem;display:inline-block;}
    .coupon-code{font-size:1.5rem;font-weight:700;color:var(--primary);margin-top:.5rem;user-select:all;cursor:pointer;padding:.5rem;border-radius:.25rem;transition:background .2s;}
    .coupon-code:hover{background:var(--gray-100);}
    .dark-mode .coupon-code:hover{background:var(--gray-700);}
    .back-info{flex:1;}
    .info-item{margin-bottom:.75rem;font-size:.85rem;line-height:1.4;}
    .info-item strong{display:inline-block;min-width:80px;}
    .copy-btn{width:100%;padding:.75rem;background:var(--primary);color:#fff;border:none;border-radius:.5rem;font-size:1rem;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:.5rem;}
    .copy-btn:hover{background:#1d4ed8;}
    .copy-btn:focus{outline:2px solid var(--primary);outline-offset:2px;}
    #map{width:100%;height:260px;border-radius:12px;margin:1rem 0;overflow:hidden;position:relative;background:var(--card);border:1px solid var(--border);display:none;}
    #map.show{display:block;}
    #mapError{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:1000;}
    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 16px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.2);opacity:0;pointer-events:none;transition:all .3s;max-width:90vw;z-index:1000;}
    .toast.show{opacity:1;pointer-events:auto;}
    .dark-mode .toast{background:#fff;color:#111827;}

    /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card);
      display: flex;
      justify-content: space-around;
      padding: 0.5rem;
      border-top: 1px solid var(--border);
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
      z-index: 1000;
    }
    .dark-mode .bottom-nav {
      box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      color: var(--muted);
      text-decoration: none;
      cursor: pointer;
      padding: 4px 0;
      border-radius: 12px;
      transition: all 0.2s;
      flex: 1;
      text-align: center;
      position: relative;
    }

    .nav-icon-wrapper {
      position: relative;
      width: 24px;
      height: 24px;
      margin-bottom: 2px;
    }
    .nav-icon-wrapper svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transition: opacity 0.2s;
    }

    .nav-item .icon-filled {
      opacity: 0;
      color: var(--primary);
    }
    .nav-item .icon-outline {
      opacity: 1;
    }

    .nav-text {
      font-size: 0.7rem;
      font-weight: 500;
    }

    .nav-item.active .icon-filled {
      opacity: 1;
    }
    .nav-item.active .icon-outline {
      opacity: 0;
    }
    .nav-item.active .nav-text {
      color: var(--primary);
      font-weight: 600;
    }

    .nav-item.active {
      background-color: rgba(37, 99, 235, 0.1);
    }
    .dark-mode .nav-item.active {
      background-color: rgba(59, 130, 246, 0.15);
    }

    .nav-item:not(.active):hover {
      color: var(--primary);
    }

    .nearby-hint{margin-top:.5rem;font-size:.75rem;color:var(--muted);display:none;}
    .nearby-hint.show{display:block;}
    .location-error{background:#fee;color:#dc2626;padding:.75rem;border-radius:.5rem;margin:1rem 0;font-size:.8rem;display:none;}
    .location-error.show{display:block;}
    .location-error p{margin-top:.25rem;font-size:.75rem;color:#991b1b;}
    .flex-center{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;}
    .toggle-theme{background:none;border:none;cursor:pointer;font-size:1rem;padding:4px;transition:transform .2s;}
    .toggle-theme:hover{transform:scale(1.1);}
    .toggle-theme:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .retry-btn{background:#ef4444;color:#fff;padding:.25rem .5rem;border:none;border-radius:.25rem;cursor:pointer;font-size:.75rem;margin-top:.5rem;}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
    .close-detail-btn{background:none;border:none;color:var(--primary);font-size:.9rem;padding:.5rem;cursor:pointer;margin-bottom:.5rem;display:flex;align-items:center;gap:.25rem;transition:opacity .2s;}
    .close-detail-btn:hover{opacity:0.8;}
    .close-detail-btn:focus{outline:2px solid var(--primary);outline-offset:2px;}
    @media (max-width: 800px){
      .coupon-grid{grid-template-columns:1fr;}
    }

    /* íˆì–´ë¡œ ì„¹ì…˜ */
    .hero-section {
      text-align: center;
      padding: 2rem 1rem;
      background: linear-gradient(135deg, #4f46e5, #2563eb);
      color: #ffffff;
      margin-bottom: 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .hero-section h1 {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 0 0 0.5rem 0;
    }

    .hero-section p {
      font-size: 1rem;
      margin: 0 0 1rem 0;
      opacity: 0.9;
    }

    .hero-section .cta-button {
      background-color: #ffffff;
      color: var(--primary);
      font-size: 1rem;
      font-weight: 700;
      padding: 0.75rem 1.5rem;
      border-radius: 9999px;
      text-decoration: none;
      transition: all 0.2s ease-in-out;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: inline-block;
    }

    .hero-section .cta-button:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }

    /* ë‹¤êµ­ì–´ ì„ íƒê¸° */
    .lang-switcher {
      display: flex;
      background-color: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .lang-switcher button {
      background-color: transparent;
      border: none;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--muted);
      transition: all 0.2s ease-in-out;
      border-left: 1px solid var(--border);
    }

    .lang-switcher button:first-child {
      border-left: none;
    }

    .lang-switcher button:not(.active):hover {
      background-color: var(--bg);
      color: var(--text);
    }

    .lang-switcher button.active {
      background-color: var(--primary);
      color: #ffffff;
      font-weight: 600;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    /* ì¶”ì²œ ë§í’ì„  */
    .speech-bubble {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      margin-top: 0.5rem;
      font-size: 0.8rem;
      position: relative;
      color: var(--text);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
    }

    .speech-bubble::before {
      content: '';
      position: absolute;
      top: -10px;
      left: 20px;
      border-width: 0 10px 10px 10px;
      border-style: solid;
      border-color: transparent transparent #f9fafb transparent;
    }

    .hidden {
      display: none;
    }

    /* ë¡œë”© ìƒíƒœ */
    .loading {
      pointer-events: none;
    }

    .loading .coupon-grid::before {
      content: 'ë¡œë”© ì¤‘...';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.2rem;
      color: var(--muted);
    }

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 768px) {
      .hero-section h1 {
        font-size: 1.5rem;
      }

      .hero-section p {
        font-size: 0.9rem;
      }

      .header {
  position: sticky;
  top: 0;
  z-index: 1000;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
}

      
      .lang-switcher {
        order: 3;
        width: 100%;
        justify-content: center;
      }
      
      .lang-switcher button {
        flex-grow: 1;
      }
    }
.lang-toggle {
  position: relative;
}

#langBtn {
  background: none;
  border: none;
  font-size: 1.2rem;
  cursor: pointer;
  padding: 0.5rem;
}

.lang-menu {
  position: absolute;
  right: 0;
  top: calc(100% + 4px);
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  min-width: 120px;
  z-index: 999;
}

.lang-menu button {
  background: none;
  border: none;
  padding: 0.75rem 1rem;
  font-size: 0.9rem;
  text-align: left;
  cursor: pointer;
  color: var(--text);
  transition: background 0.2s;
}

.lang-menu button:hover {
  background: var(--gray-100);
}

.lang-menu.hidden {
  display: none;
}


  </style>
</head>
<body>
  <div class="container">
    <header class="header" aria-label="ãƒ˜ãƒƒãƒ€ãƒ¼">
      <div class="logo" aria-label="JK Wallet">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M22.46,6C21.69,6.18 21.06,6.65 20.64,7.25C20.18,5.53 18.54,4.24 16.64,4.24C15.07,4.24 13.71,5.19 13.12,6.56C12.61,6.34 12.06,6.22 11.5,6.22C9.84,6.22 8.5,7.56 8.5,9.22C8.5,9.64 8.58,10.04 8.73,10.41C7.73,10.41 6.9,11.24 6.9,12.24V19.76C6.9,20.76 7.73,21.59 8.73,21.59H20.27C21.27,21.59 22.1,20.76 22.1,19.76V12.24C22.1,11.24 21.27,10.41 20.27,10.41H20.02C20.46,9.74 20.73,8.96 20.73,8.11C20.73,7.25 20.44,6.46 19.96,5.82C21.31,6.04 22.46,6.79 22.46,6Z"/>
        </svg>
        JK Wallet
      </div>
      
      <!-- ë‹¤êµ­ì–´ ì„ íƒê¸° -->
      <!-- ê¸°ì¡´ lang-switcher ì œê±°í•˜ê³  -->
<div class="lang-toggle">
  <button id="langBtn" aria-label="è¨€èªåˆ‡æ›¿">ğŸŒ</button>
  <div id="langMenu" class="lang-menu hidden">
    <button data-lang="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
    <button data-lang="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</button>
    <button data-lang="en">ğŸ‡ºğŸ‡¸ English</button>
    <button data-lang="th">ğŸ‡¹ğŸ‡­ à¸ à¸²à¸©à¸²à¹„à¸—à¸¢</button>
  </div>
</div>


      <div class="flex-center">
        <button class="btn btn-primary" id="locateBtn" aria-label="ç¾åœ¨åœ°ã®è¿‘ãã‚’è¡¨ç¤º">è¿‘ãã‚’è¡¨ç¤º</button>
        <button class="toggle-theme" id="themeToggle" aria-label="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ“</button>
      </div>
    </header>
    
    <div class="search" aria-label="æ¤œç´¢ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼">
      <input type="search" id="searchInput" placeholder="åº—åãƒ»ã‚¨ãƒªã‚¢ã§æ¤œç´¢..." aria-label="ã‚¯ãƒ¼ãƒãƒ³æ¤œç´¢" />
    </div>

    <div class="filters" role="tablist" aria-label="ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼">
      <div class="pill active" data-filter="all" role="tab" aria-selected="true" tabindex="0">ã™ã¹ã¦</div>
      <div class="pill" data-filter="saved" role="tab" aria-selected="false" tabindex="0">ä¿å­˜æ¸ˆã¿</div>
      <div class="pill" data-filter="electronics" role="tab" aria-selected="false" tabindex="0">å®¶é›»</div>
      <div class="pill" data-filter="fashion" role="tab" aria-selected="false" tabindex="0">ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³</div>
      <div class="pill" data-filter="dining" role="tab" aria-selected="false" tabindex="0">ã‚°ãƒ«ãƒ¡</div>
      <div class="pill" data-filter="transport" role="tab" aria-selected="false" tabindex="0">äº¤é€š</div>
      <div class="pill" data-filter="nearby" role="tab" aria-selected="false" tabindex="0">è¿‘ã</div>
    </div>
  <section class="hero-section">
      <h1>æ—…ã®æ€ã„å‡ºã«ã€ãŠå¾—ãªç‰¹å…¸ã‚’ã€‚</h1>
      <p>æ—¥æœ¬æ—…è¡Œã‚’ã‚‚ã£ã¨æ¥½ã—ãã€ã‚‚ã£ã¨ãŠãƒˆã‚¯ã«ã€‚äººæ°—ã‚¹ãƒãƒƒãƒˆã‚„ã‚°ãƒ«ãƒ¡ãŒ"è¨ªæ—¥å¤–å›½äººé™å®š"ã§å‰²å¼•ã«ãªã‚Šã¾ã™ã€‚</p>
      <a href="#couponGrid" class="cta-button">ä»Šã™ãã‚¯ãƒ¼ãƒãƒ³ã‚’ãƒã‚§ãƒƒã‚¯</a>
    </section>
    <!-- ìœ„ì¹˜ ì—ëŸ¬ í‘œì‹œ -->
    <div class="location-error" id="locationError">
      <strong>ç¾åœ¨åœ°ã‚’ä½¿ç”¨ã§ãã¾ã›ã‚“</strong>
      <p>ä½ç½®æƒ…å ±ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <!-- ì§€ë„ -->
    <div id="map" aria-label="ã‚¯ãƒ¼ãƒãƒ³ãƒãƒƒãƒ—">
      <div id="mapError">
        <p>åœ°å›³ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</p>
        <button class="retry-btn" onclick="retryMap()">å†è©¦è¡Œ</button>
      </div>
    </div>
    <div class="nearby-hint" id="nearbyHint">ã€Œè¿‘ãã€ã‚’æŠ¼ã™ã¨ç¾åœ¨åœ°ã«åŸºã¥ã„ã¦ã‚½ãƒ¼ãƒˆã—ã¾ã™ã€‚</div>

    <!-- ì¿ í° ë¦¬ìŠ¤íŠ¸ -->
    <div class="coupon-grid" id="couponGrid" aria-label="åˆ©ç”¨å¯èƒ½ãªã‚¯ãƒ¼ãƒãƒ³"></div>
  </div>

  <!-- ìŠ¤í¬ë¦°ë¦¬ë” ì•Œë¦¼ ì˜ì—­ -->
  <div id="sr-announcement" aria-live="polite" aria-atomic="true" class="sr-only"></div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div class="toast" id="toast" role="alert" aria-live="assertive"></div>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="bottom-nav" aria-label="ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
    <a href="#" class="nav-item active" data-view="home" tabindex="0">
      <span class="nav-icon-wrapper">
        <svg class="icon-outline" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        <svg class="icon-filled" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 7.093v-3.093h-3v-2.093l-7-5.013-7 5.013v2.093h-3v3.093l3 2.143v11.764h14v-11.764l3-2.143zm-12 13.907v-8h4v8h-4z"></path></svg>
      </span>
      <span class="nav-text">ãƒ›ãƒ¼ãƒ </span>
    </a>
    <a href="#" class="nav-item" data-view="saved" tabindex="0">
      <span class="nav-icon-wrapper">
        <svg class="icon-outline" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"></path></svg>
        <svg class="icon-filled" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 24l-7-6-7 6v-24h14v24z"></path></svg>
      </span>
      <span class="nav-text">ä¿å­˜æ¸ˆã¿</span>
    </a>
    <a href="#" class="nav-item" data-view="map" tabindex="0">
      <span class="nav-icon-wrapper">
        <svg class="icon-outline" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>
        <svg class="icon-filled" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-4.198 0-8 3.403-8 7.602 0 4.198 3.469 9.21 8 16.398 4.531-7.188 8-12.2 8-16.398 0-4.199-3.801-7.602-8-7.602zm0 11c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3z"></path></svg>
      </span>
      <span class="nav-text">ãƒãƒƒãƒ—</span>
    </a>
    <a href="#" class="nav-item" data-view="settings" tabindex="0">
      <span class="nav-icon-wrapper">
        <svg class="icon-outline" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
        <svg class="icon-filled" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19.438 11.163l-2.438-1.408v-2.755h-3v-2h-4v2h-3v2.755l-2.438 1.408-.562.915 2.438 1.409v2.849l-2.438 1.409.562.915 2.438-1.408v2.755h3v2h4v-2h3v-2.755l2.438-1.408.562-.915-2.438-1.409v-2.849zm-7.438 2.837c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3z"></path></svg>
      </span>
      <span class="nav-text">è¨­å®š</span>
    </a>
  </nav>

  <script>
    // ===========================================
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    // ===========================================
    const Utils = {
      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      },
      
      throttle(func, limit) {
        let inThrottle;
        return function() {
          const args = arguments;
          const context = this;
          if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
          }
        };
      },
      
      distance(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) ** 2 + 
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                  Math.sin(dLng/2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      },
      
      formatDate(dateStr) {
        if (dateStr === '9999-12-31') return T[LanguageManager.currentLang].noExpiry || 'æœŸé™ãªã—';
        return dateStr.replace(/-/g, '/');
      }
    };

    // ===========================================
    // ë‹¤êµ­ì–´ í…ìŠ¤íŠ¸
    // ===========================================
    const T = {
      ja: {
        pageTitle: 'Japankuru ã‚¯ãƒ¼ãƒãƒ³ã‚¦ã‚©ãƒ¬ãƒƒãƒˆ',
        heroTitle: 'æ—…ã®æ€ã„å‡ºã«ã€ãŠå¾—ãªç‰¹å…¸ã‚’ã€‚',
        heroDesc: 'æ—¥æœ¬æ—…è¡Œã‚’ã‚‚ã£ã¨æ¥½ã—ãã€ã‚‚ã£ã¨ãŠãƒˆã‚¯ã«ã€‚äººæ°—ã‚¹ãƒãƒƒãƒˆã‚„ã‚°ãƒ«ãƒ¡ãŒ"è¨ªæ—¥å¤–å›½äººé™å®š"ã§å‰²å¼•ã«ãªã‚Šã¾ã™ã€‚',
        ctaButton: 'ä»Šã™ãã‚¯ãƒ¼ãƒãƒ³ã‚’ãƒã‚§ãƒƒã‚¯',
        searchPlaceholder: 'åº—åãƒ»ã‚¨ãƒªã‚¢ã§æ¤œç´¢...',
        all: 'ã™ã¹ã¦',
        saved: 'ä¿å­˜æ¸ˆã¿',
        electronics: 'å®¶é›»',
        fashion: 'ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³', 
        dining: 'ã‚°ãƒ«ãƒ¡',
        transport: 'äº¤é€š',
        nearby: 'è¿‘ã',
        home: 'ãƒ›ãƒ¼ãƒ ',
        map: 'ãƒãƒƒãƒ—',
        settings: 'è¨­å®š',
        languageChanged: 'è¨€èªã‚’å¤‰æ›´ã—ã¾ã—ãŸ',
        detailShow: 'è©³ç´°ã‚’è¡¨ç¤º',
        backToList: 'ãƒªã‚¹ãƒˆã«æˆ»ã‚‹',
        backButton: 'â† æˆ»ã‚‹',
        closeDetail: 'è©³ç´°ã‚’é–‰ã˜ã‚‹',
        copyCode: 'ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼',
        copied: 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ',
        codeCopied: 'ã‚¯ãƒ¼ãƒãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼',
        copyFailed: 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é•·æŠ¼ã—ã—ã¦æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚',
        saveCoupon: 'ã‚¯ãƒ¼ãƒãƒ³ã‚’ä¿å­˜',
        unsaveCoupon: 'ã‚¯ãƒ¼ãƒãƒ³ã®ä¿å­˜ã‚’è§£é™¤',
        savedCoupon: 'ä¿å­˜ã—ã¾ã—ãŸ',
        unsavedCoupon: 'ä¿å­˜ã‚’è§£é™¤ã—ã¾ã—ãŸ',
        locationError: 'ç¾åœ¨åœ°ã‚’ä½¿ç”¨ã§ãã¾ã›ã‚“',
        locationObtained: 'ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¾ã—ãŸ',
        locationDenied: 'ä½ç½®æƒ…å ±ã®å–å¾—ã‚’æ‹’å¦ã•ã‚Œã¾ã—ãŸ',
        mapView: 'åœ°å›³ã§è¦‹ã‚‹',
        mapShown: 'åœ°å›³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ',
        mapViewTab: 'ãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼',
        nearbySort: 'ç¾åœ¨åœ°ã«åŸºã¥ãä¸¦ã³æ›¿ãˆ',
        noExpiry: 'æœŸé™ãªã—',
        store: 'åº—èˆ—',
        benefit: 'ç‰¹å…¸',
        expiry: 'æœ‰åŠ¹æœŸé™',
        notFound: 'ã‚¯ãƒ¼ãƒãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ¤œç´¢æ¡ä»¶ã‚’å¤‰ãˆã¦ãã ã•ã„ã€‚',
        codeSelected: 'ã‚³ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¾ã—ãŸ',
        whyThisStore: 'ğŸ’¬ ãªãœã“ã®åº—ï¼Ÿ'
      },
      
      ko: {
        pageTitle: 'Japankuru ì¿ í° ì›”ë ›',
        heroTitle: 'ì—¬í–‰ì˜ ì¶”ì–µì— íŠ¹ë³„í•œ í˜œíƒì„.',
        heroDesc: 'ì¼ë³¸ ì—¬í–‰ì„ ë” ì¦ê²ê³  ì•Œì°¨ê²Œ. ì¸ê¸° ëª…ì†Œì™€ ë§›ì§‘ì´ "ë°©ì¼ì™¸êµ­ì¸ í•œì •"ìœ¼ë¡œ í• ì¸ë©ë‹ˆë‹¤.',
        ctaButton: 'ì§€ê¸ˆ ì¿ í° í™•ì¸í•˜ê¸°',
        searchPlaceholder: 'ë§¤ì¥ëª…ãƒ»ì§€ì—­ìœ¼ë¡œ ê²€ìƒ‰...',
        all: 'ì „ì²´',
        saved: 'ì €ì¥ë¨',
        electronics: 'ê°€ì „',
        fashion: 'íŒ¨ì…˜',
        dining: 'ë§›ì§‘',
        transport: 'êµí†µ',
        nearby: 'ê·¼ì²˜',
        home: 'í™ˆ',
        map: 'ì§€ë„',
        settings: 'ì„¤ì •',
        languageChanged: 'ì–¸ì–´ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤',
        detailShow: 'ìƒì„¸ ë³´ê¸°',
        backToList: 'ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°',
        backButton: 'â† ëŒì•„ê°€ê¸°',
        closeDetail: 'ìƒì„¸ ë‹«ê¸°',
        copyCode: 'ì½”ë“œ ë³µì‚¬',
        copied: 'ë³µì‚¬ë¨',
        codeCopied: 'ì¿ í° ì½”ë“œë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤!',
        copyFailed: 'ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê¸¸ê²Œ ëˆŒëŸ¬ì„œ ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.',
        saveCoupon: 'ì¿ í° ì €ì¥',
        unsaveCoupon: 'ì¿ í° ì €ì¥ í•´ì œ',
        savedCoupon: 'ì €ì¥í–ˆìŠµë‹ˆë‹¤',
        unsavedCoupon: 'ì €ì¥ì„ í•´ì œí–ˆìŠµë‹ˆë‹¤',
        locationError: 'í˜„ì¬ ìœ„ì¹˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
        locationObtained: 'í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤',
        locationDenied: 'ìœ„ì¹˜ ì •ë³´ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤',
        mapView: 'ì§€ë„ì—ì„œ ë³´ê¸°',
        mapShown: 'ì§€ë„ë¥¼ í‘œì‹œí–ˆìŠµë‹ˆë‹¤',
        mapViewTab: 'ì§€ë„ ë³´ê¸°',
        nearbySort: 'í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ ì •ë ¬',
        noExpiry: 'ê¸°í•œ ì—†ìŒ',
        store: 'ë§¤ì¥',
        benefit: 'í˜œíƒ',
        expiry: 'ìœ íš¨ê¸°í•œ',
        notFound: 'ì¿ í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²€ìƒ‰ ì¡°ê±´ì„ ë³€ê²½í•´ë³´ì„¸ìš”.',
        codeSelected: 'ì½”ë“œë¥¼ ì„ íƒí–ˆìŠµë‹ˆë‹¤',
        whyThisStore: 'ğŸ’¬ ì™œ ì´ ë§¤ì¥ì¼ê¹Œ?'
      },
      
      en: {
        pageTitle: 'Japankuru Coupon Wallet',
        heroTitle: 'Special Benefits for Your Journey.',
        heroDesc: 'Make your Japan trip more enjoyable and affordable. Popular spots and restaurants offer "Foreign Visitor Exclusive" discounts.',
        ctaButton: 'Check Coupons Now',
        searchPlaceholder: 'Search by store name or area...',
        all: 'All',
        saved: 'Saved',
        electronics: 'Electronics',
        fashion: 'Fashion',
        dining: 'Dining',
        transport: 'Transport', 
        nearby: 'Nearby',
        home: 'Home',
        map: 'Map',
        settings: 'Settings',
        languageChanged: 'Language changed',
        detailShow: 'Show Details',
        backToList: 'Back to List',
        backButton: 'â† Back',
        closeDetail: 'Close Details',
        copyCode: 'Copy Code',
        copied: 'Copied',
        codeCopied: 'Coupon code copied!',
        copyFailed: 'Copy failed. Please copy manually.',
        saveCoupon: 'Save Coupon',
        unsaveCoupon: 'Unsave Coupon',
        savedCoupon: 'Saved',
        unsavedCoupon: 'Unsaved',
        locationError: 'Cannot access location',
        locationObtained: 'Location obtained',
        locationDenied: 'Location access denied',
        mapView: 'View on Map',
        mapShown: 'Map displayed',
        mapViewTab: 'Map View',
        nearbySort: 'Sort by location',
        noExpiry: 'No Expiry',
        store: 'Store',
        benefit: 'Benefit',
        expiry: 'Expiry Date',
        notFound: 'No coupons found. Try changing your search criteria.',
        codeSelected: 'Code selected',
        whyThisStore: 'ğŸ’¬ Why this store?'
      },

      th: {
        pageTitle: 'Japankuru Coupon Wallet',
        heroTitle: 'à¸ªà¸´à¸—à¸˜à¸´à¸à¸´à¹€à¸¨à¸©à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¹€à¸”à¸´à¸™à¸—à¸²à¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“',
        heroDesc: 'à¸—à¸³à¹ƒà¸«à¹‰à¸à¸²à¸£à¹€à¸”à¸´à¸™à¸—à¸²à¸‡à¸à¸µà¹ˆà¸›à¸¸à¹ˆà¸™à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸ªà¸™à¸¸à¸à¹à¸¥à¸°à¸„à¸¸à¹‰à¸¡à¸„à¹ˆà¸²à¸¡à¸²à¸à¸‚à¸¶à¹‰à¸™ à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸¢à¸­à¸”à¸™à¸´à¸¢à¸¡à¹à¸¥à¸°à¸£à¹‰à¸²à¸™à¸­à¸²à¸«à¸²à¸£à¸¡à¸µà¸ªà¹ˆà¸§à¸™à¸¥à¸” "à¹€à¸‰à¸à¸²à¸°à¸™à¸±à¸à¸—à¹ˆà¸­à¸‡à¹€à¸—à¸µà¹ˆà¸¢à¸§à¸•à¹ˆà¸²à¸‡à¸Šà¸²à¸•à¸´"',
        ctaButton: 'à¸”à¸¹à¸„à¸¹à¸›à¸­à¸‡à¹€à¸¥à¸¢',
        searchPlaceholder: 'à¸„à¹‰à¸™à¸«à¸²à¸•à¸²à¸¡à¸Šà¸·à¹ˆà¸­à¸£à¹‰à¸²à¸™à¸«à¸£à¸·à¸­à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆ...',
        all: 'à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”',
        saved: 'à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¹‰à¸§', 
        electronics: 'à¸­à¸´à¹€à¸¥à¹‡à¸à¸—à¸£à¸­à¸™à¸´à¸à¸ªà¹Œ',
        fashion: 'à¹à¸Ÿà¸Šà¸±à¹ˆà¸™',
        dining: 'à¸­à¸²à¸«à¸²à¸£',
        transport: 'à¸à¸²à¸£à¹€à¸”à¸´à¸™à¸—à¸²à¸‡',
        nearby: 'à¹ƒà¸à¸¥à¹‰à¹€à¸„à¸µà¸¢à¸‡',
        home: 'à¸«à¸™à¹‰à¸²à¹à¸£à¸',
        map: 'à¹à¸œà¸™à¸—à¸µà¹ˆ',
        settings: 'à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²',
        languageChanged: 'à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ à¸²à¸©à¸²à¹à¸¥à¹‰à¸§',
        detailShow: 'à¹à¸ªà¸”à¸‡à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”',
        backToList: 'à¸à¸¥à¸±à¸šà¹„à¸›à¸—à¸µà¹ˆà¸£à¸²à¸¢à¸à¸²à¸£',
        backButton: 'â† à¸à¸¥à¸±à¸š',
        closeDetail: 'à¸›à¸´à¸”à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”',
        copyCode: 'à¸„à¸±à¸”à¸¥à¸­à¸à¹‚à¸„à¹‰à¸”',
        copied: 'à¸„à¸±à¸”à¸¥à¸­à¸à¹à¸¥à¹‰à¸§',
        codeCopied: 'à¸ªà¸³à¹€à¸™à¸²à¹‚à¸„à¹‰à¸”à¸„à¸¹à¸›à¸­à¸‡à¹à¸¥à¹‰à¸§!',
        copyFailed: 'à¸à¸²à¸£à¸„à¸±à¸”à¸¥à¸­à¸à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§ à¸à¸£à¸¸à¸“à¸²à¸„à¸±à¸”à¸¥à¸­à¸à¸”à¹‰à¸§à¸¢à¸•à¸™à¹€à¸­à¸‡',
        saveCoupon: 'à¸šà¸±à¸™à¸—à¸¶à¸à¸„à¸¹à¸›à¸­à¸‡',
        unsaveCoupon: 'à¸¢à¸à¹€à¸¥à¸´à¸à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸',
        savedCoupon: 'à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¹‰à¸§',
        unsavedCoupon: 'à¸¢à¸à¹€à¸¥à¸´à¸à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¹‰à¸§',
        locationError: 'à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¹„à¸”à¹‰',
        locationObtained: 'à¹„à¸”à¹‰à¸£à¸±à¸šà¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¹à¸¥à¹‰à¸§',
        locationDenied: 'à¸à¸²à¸£à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸–à¸¹à¸à¸›à¸à¸´à¹€à¸ªà¸˜',
        mapView: 'à¸”à¸¹à¸šà¸™à¹à¸œà¸™à¸—à¸µà¹ˆ',
        mapShown: 'à¹à¸ªà¸”à¸‡à¹à¸œà¸™à¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§',
        mapViewTab: 'à¸¡à¸¸à¸¡à¸¡à¸­à¸‡à¹à¸œà¸™à¸—à¸µà¹ˆ',
        nearbySort: 'à¸ˆà¸±à¸”à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡',
        noExpiry: 'à¹„à¸¡à¹ˆà¸¡à¸µà¸§à¸±à¸™à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸',
        store: 'à¸£à¹‰à¸²à¸™',
        benefit: 'à¸œà¸¥à¸›à¸£à¸°à¹‚à¸¢à¸Šà¸™à¹Œ',
        expiry: 'à¸§à¸±à¸™à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸',
        notFound: 'à¹„à¸¡à¹ˆà¸à¸šà¸„à¸¹à¸›à¸­à¸‡ à¸¥à¸­à¸‡à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸à¸“à¸‘à¹Œà¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸²',
        codeSelected: 'à¹€à¸¥à¸·à¸­à¸à¹‚à¸„à¹‰à¸”à¹à¸¥à¹‰à¸§',
        whyThisStore: 'ğŸ’¬ à¸—à¸³à¹„à¸¡à¸£à¹‰à¸²à¸™à¸™à¸µà¹‰?'
      }
    };

    // ===========================================
    // ì–¸ì–´ ê´€ë¦¬ì
    // ===========================================
    const LanguageManager = {
      currentLang: 'ja',
      supportedLangs: ['ja', 'ko', 'en', 'th'],
      
      init() {
        this.currentLang = this.detectLanguage();
        this.setupLanguageSwitcher();
        this.updatePageLanguage();
      },

      detectLanguage() {
        // 1. URL íŒŒë¼ë¯¸í„° í™•ì¸
        const urlParams = new URLSearchParams(window.location.search);
        const urlLang = urlParams.get('lang');
        if (urlLang && this.supportedLangs.includes(urlLang)) {
          return urlLang;
        }

        // 2. localStorage í™•ì¸
        const savedLang = localStorage.getItem('preferredLang');
        if (savedLang && this.supportedLangs.includes(savedLang)) {
          return savedLang;
        }

        // 3. ë¸Œë¼ìš°ì € ì–¸ì–´ í™•ì¸
        const browserLang = navigator.language.slice(0, 2);
        if (this.supportedLangs.includes(browserLang)) {
          return browserLang;
        }

        return 'ja';
      },

      setLanguage(lang) {
        if (!this.supportedLangs.includes(lang)) return;
        
        this.currentLang = lang;
        localStorage.setItem('preferredLang', lang);
        
        // URL ì—…ë°ì´íŠ¸
        const url = new URL(window.location);
        url.searchParams.set('lang', lang);
        window.history.replaceState({}, '', url);
        
        this.updatePageLanguage();
        
        // ì¿ í° ë¦¬ìŠ¤íŠ¸ ì¬ë Œë”ë§
        if (window.app) {
          window.app.render();
        }
        
        Toast.show(T[lang].languageChanged || `ì–¸ì–´ê°€ ${lang}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`);
      },

      setupLanguageSwitcher() {
        document.querySelectorAll('.lang-switcher button').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const lang = btn.dataset.lang;
            
            if (lang !== this.currentLang) {
              // UI ì—…ë°ì´íŠ¸
              document.querySelectorAll('.lang-switcher button')
                .forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              
              // ì–¸ì–´ ë³€ê²½
              this.setLanguage(lang);
            }
          });
        });

        // ì´ˆê¸° í™œì„± ë²„íŠ¼ ì„¤ì •
        const activeBtn = document.querySelector(`[data-lang="${this.currentLang}"]`);
        if (activeBtn) {
          document.querySelectorAll('.lang-switcher button')
            .forEach(b => b.classList.remove('active'));
          activeBtn.classList.add('active');
        }
      },

      updatePageLanguage() {
        // HTML lang ì†ì„± ì—…ë°ì´íŠ¸
        document.documentElement.lang = this.currentLang;
        
        // í˜ì´ì§€ ì œëª©
        document.title = T[this.currentLang].pageTitle || 'Japankuru ã‚¯ãƒ¼ãƒãƒ³ã‚¦ã‚©ãƒ¬ãƒƒãƒˆ';
        
        // ë„¤ë¹„ê²Œì´ì…˜ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        this.updateNavigation();
        
        // í•„í„° í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸  
        this.updateFilters();
        
        // ê¸°íƒ€ UI í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        this.updateStaticTexts();
      },

      updateNavigation() {
        const navTexts = document.querySelectorAll('.nav-text');
        const navLabels = [
          T[this.currentLang].home || 'ãƒ›ãƒ¼ãƒ ',
          T[this.currentLang].saved || 'ä¿å­˜æ¸ˆã¿', 
          T[this.currentLang].map || 'ãƒãƒƒãƒ—',
          T[this.currentLang].settings || 'è¨­å®š'
        ];
        
        navTexts.forEach((text, index) => {
          if (navLabels[index]) {
            text.textContent = navLabels[index];
          }
        });
      },

      updateFilters() {
        const filters = [
          { selector: '[data-filter="all"]', key: 'all' },
          { selector: '[data-filter="saved"]', key: 'saved' },
          { selector: '[data-filter="electronics"]', key: 'electronics' },
          { selector: '[data-filter="fashion"]', key: 'fashion' },
          { selector: '[data-filter="dining"]', key: 'dining' },
          { selector: '[data-filter="transport"]', key: 'transport' },
          { selector: '[data-filter="nearby"]', key: 'nearby' }
        ];

        filters.forEach(({ selector, key }) => {
          const element = document.querySelector(selector);
          if (element && T[this.currentLang][key]) {
            element.textContent = T[this.currentLang][key];
          }
        });
      },

      updateStaticTexts() {
        // ê²€ìƒ‰ placeholder
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
          searchInput.placeholder = T[this.currentLang].searchPlaceholder || 'åº—åãƒ»ã‚¨ãƒªã‚¢ã§æ¤œç´¢...';
        }

        // íˆì–´ë¡œ ì„¹ì…˜
        const heroTitle = document.querySelector('.hero-section h1');
        const heroDesc = document.querySelector('.hero-section p');
        const ctaBtn = document.querySelector('.cta-button');
        
        if (heroTitle) heroTitle.textContent = T[this.currentLang].heroTitle;
        if (heroDesc) heroDesc.textContent = T[this.currentLang].heroDesc;
        if (ctaBtn) ctaBtn.textContent = T[this.currentLang].ctaButton;
      }
    };

    // ì¿ í° í•„ë“œ ë‹¤êµ­ì–´ í—¬í¼ í•¨ìˆ˜
    function getCouponField(coupon, field, fallback = '') {
      const langField = `${field}_${LanguageManager.currentLang}`;
      const jaField = `${field}_ja`;
      
      return coupon[langField] || coupon[jaField] || coupon[field] || fallback;
    }

    // ===========================================
    // ì¿ í° ë°ì´í„° ë¡œë”
    // ===========================================
    class CouponLoader {
      constructor(config = {}) {
        this.config = {
          retryAttempts: 3,
          retryDelay: 1000,
          timeout: 10000,
          ...config
        };
      }

      async loadFromAPI() {
        try {
          // WordPress API ì—”ë“œí¬ì¸íŠ¸ ê²°ì •
          let apiUrl;
          
          if (window.wpApiSettings && window.wpApiSettings.root) {
            apiUrl = `${window.wpApiSettings.root}jkwallet/v1/coupons`;
          } else if (window.location.pathname.includes('/wp-admin/') || 
                     window.location.pathname.includes('/wp-content/')) {
            const baseUrl = window.location.origin;
            apiUrl = `${baseUrl}/wp-json/jkwallet/v1/coupons`;
          } else {
            apiUrl = './wp-json/jkwallet/v1/coupons';
          }

          console.log('API ìš”ì²­:', apiUrl);
          
          const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              ...(window.wpApiSettings?.nonce && {
                'X-WP-Nonce': window.wpApiSettings.nonce
              })
            }
          });

          if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          
          if (!Array.isArray(data) || data.length === 0) {
            throw new Error('Invalid API response format');
          }

          this.cacheData(data);
          console.log(`âœ… APIì—ì„œ ${data.length}ê°œ ì¿ í° ë¡œë“œ ì„±ê³µ`);
          
          return data;

        } catch (error) {
          console.warn('ğŸ”„ API ë¡œë“œ ì‹¤íŒ¨, ìºì‹œ/í´ë°± ë°ì´í„° ì‹œë„:', error.message);
          
          const cached = this.getCachedData();
          if (cached) {
            console.log('ğŸ“¦ ìºì‹œëœ ë°ì´í„° ì‚¬ìš©');
            return cached;
          }
          
          console.log('âš ï¸  í•˜ë“œì½”ë”© ë°ì´í„° ì‚¬ìš©');
          return this.getFallbackData();
        }
      }

      getCachedData() {
        try {
          const cached = localStorage.getItem('cachedCoupons');
          const cacheTime = localStorage.getItem('cacheTime');
          
          if (cached && cacheTime) {
            const age = Date.now() - parseInt(cacheTime);
            const maxAge = 24 * 60 * 60 * 1000; // 24ì‹œê°„
            
            if (age < maxAge) {
              return JSON.parse(cached);
            } else {
              localStorage.removeItem('cachedCoupons');
              localStorage.removeItem('cacheTime');
            }
          }
        } catch (e) {
          console.error('ìºì‹œ ë¡œë“œ ì‹¤íŒ¨:', e);
        }
        return null;
      }

      cacheData(data) {
        try {
          localStorage.setItem('cachedCoupons', JSON.stringify(data));
          localStorage.setItem('cacheTime', Date.now().toString());
          console.log('ğŸ’¿ ë°ì´í„° ìºì‹œ ì €ì¥ ì™„ë£Œ');
        } catch (e) {
          console.warn('ìºì‹œ ì €ì¥ ì‹¤íŒ¨:', e);
        }
      }

      getFallbackData() {
        return [
          { 
            id: 1, 
            store_ja: 'ã‚³ã‚¸ãƒ x ãƒ“ãƒƒã‚¯ã‚«ãƒ¡ãƒ©', 
            store_ko: 'ì½”ì§€ë§ˆ x ë¹…ì¹´ë©”ë¼',
            store_en: 'Kojima x BicCamera',
            store_th: 'à¹‚à¸„à¸ˆà¸´à¸¡à¸° x à¸šà¸´à¸à¸„à¸²à¹€à¸¡à¸£à¹ˆà¸²',
            offer_ja: 'æœ€å¤§ 17% OFF', 
            offer_ko: 'ìµœëŒ€ 17% í• ì¸',
            offer_en: 'Up to 17% OFF',
            offer_th: 'à¸¥à¸”à¸ªà¸¹à¸‡à¸ªà¸¸à¸” 17%',
            description_ja: 'å…ç¨10% + è¿½åŠ 7%å‰²å¼•ï¼æœ€æ–°ã®é›»å­è£½å“ã‚’å®‰ãã€‚',
            description_ko: 'ë©´ì„¸ 10% + ì¶”ê°€ 7% í• ì¸! ìµœì‹  ì „ìì œí’ˆì„ ì €ë ´í•˜ê²Œ.',
            description_en: 'Tax-free 10% + Additional 7% discount! Latest electronics at great prices.',
            description_th: 'à¸›à¸¥à¸­à¸”à¸ à¸²à¸©à¸µ 10% + à¸ªà¹ˆà¸§à¸™à¸¥à¸”à¹€à¸à¸´à¹ˆà¸¡ 7%! à¸­à¸´à¹€à¸¥à¹‡à¸à¸—à¸£à¸­à¸™à¸´à¸à¸ªà¹Œà¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¹ƒà¸™à¸£à¸²à¸„à¸²à¸”à¸µ',
            category: 'electronics', 
            expiry: '2025-12-31', 
            image: 'https://japankuru.com/gld-kanri/data/uploads/2023/11/kojima%E8%8B%B1%E8%AA%9E%E7%89%88%E4%BC%81%E6%A5%AD%E6%9C%89_kojima_EN_B-2.jpg',
            code: 'JK-BIC2025', 
            lat: 35.6909, 
            lng: 139.7003, 
            rating: 4.2 
          },
          { 
            id: 2, 
            store_ja: 'JINS', 
            store_ko: 'ì§„ìŠ¤',
            store_en: 'JINS',
            store_th: 'à¸ˆà¸´à¸™à¸ªà¹Œ',
            offer_ja: '10% OFF', 
            offer_ko: '10% í• ì¸',
            offer_en: '10% OFF',
            offer_th: 'à¸¥à¸” 10%',
            description_ja: 'å…ç¨+å‰²å¼•ã®ãƒ¡ã‚¬ãƒã€‚',
            description_ko: 'ë©´ì„¸+í• ì¸ ì•ˆê²½.',
            description_en: 'Tax-free + discount glasses.',
            description_th: 'à¹à¸§à¹ˆà¸™à¸•à¸²à¸›à¸¥à¸­à¸”à¸ à¸²à¸©à¸µ+à¸¥à¸”à¸£à¸²à¸„à¸²',
            category: 'fashion', 
            expiry: '2025-07-30', 
            image: 'https://japankuru.com/gld-kanri/data/uploads/2024/06/japankuru_1800-1200-1536x1024.jpg',
            code: 'JK-JINS2025', 
            lat: 35.6581, 
            lng: 139.6986, 
            rating: 4.1 
          },
          { 
            id: 3, 
            store_ja: 'BEAMS JAPAN', 
            store_ko: 'BEAMS JAPAN',
            store_en: 'BEAMS JAPAN',
            store_th: 'à¸šà¸µà¸¡à¸ªà¹Œ à¸à¸µà¹ˆà¸›à¸¸à¹ˆà¸™',
            offer_ja: '5% è¿½åŠ å‰²å¼•', 
            offer_ko: '5% ì¶”ê°€ í• ì¸',
            offer_en: '5% Additional Discount',
            offer_th: 'à¸ªà¹ˆà¸§à¸™à¸¥à¸”à¹€à¸à¸´à¹ˆà¸¡ 5%',
            description_ja: 'ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ç™ºä¿¡ã™ã‚‹ã‚»ãƒ¬ã‚¯ãƒˆã‚·ãƒ§ãƒƒãƒ—ã€‚',
            description_ko: 'íŠ¸ë Œë“œë¥¼ ì„ ë„í•˜ëŠ” ì…€ë ‰íŠ¸ìƒµ.',
            description_en: 'Trend-setting select shop.',
            description_th: 'à¸£à¹‰à¸²à¸™à¹€à¸‹à¹€à¸¥à¸à¸•à¹Œà¸—à¸µà¹ˆà¸™à¸³à¹€à¸—à¸£à¸™à¸”à¹Œ',
            category: 'fashion', 
            expiry: '2025-09-30', 
            image: 'https://img.japankuru.com/prg_img/img/img2024011517461371466800.jpg',
            code: 'JK-BEAMS25', 
            lat: 35.6702, 
            lng: 139.7073, 
            rating: 4.3 
          },
          { 
            id: 4, 
            store_ja: 'ã‚µãƒ ãƒ©ã‚¤ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³', 
            store_ko: 'ì‚¬ë¬´ë¼ì´ ë ˆìŠ¤í† ë‘',
            store_en: 'Samurai Restaurant',
            store_th: 'à¸£à¹‰à¸²à¸™à¸­à¸²à¸«à¸²à¸£à¸‹à¸²à¸¡à¸¹à¹„à¸£',
            offer_ja: 'ãƒ‰ãƒªãƒ³ã‚¯1æ¯ç„¡æ–™', 
            offer_ko: 'ìŒë£Œ 1ì” ë¬´ë£Œ',
            offer_en: '1 Free Drink',
            offer_th: 'à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸”à¸·à¹ˆà¸¡à¸Ÿà¸£à¸µ 1 à¹à¸à¹‰à¸§',
            description_ja: 'è¯éº—ãªã‚·ãƒ§ãƒ¼ã¨é£Ÿäº‹ã€‚',
            description_ko: 'í™”ë ¤í•œ ì‡¼ì™€ ì‹ì‚¬.',
            description_en: 'Spectacular show and dining.',
            description_th: 'à¸à¸²à¸£à¹à¸ªà¸”à¸‡à¸­à¸¥à¸±à¸‡à¸à¸²à¸£à¹à¸¥à¸°à¸­à¸²à¸«à¸²à¸£',
            recommendation_ja: 'Japankuruãƒ¬ãƒ“ãƒ¥ãƒ¼4.5ç‚¹ã€æ—…è¡Œè€…ã«ã€Œä¸€åº¦ã¯ä½“é¨“ã™ã¹ãã€ã¨äººæ°—æ€¥ä¸Šæ˜‡ï¼',
            recommendation_ko: 'Japankuru ë¦¬ë·° 4.5ì , ì—¬í–‰ìë“¤ì—ê²Œ "í•œ ë²ˆì€ ê²½í—˜í•´ë´ì•¼ í• " ê³³ìœ¼ë¡œ ì¸ê¸° ê¸‰ìƒìŠ¹!',
            recommendation_en: 'Japankuru review 4.5 stars, rapidly gaining popularity among travelers as a "must-experience" destination!',
            recommendation_th: 'Japankuru à¸£à¸µà¸§à¸´à¸§ 4.5 à¸”à¸²à¸§ à¹„à¸”à¹‰à¸£à¸±à¸šà¸„à¸§à¸²à¸¡à¸™à¸´à¸¢à¸¡à¸­à¸¢à¹ˆà¸²à¸‡à¸£à¸§à¸”à¹€à¸£à¹‡à¸§à¸ˆà¸²à¸à¸™à¸±à¸à¸—à¹ˆà¸­à¸‡à¹€à¸—à¸µà¹ˆà¸¢à¸§à¹ƒà¸™à¸à¸²à¸™à¸°à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ "à¸•à¹‰à¸­à¸‡à¸¥à¸­à¸‡"!',
            category: 'dining', 
            expiry: '2026-03-31', 
            image: 'https://japankuru.com/gld-kanri/data/uploads/2024/06/%E4%BE%8D%E3%82%AF%E3%83%BC%E3%83%9D%E3%83%B3c-2_0_0-1536x864.jpeg',
            code: 'JK-SAMURAI', 
            lat: 35.6947, 
            lng: 139.7006, 
            rating: 4.5 
          },
          { 
            id: 5, 
            store_ja: 'æ±æ€¥ç·š', 
            store_ko: 'ë„íì„ ',
            store_en: 'Tokyu Line',
            store_th: 'à¹‚à¸•à¹€à¸à¹‡à¸¢à¸§ à¹„à¸¥à¸™à¹Œ',
            offer_ja: '1æ—¥ä¹—è»Šåˆ¸', 
            offer_ko: '1ì¼ ìŠ¹ì°¨ê¶Œ',
            offer_en: '1-Day Pass',
            offer_th: 'à¸šà¸±à¸•à¸£à¹‚à¸”à¸¢à¸ªà¸²à¸£ 1 à¸§à¸±à¸™',
            description_ja: 'æ±äº¬æ—…è¡Œã®å¿…é ˆã‚¢ã‚¤ãƒ†ãƒ ã€‚',
            description_ko: 'ë„ì¿„ ì—¬í–‰ì˜ í•„ìˆ˜ ì•„ì´í…œ.',
            description_en: 'Essential item for Tokyo travel.',
            description_th: 'à¸ªà¸´à¹ˆà¸‡à¸ˆà¸³à¹€à¸›à¹‡à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¹€à¸”à¸´à¸™à¸—à¸²à¸‡à¹‚à¸•à¹€à¸à¸µà¸¢à¸§',
            category: 'transport', 
            expiry: '9999-12-31', 
            image: 'https://japankuru.com/gld-kanri/data/uploads/2025/03/tokyu-cover-16-9-1-1536x864.png',
            code: 'JK-TOKYU', 
            lat: 35.6580, 
            lng: 139.7016, 
            rating: 4.0 
          },
          { 
            id: 6, 
            store_ja: 'ãƒ¨ãƒ‰ãƒã‚·ã‚«ãƒ¡ãƒ©', 
            store_ko: 'ìš”ë„ë°”ì‹œì¹´ë©”ë¼',
            store_en: 'Yodobashi Camera',
            store_th: 'à¹‚à¸¢à¹‚à¸”à¸šà¸²à¸Šà¸´à¸„à¸²à¹€à¸¡à¸£à¹ˆà¸²',
            offer_ja: 'æœ€å¤§ 15% OFF', 
            offer_ko: 'ìµœëŒ€ 15% í• ì¸',
            offer_en: 'Up to 15% OFF',
            offer_th: 'à¸¥à¸”à¸ªà¸¹à¸‡à¸ªà¸¸à¸” 15%',
            description_ja: 'å…ç¨10% + VISAã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆã§5%è¿½åŠ å‰²å¼•ï¼',
            description_ko: 'ë©´ì„¸ 10% + VISA ì¹´ë“œ ê²°ì œ ì‹œ 5% ì¶”ê°€ í• ì¸!',
            description_en: 'Tax-free 10% + Additional 5% discount with VISA card payment!',
            description_th: 'à¸›à¸¥à¸­à¸”à¸ à¸²à¸©à¸µ 10% + à¸ªà¹ˆà¸§à¸™à¸¥à¸”à¹€à¸à¸´à¹ˆà¸¡ 5% à¹€à¸¡à¸·à¹ˆà¸­à¸Šà¸³à¸£à¸°à¸”à¹‰à¸§à¸¢à¸šà¸±à¸•à¸£ VISA!',
            category: 'electronics', 
            expiry: '2025-11-30', 
            image: 'https://img.japankuru.com/prg_img/thumbnail1/img2023112417190332724100.png',
            code: 'JK-Yodobashi', 
            lat: 35.6938, 
            lng: 139.7706, 
            rating: 4.4 
          }
        ];
      }
    }

    // ===========================================
    // í† ìŠ¤íŠ¸ ê´€ë¦¬ì
    // ===========================================
    const Toast = {
      el: document.getElementById('toast'),
      show(msg, duration = 2000) {
        this.el.textContent = msg;
        this.el.classList.add('show');
        setTimeout(() => this.el.classList.remove('show'), duration);
      }
    };

    // ===========================================
    // ì €ì¥ì†Œ ê´€ë¦¬ì
    // ===========================================
    const StorageManager = {
      getSaved() {
        try {
          const saved = localStorage.getItem('savedCoupons');
          return saved ? JSON.parse(saved) : [];
        } catch (e) {
          console.error('ì €ì¥ëœ ì¿ í° ë¡œë“œ ì‹¤íŒ¨:', e);
          return [];
        }
      },
      
      setSaved(data) {
        try {
          localStorage.setItem('savedCoupons', JSON.stringify(data));
        } catch (e) {
          console.error('ì¿ í° ì €ì¥ ì‹¤íŒ¨:', e);
          Toast.show(T[LanguageManager.currentLang].copyFailed || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 3000);
        }
      },
      
      getTheme() {
        return localStorage.getItem('darkMode') === 'true';
      },
      
      setTheme(isDark) {
        localStorage.setItem('darkMode', isDark.toString());
      }
    };

    // ===========================================
    // ìœ„ì¹˜ ê´€ë¦¬ì
    // ===========================================
    const Location = {
      async request() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            Toast.show('ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 2000);
            reject(new Error('Geolocation not supported'));
            return;
          }
          
          navigator.geolocation.getCurrentPosition(
            pos => {
              const location = { 
                lat: pos.coords.latitude, 
                lng: pos.coords.longitude 
              };
              Toast.show(T[LanguageManager.currentLang].locationObtained || 'ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¾ã—ãŸ', 1000);
              resolve(location);
            },
            err => {
              Toast.show(T[LanguageManager.currentLang].locationDenied || 'ä½ç½®æƒ…å ±ã®å–å¾—ã‚’æ‹’å¦ã•ã‚Œã¾ã—ãŸ', 2000);
              reject(err);
            },
            { enableHighAccuracy: true, timeout: 10000 }
          );
        });
      },
      
      showError() {
        const errorEl = document.getElementById('locationError');
        if (errorEl) {
          const lang = LanguageManager.currentLang;
          errorEl.innerHTML = `
            <strong>${T[lang].locationError || 'ç¾åœ¨åœ°ã‚’ä½¿ç”¨ã§ãã¾ã›ã‚“'}</strong>
            <p>ä½ç½®æƒ…å ±ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚</p>
          `;
          errorEl.classList.add('show');
        }
      },
      
      hideError() {
        const errorEl = document.getElementById('locationError');
        if (errorEl) {
          errorEl.classList.remove('show');
        }
      }
    };

    // ===========================================
    // ì§€ë„ ê´€ë¦¬ì
    // ===========================================
    const MapManager = {
      mapInstance: null,
      markerGroup: null, 
      leafletLoaded: false,
      initialized: false,
      initPromise: null,
      
      showMap() {
        const mapEl = document.getElementById('map');
        if (mapEl) {
          mapEl.classList.add('show');
        }
      },
      
      hideMap() {
        const mapEl = document.getElementById('map');
        if (mapEl) {
          mapEl.classList.remove('show');
        }
      },
      
      async init() {
        if (this.initPromise) {
          return this.initPromise;
        }
        
        if (this.initialized) {
          this.showMap();
          return Promise.resolve();
        }
        
        this.initPromise = this._doInit();
        return this.initPromise;
      },
      
      async _doInit() {
        try {
          this.showMap();
          
          if (!window.L && !this.leafletLoaded) {
            await this.loadLeaflet();
          }
          
          if (!this.mapInstance) {
            const center = window.app?.state.userLocation ? 
              [window.app.state.userLocation.lat, window.app.state.userLocation.lng] : 
              [35.6804, 139.7690];
            
            this.mapInstance = window.mapInstance = L.map('map', { 
              zoomControl: true 
            }).setView(center, 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              maxZoom: 19,
              attribution: '&copy; OSM'
            }).addTo(this.mapInstance);
            
            this.hideError();
            this.initialized = true;
          }
          
          this.renderMarkers();
        } catch (e) {
          this.showError();
          throw e;
        } finally {
          this.initPromise = null;
        }
      },
      
      async loadLeaflet() {
        return new Promise((resolve, reject) => {
          const css = document.createElement('link');
          css.rel = 'stylesheet';
          css.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
          document.head.appendChild(css);
          
          const script = document.createElement('script');
          script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
          script.onload = () => {
            this.leafletLoaded = true;
            resolve();
          };
          script.onerror = () => {
            Toast.show('åœ°å›³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 3000);
            reject(new Error('Failed to load Leaflet'));
          };
          document.body.appendChild(script);
        });
      },
      
      renderMarkers() {
        if (!this.mapInstance || !this.initialized || !window.app) return;
        
        if (this.markerGroup) {
          this.markerGroup.clearLayers();
        } else {
          this.markerGroup = L.layerGroup().addTo(this.mapInstance);
        }
        
        // ì‚¬ìš©ì ìœ„ì¹˜ í‘œì‹œ
        if (window.app.state.userLocation) {
          L.circleMarker([window.app.state.userLocation.lat, window.app.state.userLocation.lng], {
            radius: 8, 
            fillColor: '#2563eb', 
            color: '#fff', 
            weight: 2, 
            fillOpacity: 1
          }).addTo(this.markerGroup).bindPopup('ç¾åœ¨åœ°');
        }
        
        // ì¿ í° ë§ˆì»¤
        window.app.state.coupons.forEach(c => {
          if (c.lat != null && c.lng != null) {
            const marker = L.marker([c.lat, c.lng]);
            const store = getCouponField(c, 'store');
            const offer = getCouponField(c, 'offer');
            
            let popup = `<strong>${store}</strong><br>${offer}<br>`;
            popup += c.expiry === '9999-12-31' ? 
              (T[LanguageManager.currentLang].noExpiry || 'æœŸé™ãªã—') : 
              c.expiry.replace(/-/g,'/');
            
            if (window.app.state.userLocation) {
              const d = Utils.distance(window.app.state.userLocation.lat, window.app.state.userLocation.lng, c.lat, c.lng);
              popup += `<br>${d < 1 ? Math.round(d * 1000) + 'm' : d.toFixed(1) + 'km'}`;
            }
            
            marker.bindPopup(popup);
            marker.on('click', () => {
              const card = document.querySelector(`[data-id="${c.id}"]`);
              if (card) { 
                card.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                card.focus(); 
              }
            });
            marker.addTo(this.markerGroup);
          }
        });
      },
      
      centerTo(loc) {
        if (this.mapInstance && loc && loc.lat && loc.lng) {
          this.mapInstance.setView([loc.lat, loc.lng], 13);
        }
      },
      
      updateLocation() {
        this.renderMarkers();
        if (window.app?.state.userLocation) {
          this.centerTo(window.app.state.userLocation);
        }
      },
      
      showError() {
        const errorEl = document.getElementById('mapError');
        if (errorEl) {
          errorEl.style.display = 'block';
        }
      },
      
      hideError() {
        const errorEl = document.getElementById('mapError');
        if (errorEl) {
          errorEl.style.display = 'none';
        }
      }
    };

    // ===========================================
    // ì¹´ë“œ ìƒì„± ë° ê´€ë ¨ í•¨ìˆ˜ë“¤
    // ===========================================
    function createCard(coupon) {
      const card = document.createElement('div');
      card.className = 'card';
      card.setAttribute('data-id', coupon.id);
      card.setAttribute('tabindex', '0');
      card.setAttribute('role', 'button');
      
      // ë‹¤êµ­ì–´ í•„ë“œ ì¶”ì¶œ
      const store = getCouponField(coupon, 'store');
      const offer = getCouponField(coupon, 'offer');
      const description = getCouponField(coupon, 'description');
      const recommendation = getCouponField(coupon, 'recommendation');
      
      card.setAttribute('aria-label', `${store}ã®ã‚¯ãƒ¼ãƒãƒ³: ${offer}`);
      card.setAttribute('aria-expanded', 'false');
      
      // ì¹´ë“œ ë‚´ë¶€ ì»¨í…Œì´ë„ˆ
      const cardInner = document.createElement('div');
      cardInner.className = 'card-inner';
      
      // ì•ë©´ ìƒì„±
      const cardFront = createCardFront(coupon, store, offer, description, recommendation);
      
      // ë’·ë©´ ìƒì„±  
      const cardBack = createCardBack(coupon, store, offer);
      
      // ì¹´ë“œ ì¡°ë¦½
      cardInner.appendChild(cardFront);
      cardInner.appendChild(cardBack);
      card.appendChild(cardInner);
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      setupCardEvents(card, cardFront, cardBack, coupon);
      
      return card;
    }

    function createCardFront(coupon, store, offer, description, recommendation) {
      const cardFront = document.createElement('div');
      cardFront.className = 'card-face card-front';
      cardFront.setAttribute('aria-hidden', 'false');
      
      // ì´ë¯¸ì§€
      const img = document.createElement('img');
      img.src = coupon.image;
      img.alt = store;
      img.loading = 'lazy';
      cardFront.appendChild(img);
      
      // ì¹´ë“œ ë°”ë””
      const body = document.createElement('div');
      body.className = 'card-body';
      
      // ì œëª©
      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = store;
      
      // í˜œíƒ
      const offerEl = document.createElement('div');
      offerEl.className = 'offer';
      offerEl.textContent = offer;
      
      // ì„¤ëª…
      const desc = document.createElement('div');
      desc.className = 'desc';
      desc.textContent = description;
      
      body.appendChild(title);
      body.appendChild(offerEl);
      body.appendChild(desc);
      
      // ì¶”ì²œ ì´ìœ  ë²„íŠ¼ + ë§í’ì„  (ì¶”ì²œì‚¬ê°€ ìˆëŠ” ê²½ìš°)
      if (recommendation) {
        const recWrapper = createRecommendationSection(recommendation);
        body.appendChild(recWrapper);
      }
      
      // í‘¸í„° (ë§Œë£Œì¼, ê±°ë¦¬)
      const footer = createCardFooter(coupon);
      body.appendChild(footer);
      
      cardFront.appendChild(body);
      
      // ì €ì¥ ë²„íŠ¼
      const saveBtn = createSaveButton(coupon.id);
      cardFront.appendChild(saveBtn);
      
      return cardFront;
    }

    function createRecommendationSection(recommendation) {
      const recWrapper = document.createElement('div');
      recWrapper.style.marginTop = '0.25rem';

      const recBtn = document.createElement('button');
      recBtn.className = 'btn btn-sm';
      recBtn.style.fontSize = '0.75rem';
      recBtn.textContent = T[LanguageManager.currentLang].whyThisStore || 'ğŸ’¬ ãªãœã“ã®åº—ï¼Ÿ';

      const bubble = document.createElement('div');
      bubble.className = 'speech-bubble hidden';
      bubble.textContent = recommendation;

      recBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        bubble.classList.toggle('hidden');
      });

      recWrapper.appendChild(recBtn);
      recWrapper.appendChild(bubble);
      
      return recWrapper;
    }

    function createCardFooter(coupon) {
      const footer = document.createElement('div');
      footer.className = 'footer';
      
      // ë§Œë£Œì¼
      const expiry = document.createElement('div');
      expiry.className = 'small';
      const expiryText = coupon.expiry === '9999-12-31' ? 
        T[LanguageManager.currentLang].noExpiry || 'æœŸé™ãªã—' : 
        coupon.expiry.replace(/-/g, '/');
      expiry.textContent = expiryText;
      
      footer.appendChild(expiry);
      
      // ê±°ë¦¬ (ì‚¬ìš©ì ìœ„ì¹˜ê°€ ìˆëŠ” ê²½ìš°)
      if (window.app?.state.userLocation) {
        const dist = document.createElement('div');
        dist.className = 'small';
        const distance = Utils.distance(
          window.app.state.userLocation.lat, window.app.state.userLocation.lng, 
          coupon.lat, coupon.lng
        );
        dist.textContent = distance < 1 ? 
          `${Math.round(distance * 1000)}m` : 
          `${distance.toFixed(1)}km`;
        footer.appendChild(dist);
      }
      
      return footer;
    }

    function createSaveButton(couponId) {
      const saveBtn = document.createElement('button');
      saveBtn.className = 'save';
      const isSaved = window.app?.state.saved.includes(couponId);
      saveBtn.setAttribute('aria-label', isSaved ? 
        (T[LanguageManager.currentLang].unsaveCoupon || 'ã‚¯ãƒ¼ãƒãƒ³ã®ä¿å­˜ã‚’è§£é™¤') : 
        (T[LanguageManager.currentLang].saveCoupon || 'ã‚¯ãƒ¼ãƒãƒ³ã‚’ä¿å­˜'));
      saveBtn.innerHTML = isSaved ? 'â˜…' : 'â˜†';
      if (isSaved) saveBtn.classList.add('saved');
      
      saveBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        toggleSave(couponId, saveBtn);
      });
      
      return saveBtn;
    }

    function createCardBack(coupon, store, offer) {
      const cardBack = document.createElement('div');
      cardBack.className = 'card-face card-back';
      cardBack.setAttribute('aria-hidden', 'true');
      
      // ë‹«ê¸° ë²„íŠ¼
      const closeBtn = document.createElement('button');
      closeBtn.className = 'close-detail-btn';
      closeBtn.innerHTML = T[LanguageManager.currentLang].backButton || 'â† æˆ»ã‚‹';
      closeBtn.setAttribute('aria-label', T[LanguageManager.currentLang].closeDetail || 'è©³ç´°ã‚’é–‰ã˜ã‚‹');
      
      closeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const card = e.target.closest('.card');
        flipCard(card, false);
      });
      
      cardBack.appendChild(closeBtn);
      
      // QR ì„¹ì…˜
      const qrSection = createQRSection(coupon.code);
      cardBack.appendChild(qrSection);
      
      // ì •ë³´ ì„¹ì…˜
      const backInfo = createBackInfo(coupon, store, offer);
      cardBack.appendChild(backInfo);
      
      // ë³µì‚¬ ë²„íŠ¼
      const copyBtn = createCopyButton(coupon.code);
      cardBack.appendChild(copyBtn);
      
      return cardBack;
    }

    function createQRSection(code) {
      const qrSection = document.createElement('div');
      qrSection.className = 'qr-section';
      
      const qrCode = document.createElement('div');
      qrCode.className = 'qr-code';
      qrCode.innerHTML = 'ğŸ«';
      
      const couponCode = document.createElement('div');
      couponCode.className = 'coupon-code';
      couponCode.textContent = code;
      
      // ì½”ë“œ í´ë¦­ì‹œ ì„ íƒ
      couponCode.addEventListener('click', (e) => {
        e.stopPropagation();
        selectText(couponCode);
        Toast.show(T[LanguageManager.currentLang].codeSelected || 'ã‚³ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¾ã—ãŸ');
      });
      
      qrSection.appendChild(qrCode);
      qrSection.appendChild(couponCode);
      
      return qrSection;
    }

    function createBackInfo(coupon, store, offer) {
      const backInfo = document.createElement('div');
      backInfo.className = 'back-info';
      
      const lang = LanguageManager.currentLang;
      
      // ë§¤ì¥ ì •ë³´
      const storeInfo = document.createElement('div');
      storeInfo.className = 'info-item';
      storeInfo.innerHTML = `<strong>${T[lang].store || 'åº—èˆ—'}:</strong> ${store}`;
      
      // í˜œíƒ ì •ë³´
      const offerInfo = document.createElement('div');
      offerInfo.className = 'info-item';
      offerInfo.innerHTML = `<strong>${T[lang].benefit || 'ç‰¹å…¸'}:</strong> ${offer}`;
      
      // ë§Œë£Œì¼ ì •ë³´
      const expiryInfo = document.createElement('div');
      expiryInfo.className = 'info-item';
      const expiryText = coupon.expiry === '9999-12-31' ? 
        T[lang].noExpiry || 'æœŸé™ãªã—' : 
        coupon.expiry;
      expiryInfo.innerHTML = `<strong>${T[lang].expiry || 'æœ‰åŠ¹æœŸé™'}:</strong> ${expiryText}`;
      
      // ì§€ë„ ë§í¬
      const mapLink = document.createElement('div');
      mapLink.className = 'info-item';
      mapLink.style.cssText = 'cursor:pointer;color:var(--primary);';
      mapLink.innerHTML = `<strong>ğŸ“ ${T[lang].mapView || 'åœ°å›³ã§è¦‹ã‚‹'}</strong>`;
      
      mapLink.addEventListener('click', async (e) => {
        e.stopPropagation();
        await MapManager.init();
        MapManager.centerTo({lat: coupon.lat, lng: coupon.lng});
        const card = e.target.closest('.card');
        flipCard(card, false);
        Toast.show(T[lang].mapShown || 'åœ°å›³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
      });
      
      backInfo.appendChild(storeInfo);
      backInfo.appendChild(offerInfo);
      backInfo.appendChild(expiryInfo);
      backInfo.appendChild(mapLink);
      
      return backInfo;
    }

    function createCopyButton(code) {
      const copyBtn = document.createElement('button');
      copyBtn.className = 'copy-btn';
      const lang = LanguageManager.currentLang;
      copyBtn.innerHTML = `ğŸ“‹ ${T[lang].copyCode || 'ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼'}`;
      
      copyBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const success = await copyToClipboard(code);
        
        if (success) {
          Toast.show(T[lang].codeCopied || 'ã‚¯ãƒ¼ãƒãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', 2000);
          copyBtn.innerHTML = `âœ… ${T[lang].copied || 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'}`;
          setTimeout(() => {
            copyBtn.innerHTML = `ğŸ“‹ ${T[lang].copyCode || 'ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼'}`;
          }, 2000);
        } else {
          Toast.show(T[lang].copyFailed || 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 3000);
        }
      });
      
      return copyBtn;
    }

    // í—¬í¼ í•¨ìˆ˜ë“¤
    function flipCard(card, show = true) {
      const cardFront = card.querySelector('.card-front');
      const cardBack = card.querySelector('.card-back');
      
      if (show) {
        card.classList.add('flipped');
        card.setAttribute('aria-expanded', 'true');
        cardFront.setAttribute('aria-hidden', 'true');
        cardBack.setAttribute('aria-hidden', 'false');
      } else {
        card.classList.remove('flipped');
        card.setAttribute('aria-expanded', 'false');
        cardFront.setAttribute('aria-hidden', 'false');
        cardBack.setAttribute('aria-hidden', 'true');
      }
    }

    function selectText(element) {
      const selection = window.getSelection();
      const range = document.createRange();
      range.selectNodeContents(element);
      selection.removeAllRanges();
      selection.addRange(range);
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (err) {
        try {
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.cssText = 'position:fixed;left:-999999px;';
          document.body.appendChild(textArea);
          textArea.select();
          const success = document.execCommand('copy');
          document.body.removeChild(textArea);
          return success;
        } catch {
          return false;
        }
      }
    }

    function setupCardEvents(card, cardFront, cardBack, coupon) {
      // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
      card.addEventListener('click', (e) => {
        // íŠ¹ì • ìš”ì†Œ í´ë¦­ì€ ë¬´ì‹œ
        if (e.target.closest('.save, .copy-btn, .info-item, .close-detail-btn')) {
          return;
        }
        
        const isFlipped = card.classList.contains('flipped');
        flipCard(card, !isFlipped);
        
        const lang = LanguageManager.currentLang;
        if (!isFlipped) {
          Toast.show(T[lang].detailShow || 'è©³ç´°ã‚’è¡¨ç¤º', 1000);
        } else {
          Toast.show(T[lang].backToList || 'ãƒªã‚¹ãƒˆã«æˆ»ã‚‹', 1000);
        }
      });
      
      // í‚¤ë³´ë“œ ì ‘ê·¼ì„±
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          if (!e.target.closest('.save')) {
            card.click();
          }
        }
      });
    }

    // ì €ì¥ í† ê¸€
    function toggleSave(id, btn) {
      if (!window.app) return;
      
      const lang = LanguageManager.currentLang;
      
      if (window.app.state.saved.includes(id)) {
        window.app.state.saved = window.app.state.saved.filter(x => x !== id);
        btn.innerHTML = 'â˜†';
        btn.classList.remove('saved');
        btn.setAttribute('aria-label', T[lang].saveCoupon || 'ã‚¯ãƒ¼ãƒãƒ³ã‚’ä¿å­˜');
        Toast.show(T[lang].unsavedCoupon || 'ä¿å­˜ã‚’è§£é™¤ã—ã¾ã—ãŸ');
        
        // saved í•„í„° ì¤‘ì´ë©´ ë°”ë¡œ ì¬ì ìš©
        if (window.app.state.currentFilter === 'saved') {
          window.app.applyFilters();
        }
      } else {
        window.app.state.saved.push(id);
        btn.innerHTML = 'â˜…';
        btn.classList.add('saved');
        btn.setAttribute('aria-label', T[lang].unsaveCoupon || 'ã‚¯ãƒ¼ãƒãƒ³ã®ä¿å­˜ã‚’è§£é™¤');
        Toast.show(T[lang].savedCoupon || 'ä¿å­˜ã—ã¾ã—ãŸ');
      }
      
      // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
      StorageManager.setSaved(window.app.state.saved);
    }

    // ===========================================
    // ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ í´ë˜ìŠ¤
    // ===========================================
    class JKWalletApp {
      constructor() {
        this.state = {
          coupons: [],
          filtered: [],
          saved: [],
          userLocation: null,
          currentFilter: 'all',
          currentSearch: '',
          currentView: 'home',
          isLoading: false,
          hasError: false
        };
        
        this.config = {
          api: {
            retryAttempts: 3,
            retryDelay: 1000,
            timeout: 10000
          },
          performance: {
            pageSize: 20,
            renderThrottle: 16,
            searchDebounce: 300
          }
        };

        // ë°”ì¸ë”©
        this.handleSearch = Utils.debounce(this.handleSearch.bind(this), this.config.performance.searchDebounce);
        this.handleResize = Utils.throttle(this.handleResize.bind(this), 250);
      }

      // ì´ˆê¸°í™” ì‹œí€€ìŠ¤
      async init() {
        try {
          this.showLoadingState();
          
          // 1. ì–¸ì–´ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
          LanguageManager.init();
          
          // 2. í…Œë§ˆ ë¡œë“œ
          this.loadTheme();
          
          // 3. ë°ì´í„° ë¡œë“œ (ë³‘ë ¬)
          const [coupons, saved] = await Promise.all([
            this.loadCoupons(),
            this.loadSavedCoupons()
          ]);
          
          this.state.coupons = coupons;
          this.state.saved = saved;
          this.state.filtered = [...coupons];
          
          // 4. UI ì´ˆê¸°í™”
          this.setupUI();
          
          // 5. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
          this.setupEventListeners();
          
          // 6. ì´ˆê¸° ë Œë”ë§
          this.render();
          
          this.hideLoadingState();
          console.log('âœ… JK Wallet ì´ˆê¸°í™” ì™„ë£Œ');
          
        } catch (error) {
          this.handleInitError(error);
        }
      }

      async loadCoupons() {
        const loader = new CouponLoader(this.config.api);
        return await loader.loadFromAPI();
      }

      async loadSavedCoupons() {
        return StorageManager.getSaved();
      }

      loadTheme() {
        const isDark = StorageManager.getTheme();
        if (isDark) document.body.classList.add('dark-mode');
      }

      setupUI() {
        // í•„í„° ë²„íŠ¼ ì„¤ì •
        this.setupFilters();
        
        // ë„¤ë¹„ê²Œì´ì…˜ ì„¤ì •
        this.setupNavigation();
        
        // ê²€ìƒ‰ ì„¤ì •
        this.setupSearch();
      }

      setupEventListeners() {
        // í…Œë§ˆ í† ê¸€
        document.getElementById('themeToggle')?.addEventListener('click', () => {
          this.toggleTheme();
        });
        
        // ìœ„ì¹˜ ë²„íŠ¼
        document.getElementById('locateBtn')?.addEventListener('click', () => {
          this.requestLocation();
        });
        
        // ë¦¬ì‚¬ì´ì¦ˆ ì²˜ë¦¬
        window.addEventListener('resize', this.handleResize);
      }

      setupFilters() {
        const pills = document.querySelectorAll('.pill');
        
        pills.forEach(pill => {
          pill.addEventListener('click', async () => {
            const filter = pill.dataset.filter;
            await this.setFilter(filter);
          });
          
          // í‚¤ë³´ë“œ ì ‘ê·¼ì„±
          pill.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              pill.click();
            }
          });
        });
      }

      setupNavigation() {
        document.querySelectorAll('.nav-item').forEach(item => {
          item.addEventListener('click', async (e) => {
            e.preventDefault();
            const view = item.dataset.view;
            await this.setView(view);
          });
        });
      }

      setupSearch() {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
          searchInput.addEventListener('input', this.handleSearch);
        }
      }

      async setFilter(filter) {
        if (this.state.isLoading) return;
        
        // UI ì—…ë°ì´íŠ¸
        document.querySelectorAll('.pill').forEach(p => {
          p.classList.toggle('active', p.dataset.filter === filter);
          p.setAttribute('aria-selected', p.dataset.filter === filter);
        });
        
        const prevFilter = this.state.currentFilter;
        this.state.currentFilter = filter;
        
        try {
          // nearby í•„í„° íŠ¹ë³„ ì²˜ë¦¬
          if (filter === 'nearby') {
            if (!this.state.userLocation) {
              await this.requestLocation();
            }
            await MapManager.init();
            MapManager.centerTo(this.state.userLocation);
            this.showNearbyHint();
          } else {
            this.hideNearbyHint();
            if (filter === 'all' || filter === 'saved') {
              MapManager.hideMap();
            }
          }
          
          this.applyFilters();
          
        } catch (error) {
          // ì‹¤íŒ¨ì‹œ ì´ì „ í•„í„°ë¡œ ë³µì›
          this.state.currentFilter = prevFilter;
          document.querySelectorAll('.pill').forEach(p => {
            p.classList.toggle('active', p.dataset.filter === prevFilter);
            p.setAttribute('aria-selected', p.dataset.filter === prevFilter);
          });
          
          if (filter === 'nearby') {
            Location.showError();
          }
        }
      }

      async setView(view) {
        if (this.state.currentView === view) return;
        
        // ë„¤ë¹„ê²Œì´ì…˜ UI ì—…ë°ì´íŠ¸
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.toggle('active', item.dataset.view === view);
        });
        
        this.state.currentView = view;
        
        // ë·°ë³„ ì²˜ë¦¬
        switch(view) {
          case 'home':
            await this.setFilter('all');
            MapManager.hideMap();
            break;
            
          case 'saved':
            await this.setFilter('saved');
            MapManager.hideMap();
            break;
            
          case 'map':
            await MapManager.init();
            MapManager.showMap();
            if (this.state.userLocation) {
              MapManager.centerTo(this.state.userLocation);
            }
            this.showNearbyHint();
            Toast.show(T[LanguageManager.currentLang].mapViewTab || 'ãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼');
            break;
            
          case 'settings':
            this.showSettings();
            MapManager.hideMap();
            break;
        }
      }

      handleSearch(e) {
        this.state.currentSearch = e.target.value.trim();
        this.applyFilters();
      }

      applyFilters() {
        if (this.state.isLoading) return;
        
        let filtered = [...this.state.coupons];
        
        // í•„í„° ì ìš©
        switch(this.state.currentFilter) {
          case 'saved':
            filtered = filtered.filter(c => this.state.saved.includes(c.id));
            break;
            
          case 'nearby':
            if (this.state.userLocation) {
              filtered.sort((a, b) => {
                const distA = Utils.distance(this.state.userLocation.lat, this.state.userLocation.lng, a.lat, a.lng);
                const distB = Utils.distance(this.state.userLocation.lat, this.state.userLocation.lng, b.lat, b.lng);
                return distA - distB;
              });
            }
            break;
            
          case 'electronics':
          case 'fashion':
          case 'dining':
          case 'transport':
            filtered = filtered.filter(c => c.category === this.state.currentFilter);
            break;
        }
        
        // ê²€ìƒ‰ì–´ ì ìš©
        if (this.state.currentSearch) {
          const query = this.state.currentSearch.toLowerCase();
          filtered = filtered.filter(c => {
            const store = getCouponField(c, 'store').toLowerCase();
            const description = getCouponField(c, 'description').toLowerCase();
            const category = c.category?.toLowerCase() || '';
            
            return store.includes(query) || 
                   description.includes(query) || 
                   category.includes(query);
          });
        }
        
        this.state.filtered = filtered;
        this.render();
      }

      render() {
        this.renderCoupons();
        this.updateUI();
      }

      renderCoupons() {
        const grid = document.getElementById('couponGrid');
        if (!grid) return;
        
        grid.innerHTML = '';
        
        if (this.state.filtered.length === 0) {
          grid.innerHTML = `
            <div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--muted);">
              ${T[LanguageManager.currentLang].notFound || 'ã‚¯ãƒ¼ãƒãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'}
            </div>
          `;
          return;
        }
        
        const fragment = document.createDocumentFragment();
        this.state.filtered.forEach(coupon => {
          fragment.appendChild(createCard(coupon));
        });
        
        grid.appendChild(fragment);
      }

      updateUI() {
        // ì§€ë„ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        if (window.mapInstance) {
          MapManager.renderMarkers();
        }
      }

      async requestLocation() {
        if (this.state.isLoading) return;
        
        this.state.isLoading = true;
        
        try {
          this.state.userLocation = await Location.request();
          Location.hideError();
          
          // ì§€ë„ ì—…ë°ì´íŠ¸
          if (window.mapInstance) {
            MapManager.updateLocation();
          }
          
          // nearby í•„í„°ê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì¬ì •ë ¬
          if (this.state.currentFilter === 'nearby') {
            this.applyFilters();
          }
          
        } catch (error) {
          Location.showError();
        } finally {
          this.state.isLoading = false;
        }
      }

      toggleTheme() {
        const isDark = document.body.classList.toggle('dark-mode');
        StorageManager.setTheme(isDark);
        Toast.show(isDark ? 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰' : 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰', 1000);
      }

      // ì—ëŸ¬ ì²˜ë¦¬
      handleInitError(error) {
        console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        this.state.hasError = true;
        this.showErrorState(error);
      }

      // UI ìƒíƒœ ê´€ë¦¬
      showLoadingState() {
        document.body.classList.add('loading');
      }

      hideLoadingState() {
        document.body.classList.remove('loading');
      }

      showErrorState(error) {
        const errorMsg = document.createElement('div');
        errorMsg.className = 'error-state';
        errorMsg.innerHTML = `
          <h2>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h2>
          <p>${error.message}</p>
          <button onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button>
        `;
        document.body.appendChild(errorMsg);
      }

      showNearbyHint() {
        const hint = document.getElementById('nearbyHint');
        if (hint) hint.classList.add('show');
      }

      hideNearbyHint() {
        const hint = document.getElementById('nearbyHint');
        if (hint) hint.classList.remove('show');
      }

      showSettings() {
        Toast.show('è¨­å®šãƒšãƒ¼ã‚¸ã¯æº–å‚™ä¸­ã§ã™');
      }

      // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      handleResize() {
        // ë°˜ì‘í˜• ì²˜ë¦¬
      }
    }

    // ===========================================
    // ì „ì—­ í•¨ìˆ˜ë“¤ (í˜¸í™˜ì„±)
    // ===========================================
    window.retryMap = () => MapManager.init();
    window.getCouponField = getCouponField;

    // ===========================================
    // ì´ˆê¸°í™”
    // ===========================================
    let app;

    document.addEventListener('DOMContentLoaded', async () => {
      app = new JKWalletApp();
      window.app = app; // ì „ì—­ ì ‘ê·¼ìš©
      await app.init();
    });

    document.addEventListener('DOMContentLoaded', () => {
  const langBtn = document.getElementById('langBtn');
  const langMenu = document.getElementById('langMenu');

  if (langBtn && langMenu) {
    langBtn.addEventListener('click', () => {
      langMenu.classList.toggle('hidden');
    });

    // ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.addEventListener('click', (e) => {
      if (!langMenu.contains(e.target) && !langBtn.contains(e.target)) {
        langMenu.classList.add('hidden');
      }
    });

    // ì–¸ì–´ ì„ íƒ ì´ë²¤íŠ¸
    langMenu.querySelectorAll('button[data-lang]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const lang = btn.dataset.lang;
        LanguageManager.setLanguage(lang);
        langMenu.classList.add('hidden');
      });
    });
  }
});

  </script>
</body>
</html>
