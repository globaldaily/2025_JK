<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <meta name="theme-color" content="#2563eb">
  <title>Japankuru クーポンウォレット</title>
  <style>
    :root {
      --primary:#2563eb;
      --bg:#f3f4f6;
      --card:#ffffff;
      --radius:.75rem;
      --shadow:0 4px 12px rgba(0,0,0,0.08);
      --text:#111827;
      --muted:#6b7280;
      --border:#d1d5db;
      --gray-100:#f3f4f6;
      --gray-700:#374151;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
    }
    .dark-mode {
      --bg:#0f172a;
      --card:#1e293b;
      --text:#f1f5f9;
      --muted:#94a3b8;
      --border:#334155;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);line-height:1.4;min-height:100vh;padding-bottom:80px;transition:background .3s,color .3s;}
    .container{max-width:1000px;margin:0 auto;padding:0 0.75rem;}
    .header{display:flex;justify-content:space-between;align-items:center;padding:0.75rem 0;background:var(--bg);transition:transform .3s;}
    .header.hidden{transform:translateY(-100%);}
    .search-filter-bar{position:sticky;top:0;background:var(--bg);z-index:1000;padding:0.5rem 1rem 0.75rem 1rem;display:flex;flex-direction:column;gap:0.5rem;border-bottom:1px solid var(--border);}
    .logo{font-weight:700;display:flex;align-items:center;gap:.5rem;font-size:1.1rem;color:var(--primary);}
    .btn{padding:.5rem 1rem;border:none;border-radius:.5rem;cursor:pointer;font-size:.9rem;display:inline-flex;align-items:center;gap:.25rem;transition:all .2s;-webkit-tap-highlight-color:transparent;}
    .btn:hover{transform:scale(1.02);}
    .btn:active{transform:scale(0.98);}
    .btn:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .btn-primary{background:var(--primary);color:#fff;}
    .btn-primary:hover{background:#1d4ed8;}

    /* 언어 선택기 개선 (접근성 강화) */
    .lang-toggle{position:relative;z-index:1001;}
    .lang-btn{background:var(--card);border:1px solid var(--border);display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:8px;cursor:pointer;font-size:14px;transition:all .2s;aria-haspopup:true;aria-expanded:false;}
    .lang-btn:hover{border-color:var(--primary);box-shadow:0 2px 4px rgba(0,0,0,.1);}
    .lang-flag{font-size:18px;}
    .lang-name{font-size:13px;font-weight:500;}
    .lang-menu{position:absolute;right:0;top:calc(100% + 4px);background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 4px 12px rgba(0,0,0,.1);display:none;flex-direction:column;min-width:160px;z-index:1002;overflow:hidden;}
    .lang-menu.show{display:flex;}
    .lang-menu button{background:none;border:none;padding:10px 16px;font-size:14px;text-align:left;cursor:pointer;color:var(--text);transition:background .2s;display:flex;align-items:center;gap:10px;}
    .lang-menu button:hover,.lang-menu button:focus{background:var(--gray-100);outline:none;}
    .dark-mode .lang-menu button:hover,.dark-mode .lang-menu button:focus{background:var(--gray-700);}
    .lang-menu button[aria-selected="true"]{background:#eff6ff;color:var(--primary);font-weight:600;}
    .dark-mode .lang-menu button[aria-selected="true"]{background:rgba(59,130,246,.15);}

    /* 검색 개선 */
    .search{margin:0.5rem 0;position:relative;}
    .search-wrapper{position:relative;display:flex;align-items:center;}
    .search-icon{position:absolute;left:12px;color:var(--muted);pointer-events:none;font-size:16px;}
    .search input{width:100%;padding:.75rem 1rem .75rem 2.5rem;border:1px solid var(--border);border-radius:.5rem;font-size:1rem;outline:none;background:var(--card);color:var(--text);transition:border-color .2s;}
    .search input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.1);}
    .search-clear{position:absolute;right:12px;background:none;border:none;color:var(--muted);cursor:pointer;padding:6px;font-size:16px;display:none;transition:color .2s;}
    .search-clear:hover{color:var(--text);}
    .search-clear.show{display:block;}

    /* 필터 개선 */
    .filters{display:flex;gap:.5rem;overflow-x:auto;margin-bottom:0.5rem;-webkit-overflow-scrolling:touch;}
    /* .filters 수정 */
.filters {
  display: flex;                        /* 유지 */
  gap: .5rem;                          /* 유지 */
  overflow-x: auto;                    /* 유지 */
  margin-bottom: 0.5rem;               /* 유지 */
  -webkit-overflow-scrolling: touch;   /* 유지 */
  /* scrollbar-width: none; */        /* 삭제! */
  padding-bottom: 6px;                 /* 추가 */
  scrollbar-width: thin;               /* 추가 (Firefox) */
  scrollbar-color: var(--primary) var(--gray-100); /* 추가 (Firefox) */
}

/* 기존 숨김 스타일을 커스텀으로 대체 */
.filters::-webkit-scrollbar {
  height: 4px;  /* display: none; 대신 */
}

.filters::-webkit-scrollbar-track {
  background: var(--gray-100);
  border-radius: 2px;
}

.filters::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 2px;
  opacity: 0.6;
}

.filters::-webkit-scrollbar-thumb:hover {
  opacity: 1;
}
    .pill{padding:.5rem .75rem;border-radius:9999px;border:1px solid var(--border);background:var(--card);cursor:pointer;font-size:.75rem;display:flex;align-items:center;gap:4px;transition:all .3s;white-space:nowrap;position:relative;overflow:hidden;flex-shrink: 0;min-width: fit-content;}
    .pill::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;background:var(--primary);border-radius:50%;transform:translate(-50%,-50%);transition:all .4s;}
    .pill:hover{transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,0,0,.1);}
    .pill:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .pill[aria-selected="true"]{color:#fff;border-color:var(--primary);}
    .pill[aria-selected="true"]::before{width:200%;height:200%;}
    .pill span{position:relative;z-index:1;}
    .saved-count{background:var(--danger);color:#fff;font-size:10px;padding:1px 5px;border-radius:10px;min-width:16px;text-align:center;font-weight:600;display:none;}
    .saved-count.show{display:inline-block;}

    /* 히어로 섹션 */
    .hero-section{text-align:center;padding:1.5rem 1rem;background:linear-gradient(135deg,#4f46e5,#2563eb);color:#ffffff;margin-bottom:1rem;border-radius:var(--radius);box-shadow:var(--shadow);}
    .hero-section h1{font-size:1.5rem;font-weight:700;margin:0 0 0.5rem 0;}
    .hero-section p{font-size:0.9rem;margin:0 0 0.75rem 0;opacity:0.9;}
    .hero-section .cta-button{background-color:#ffffff;color:var(--primary);font-size:0.9rem;font-weight:700;padding:0.6rem 1.2rem;border-radius:9999px;text-decoration:none;transition:all 0.2s ease-in-out;box-shadow:0 4px 12px rgba(0,0,0,0.15);display:inline-block;}
    .hero-section .cta-button:hover{transform:translateY(-2px) scale(1.05);box-shadow:0 6px 16px rgba(0,0,0,0.2);}

    /* 스켈레톤 로딩 */
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .skeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;}
    .dark-mode .skeleton{background:linear-gradient(90deg,#334155 25%,#475569 50%,#334155 75%);background-size:200% 100%;}
    .skeleton-card{background:var(--card);border-radius:var(--radius);overflow:hidden;height:300px;box-shadow:var(--shadow);}
    .skeleton-img{height:160px;}
    .skeleton-body{padding:16px;}
    .skeleton-line{height:16px;border-radius:4px;margin-bottom:12px;}
    .skeleton-line.title{width:60%;height:20px;}
    .skeleton-line.desc{width:100%;height:14px;}
    .skeleton-line.short{width:80%;}

    /* 쿠폰 그리드 */
    .coupon-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;margin-top:0.5rem;}
    .loading .coupon-grid{position:relative;min-height:400px;}

    /* ===== 카드 스타일 정리 ===== */
    
    /* 카드 컨테이너 */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      position: relative;
      cursor: pointer;
      transition: transform .2s, box-shadow .2s;
      perspective: 1000px;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,.12);
    }
    
    .card:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    
    /* 카드 내부 컨테이너 (3D 플립) */
    .card-inner {
  position: relative;
  display: grid; /* flexbox 대신 grid 사용 */
  transform-style: preserve-3d;
  transition: transform .6s;
}
    
    .card.flipped .card-inner {
      transform: rotateY(180deg);
    }
    
   /* 카드 면 공통 - 같은 그리드 셀에 겹치기 */
.card-face {
  grid-area: 1 / 1 / 2 / 2; /* 같은 위치에 겹침 */
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  background: var(--card);
  border-radius: var(--radius);
  width: 100%;
}

    
    /* 앞면 */
    .card-front {
      position: relative;
      display: flex;
      flex-direction: column;
      height: 100%;
}
    
    /* 뒷면 */
    .card-back {
    
      transform: rotateY(180deg);
      padding: 1rem;
    }
    
    /* ===== 앞면 스타일 (간결하게) ===== */
    
    /* 이미지 */
    .card-front img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      display: block;
    }
    
    /* 할인 배지 */
    .offer-badge {
      position: absolute;
      top: 140px;
      left: 0;
      background: var(--danger);
      color: #fff;
      padding: 6px 14px;
      font-size: 1rem;
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
      z-index: 10;
      border-radius: 0 8px 8px 0;
    }
    
    /* 앞면 본문 (컴팩트) */
    .card-body {
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      flex: 1;
    }
    
    .title {
      font-weight: 700;
      font-size: 1rem;
      line-height: 1.2;
    }
    
    .desc {
      font-size: 0.8rem;
      color: var(--muted);
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .area {
      font-size: 0.75rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* 상세보기 버튼 */
    .btn-show-detail {
      width: 100%;
      padding: 0.4rem;
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
      border-radius: 0.5rem;
      font-size: 0.8rem;
      margin-top: auto;
      transition: all .2s;
    }
    
    .btn-show-detail:hover {
      background: var(--primary);
      color: #fff;
    }
    
    /* ===== 뒷면 스타일 (컴팩트) ===== */
    
    /* 뒷면 헤더 */
    .back-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }
    
    .back-header h3 {
      font-size: 1rem;
      font-weight: 700;
      margin: 0;
    }
    
    /* 닫기 버튼 */
    .close-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--gray-100);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s;
      font-size: 14px;
      color: var(--muted);
    }
    
    .close-btn:hover {
      background: var(--border);
      transform: scale(1.1);
    }
    
    .dark-mode .close-btn {
      background: var(--gray-700);
    }
    
    /* 바코드 섹션 */
    .barcode-section {
      background: #fff;
      padding: 0.75rem;
      border-radius: 6px;
      text-align: center;
      border: 1px solid var(--border);
      margin-bottom: 0.75rem;
    }
    
    .dark-mode .barcode-section {
      background: var(--gray-700);
    }
    
    .barcode-section img {
    max-height: 80px;     /* 기존 height: 40px 대신 */
    width: auto;
    max-width: 100%;      /* 추가 */
    object-fit: contain;  /* 추가 */
    }
    
    /* 뒷면 정보 (컴팩트) */
    .info-grid {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .info-item {
      display: flex;
      gap: 0.5rem;
      font-size: 0.8rem;
      line-height: 1.3;
    }
    
    .info-label {
      font-weight: 600;
      min-width: 70px;
      flex-shrink: 0;
      color: var(--text);
    }
    
    .info-value {
      color: var(--muted);
    }
    
    /* 링크 스타일 */
    .info-item a {
      color: var(--primary);
      text-decoration: none;
      font-size: 0.8rem;
    }
    
    .info-item a:hover {
      text-decoration: underline;
    }
    
    /* 복사 버튼 (컴팩트) */
    .copy-btn,.share-btn {
      width: 100%;
      padding: 0.5rem;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 0.5rem;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s;
      margin-top: 0.75rem;
      position: relative;
      overflow: hidden;
    }
    
    .copy-btn:hover {
      background: #1d4ed8;
    }
    
    .copy-btn::after {
      content: '✅ コピーしました！';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      opacity: 0;
      background: var(--success);
      padding: 6px 12px;
      border-radius: 4px;
      transition: all .3s;
      font-size: 0.8rem;
    }
    
    .copy-btn.success::after {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
    
    .copy-btn.success span {
      opacity: 0;
    }
    
    /* 저장 버튼 */
    .save {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #fff;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,.2);
      transition: all .2s;
      z-index: 30;
      font-size: 1.2rem;
    }
    
    .save:hover {
      transform: scale(1.1);
    }
    
    .save.saved {
      background: var(--success);
      color: #fff;
    }
    
    .dark-mode .save {
      background: var(--card);
      color: var(--text);
    }
    
    .dark-mode .save.saved {
      background: var(--success);
      color: #fff;
    }

    /* 추천 말풍선 (더 컴팩트) */
    .speech-bubble {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 0.5rem 0.75rem;
      margin-top: 0.4rem;
      font-size: 0.75rem;
      position: relative;
      color: var(--text);
      box-shadow: 0 2px 6px rgba(0,0,0,.05);
      line-height: 1.3;
    }
    
    .dark-mode .speech-bubble {
      background: var(--gray-700);
      border-color: var(--border);
    }
    
    .speech-bubble::before {
      content: '';
      position: absolute;
      top: -8px;
      left: 20px;
      border-width: 0 8px 8px 8px;
      border-style: solid;
      border-color: transparent transparent #f9fafb transparent;
    }
    
    .dark-mode .speech-bubble::before {
      border-color: transparent transparent var(--gray-700) transparent;
    }
    
    .hidden {
      display: none;
    }

    /* 검색 결과 없음 개선 */
    .no-results{grid-column:1/-1;text-align:center;padding:60px 20px;}
    .no-results-icon{font-size:64px;opacity:.3;margin-bottom:16px;}
    .no-results-title{font-size:20px;font-weight:600;margin-bottom:8px;color:var(--text);}
    .no-results-desc{color:var(--muted);margin-bottom:20px;}
    .suggestion-chips{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
    .suggestion-chip{background:#eff6ff;color:var(--primary);padding:8px 16px;border-radius:20px;border:none;cursor:pointer;font-size:14px;transition:all .2s;}
    .suggestion-chip:hover{background:var(--primary);color:#fff;transform:translateY(-2px);}
    .dark-mode .suggestion-chip{background:rgba(59,130,246,.15);}
    .dark-mode .suggestion-chip:hover{background:var(--primary);}

    /* 지도 */
    #map{width:100%;height:260px;border-radius:12px;margin:1rem 0;overflow:hidden;position:relative;background:var(--card);border:1px solid var(--border);display:none;}
    #map.show{display:block;}
    #mapError{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:1000;}

    /* 토스트 개선 */
    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(100px);background:#111827;color:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.2);opacity:0;pointer-events:none;transition:all .3s;max-width:90vw;z-index:1000;font-size:14px;}
    .toast.show{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(0);}
    .dark-mode .toast{background:#fff;color:#111827;}

    /* 하단 네비게이션 개선 */
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--card);display:flex;justify-content:space-around;padding:0.5rem;border-top:1px solid var(--border);box-shadow:0 -2px 10px rgba(0,0,0,.05);z-index:1000;}
    .dark-mode .bottom-nav{box-shadow:0 -2px 10px rgba(0,0,0,.2);}
    .nav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;color:var(--muted);text-decoration:none;cursor:pointer;padding:6px 12px;border-radius:12px;transition:all 0.2s;flex:1;text-align:center;position:relative;}
    .nav-icon-wrapper{position:relative;width:24px;height:24px;margin-bottom:2px;}
    .nav-icon-wrapper svg{position:absolute;top:0;left:0;width:100%;height:100%;transition:opacity 0.2s;}
    .nav-item .icon-filled{opacity:0;color:var(--primary);}
    .nav-item .icon-outline{opacity:1;}
    .nav-text{font-size:0.7rem;font-weight:500;}
    .nav-item[aria-selected="true"] .icon-filled{opacity:1;}
    .nav-item[aria-selected="true"] .icon-outline{opacity:0;}
    .nav-item[aria-selected="true"] .nav-text{color:var(--primary);font-weight:600;}
    .nav-item[aria-selected="true"]{background-color:rgba(37,99,235,.1);}
    .dark-mode .nav-item[aria-selected="true"]{background-color:rgba(59,130,246,.15);}
    .nav-item:not([aria-selected="true"]):hover{color:var(--primary);}
    .nav-badge{position:absolute;top:2px;right:12px;background:var(--danger);color:#fff;font-size:10px;padding:1px 5px;border-radius:10px;min-width:16px;text-align:center;font-weight:600;display:none;}
    .nav-badge.show{display:block;}

    /* 위치 에러 */
    .location-error{background:#fee;color:#dc2626;padding:.75rem;border-radius:.5rem;margin:1rem 0;font-size:.8rem;display:none;}
    .location-error.show{display:block;}
    .location-error p{margin-top:.25rem;font-size:.75rem;color:#991b1b;}
    .nearby-hint{margin-top:.5rem;font-size:.75rem;color:var(--muted);display:none;}
    .nearby-hint.show{display:block;}

    /* 유틸리티 */
    .toggle-theme{background:none;border:none;cursor:pointer;font-size:1rem;padding:4px;transition:transform .2s;}
    .toggle-theme:hover{transform:scale(1.1);}
    .toggle-theme:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .retry-btn{background:#ef4444;color:#fff;padding:.25rem .5rem;border:none;border-radius:.25rem;cursor:pointer;font-size:.75rem;margin-top:.5rem;}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
    
    /* Settings 뷰 */
    .settings-view{display:none;padding:1rem;max-width:600px;margin:0 auto;}
    .settings-view.show{display:block;}
    .settings-section{background:var(--card);border-radius:var(--radius);padding:1.5rem;margin-bottom:1rem;box-shadow:var(--shadow);}
    .settings-section h3{margin:0 0 1rem 0;font-size:1.1rem;color:var(--text);}
    .settings-item{display:flex;justify-content:space-between;align-items:center;padding:0.75rem 0;border-bottom:1px solid var(--border);}
    .settings-item:last-child{border-bottom:none;}
    .settings-label{font-size:0.9rem;color:var(--text);}
    .settings-value{font-size:0.85rem;color:var(--muted);}
    .settings-btn{padding:0.5rem 1rem;background:var(--gray-100);border:none;border-radius:0.5rem;font-size:0.85rem;cursor:pointer;transition:all .2s;}
    .settings-btn:hover{background:var(--border);}
    .dark-mode .settings-btn{background:var(--gray-700);}
    .dark-mode .settings-btn:hover{background:var(--border);}
    .settings-btn.danger{background:#fee;color:var(--danger);}
    .settings-btn.danger:hover{background:#fdd;}
    .dark-mode .settings-btn.danger{background:rgba(239,68,68,.1);color:var(--danger);}
    
    /* 레이지 로딩 */
    .lazy{opacity:0;transition:opacity .3s;}
    .lazy.loaded{opacity:1;}

    /* 모바일 최적화 */
    @media (max-width: 800px){
      .coupon-grid{grid-template-columns:1fr;}
    }
    @media (max-width: 768px){
      .hero-section{padding:1rem;}
      .hero-section h1{font-size:1.3rem;}
      .hero-section p{font-size:.85rem;}
      .hero-section .cta-button{font-size:0.85rem;padding:0.5rem 1rem;}
    }
    @media (max-width: 480px) {
  .pill {
    font-size: .7rem;    /* 살짝 작게 */
    padding: .4rem .6rem; /* 패딩도 조금 줄임 */
  }
}
  </style>
</head>
<body>
  <div class="container">
    <header class="header" aria-label="ヘッダー">
      <div class="logo" aria-label="JK Wallet">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2v16z"/>
        </svg>
        JK Wallet
      </div>
      
      <!-- 개선된 언어 선택기 (접근성 강화) -->
      <div class="lang-toggle">
        <button class="lang-btn" id="langBtn" aria-label="言語選択" aria-haspopup="true" aria-expanded="false">
          <span class="lang-flag">🇯🇵</span>
          <span class="lang-name">日本語</span>
          <svg width="12" height="12" viewBox="0 0 12 12">
            <path d="M3 5L6 8L9 5" stroke="currentColor" stroke-width="2" fill="none"/>
          </svg>
        </button>
        <div id="langMenu" class="lang-menu" role="menu" aria-labelledby="langBtn">
          <button role="menuitem" data-lang="ja" aria-selected="true">🇯🇵 日本語</button>
          <button role="menuitem" data-lang="ko" aria-selected="false">🇰🇷 한국어</button>
          <button role="menuitem" data-lang="en" aria-selected="false">🇺🇸 English</button>
          <button role="menuitem" data-lang="th" aria-selected="false">🇹🇭 ภาษาไทย</button>
        </div>
      </div>

      <div class="flex-center">
        <button class="toggle-theme" id="themeToggle" aria-label="テーマ切替">🌓</button>
      </div>
    </header>
    
    <!-- 검색+필터 고정 바 -->
    <div class="search-filter-bar">
      <!-- 개선된 검색 -->
      <div class="search" aria-label="検索とフィルター">
        <div class="search-wrapper">
          <span class="search-icon">🔍</span>
          <input type="search" id="searchInput" placeholder="店名・エリアで検索..." aria-label="クーポン検索" autocomplete="off" />
          <button class="search-clear" id="searchClear" aria-label="検索をクリア">✕</button>
        </div>
      </div>

      <!-- 개선된 필터 (이벤트 위임) -->
      <div class="filters" role="tablist" aria-label="フィルター" id="filterContainer">
        <div class="pill" data-filter="all" role="tab" aria-selected="true" tabindex="0">
          <span>すべて</span>
        </div>
        <div class="pill" data-filter="saved" role="tab" aria-selected="false" tabindex="0">
          <span>保存済み</span>
          <span class="saved-count" id="savedCount">0</span>
        </div>
        <div class="pill" data-filter="electronics" role="tab" aria-selected="false" tabindex="0">
          <span>🔌 家電</span>
        </div>
        <div class="pill" data-filter="fashion" role="tab" aria-selected="false" tabindex="0">
          <span>👕 ファッション</span>
        </div>
        <div class="pill" data-filter="dining" role="tab" aria-selected="false" tabindex="0">
          <span>🍽️ グルメ</span>
        </div>
        <div class="pill" data-filter="transport" role="tab" aria-selected="false" tabindex="0">
          <span>🚇 交通</span>
        </div>
        <div class="pill" data-filter="nearby" role="tab" aria-selected="false" tabindex="0" title="現在地に基づいて並び替え">
          <span>📍 近く</span>
        </div>
      </div>
    </div>
    
    <!-- Settings 뷰 -->
    <div class="settings-view" id="settingsView">
      <div class="settings-section">
        <h3>言語設定</h3>
        <div class="settings-item">
          <span class="settings-label">表示言語</span>
          <select id="settingsLang" class="settings-btn">
            <option value="ja">日本語</option>
            <option value="ko">한국어</option>
            <option value="en">English</option>
            <option value="th">ภาษาไทย</option>
          </select>
        </div>
      </div>
      
      <div class="settings-section">
        <h3>表示設定</h3>
        <div class="settings-item">
          <span class="settings-label">ダークモード</span>
          <button id="settingsTheme" class="settings-btn">オフ</button>
        </div>
      </div>
      
      <div class="settings-section">
        <h3>データ管理</h3>
        <div class="settings-item">
          <span class="settings-label">キャッシュされたクーポン</span>
          <button id="clearCache" class="settings-btn">クリア</button>
        </div>
        <div class="settings-item">
          <span class="settings-label">保存済みクーポン</span>
          <button id="clearSaved" class="settings-btn danger">すべて削除</button>
        </div>
      </div>
      
      <div class="settings-section">
        <h3>アプリ情報</h3>
        <div class="settings-item">
          <span class="settings-label">バージョン</span>
          <span class="settings-value">1.0.0</span>
        </div>
        <div class="settings-item">
          <span class="settings-label">お問い合わせ</span>
          <a href="mailto:support@japankuru.com" class="settings-value" style="color:var(--primary);">support@japankuru.com</a>
        </div>
      </div>
    </div>

    <!-- 히어로 섹션 (개선된 카피) -->
    <section class="hero-section">
      <h1>일본 여행이 더 저렴해집니다</h1>
      <p>Bic Camera, BEAMS 등 인기 매장에서 즉시 할인을 받으세요. 회원가입 필요 없음。</p>
      <a href="#couponGrid" class="cta-button">人気店で割引を受ける</a>
    </section>

    <!-- 위치 에러 표시 -->
    <div class="location-error" id="locationError">
      <strong>現在地を使用できません</strong>
      <p>位置情報を利用するには、ブラウザの設定で許可してください。</p>
    </div>

    <!-- 지도 -->
    <div id="map" aria-label="クーポンマップ">
      <div id="mapError">
        <p>地図を読み込めませんでした</p>
        <button class="retry-btn" onclick="retryMap()">再試行</button>
      </div>
    </div>
    <div class="nearby-hint" id="nearbyHint">「近く」を押すと現在地に基づいてソートします。</div>

    <!-- 쿠폰 리스트 -->
    <div class="coupon-grid loading" id="couponGrid" aria-label="利用可能なクーポン">
      <!-- 스켈레톤 로딩 -->
      <div class="skeleton-card">
        <div class="skeleton skeleton-img"></div>
        <div class="skeleton-body">
          <div class="skeleton skeleton-line title"></div>
          <div class="skeleton skeleton-line desc"></div>
          <div class="skeleton skeleton-line short"></div>
        </div>
      </div>
      <div class="skeleton-card">
        <div class="skeleton skeleton-img"></div>
        <div class="skeleton-body">
          <div class="skeleton skeleton-line title"></div>
          <div class="skeleton skeleton-line desc"></div>
          <div class="skeleton skeleton-line short"></div>
        </div>
      </div>
      <div class="skeleton-card">
        <div class="skeleton skeleton-img"></div>
        <div class="skeleton-body">
          <div class="skeleton skeleton-line title"></div>
          <div class="skeleton skeleton-line desc"></div>
          <div class="skeleton skeleton-line short"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 스크린리더 알림 영역 -->
  <div id="sr-announcement" aria-live="polite" aria-atomic="true" class="sr-only"></div>

  <!-- 개선된 토스트 -->
  <div class="toast" id="toast" role="alert" aria-live="assertive"></div>

  <!-- 개선된 하단 네비게이션 (이벤트 위임) -->
  <nav class="bottom-nav" aria-label="ナビゲーション" id="navContainer">
    <a href="#" class="nav-item" data-view="home" tabindex="0" aria-selected="true" role="tab">
      <span class="nav-icon-wrapper">
        <svg class="icon-outline" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        <svg class="icon-filled" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 7.093v-3.093h-3v-2.093l-7-5.013-7 5.013v2.093h-3v3.093l3 2.143v11.764h14v-11.764l3-2.143zm-12 13.907v-8h4v8h-4z"></path></svg>
      </span>
      <span class="nav-text">ホーム</span>
    </a>
    <a href="#" class="nav-item" data-view="saved" tabindex="0" aria-selected="false" role="tab">
      <span class="nav-icon-wrapper">
        <svg class="icon-outline" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"></path></svg>
        <svg class="icon-filled" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 24l-7-6-7 6v-24h14v24z"></path></svg>
      </span>
      <span class="nav-text">保存済み</span>
      <span class="nav-badge" id="navBadge">0</span>
    </a>
    <a href="#" class="nav-item" data-view="map" tabindex="0" aria-selected="false" role="tab">
      <span class="nav-icon-wrapper">
        <svg class="icon-outline" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>
        <svg class="icon-filled" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-4.198 0-8 3.403-8 7.602 0 4.198 3.469 9.21 8 16.398 4.531-7.188 8-12.2 8-16.398 0-4.199-3.801-7.602-8-7.602zm0 11c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3z"></path></svg>
      </span>
      <span class="nav-text">マップ</span>
    </a>
    <a href="#" class="nav-item" data-view="settings" tabindex="0" aria-selected="false" role="tab">
      <span class="nav-icon-wrapper">
        <svg class="icon-outline" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
        <svg class="icon-filled" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19.438 11.163l-2.438-1.408v-2.755h-3v-2h-4v2h-3v2.755l-2.438 1.408-.562.915 2.438 1.409v2.849l-2.438 1.409.562.915 2.438-1.408v2.755h3v2h4v-2h3v-2.755l2.438-1.408.562-.915-2.438-1.409v-2.849zm-7.438 2.837c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3z"></path></svg>
      </span>
      <span class="nav-text">設定</span>
    </a>
  </nav>

  <script>
    'use strict';

    // ===========================================
    // 유틸리티 함수들
    // ===========================================
    const Utils = {
      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      },
      
      throttle(func, limit) {
        let inThrottle;
        return function() {
          const args = arguments;
          const context = this;
          if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
          }
        };
      },
      
      distance(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) ** 2 + 
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                  Math.sin(dLng/2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      },
      
      formatDate(dateStr) {
        if (dateStr === '9999-12-31') return T[LanguageManager.currentLang].noExpiry || '期限なし';
        return dateStr.replace(/-/g, '/');
      },
      
      daysTillExpiry(dateStr) {
        if (dateStr === '9999-12-31') return 999;
        const expiry = new Date(dateStr);
        const today = new Date();
        const days = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
        return days;
      },
      
      // HTML 이스케이프 함수 (보안)
      escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      },
      
      // URL 파라미터 업데이트
      updateUrlParam(key, value) {
        const url = new URL(window.location);
        if (value) {
          url.searchParams.set(key, value);
        } else {
          url.searchParams.delete(key);
        }
        window.history.replaceState({}, '', url);
      },
      
      // URL 파라미터 가져오기
      getUrlParam(key) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(key);
      }
    };

    // ===========================================
    // DOM 캐시 (성능 최적화)
    // ===========================================
    const DOMCache = {
      elements: {},
      
      init() {
        this.elements = {
          header: document.querySelector('.header'),
          langBtn: document.getElementById('langBtn'),
          langMenu: document.getElementById('langMenu'),
          searchInput: document.getElementById('searchInput'),
          searchClear: document.getElementById('searchClear'),
          filterContainer: document.getElementById('filterContainer'),
          navContainer: document.getElementById('navContainer'),
          couponGrid: document.getElementById('couponGrid'),
          locationError: document.getElementById('locationError'),
          map: document.getElementById('map'),
          mapError: document.getElementById('mapError'),
          nearbyHint: document.getElementById('nearbyHint'),
          toast: document.getElementById('toast'),
          savedCount: document.getElementById('savedCount'),
          navBadge: document.getElementById('navBadge'),
          srAnnouncement: document.getElementById('sr-announcement'),
          themeToggle: document.getElementById('themeToggle'),
          settingsView: document.getElementById('settingsView'),
          settingsLang: document.getElementById('settingsLang'),
          settingsTheme: document.getElementById('settingsTheme'),
          clearCache: document.getElementById('clearCache'),
          clearSaved: document.getElementById('clearSaved')
        };
      },
      
      get(key) {
        return this.elements[key];
      }
    };

    // ===========================================
    // 헤더 스크롤 관리자
    // ===========================================
    const HeaderManager = {
      lastScroll: 0,
      
      init() {
        window.addEventListener('scroll', Utils.throttle(() => {
          this.handleScroll();
        }, 100));
      },
      
      handleScroll() {
        const header = DOMCache.get('header');
        if (!header) return;
        
        const currentScroll = window.scrollY;
        
        if (currentScroll > this.lastScroll && currentScroll > 60) {
          // 스크롤 다운 - 헤더 숨기기
          header.classList.add('hidden');
        } else {
          // 스크롤 업 - 헤더 보이기
          header.classList.remove('hidden');
        }
        
        this.lastScroll = currentScroll;
      }
    };

    // ===========================================
    // 다국어 텍스트
    // ===========================================
    const T = {
      ja: {
        pageTitle: 'Japankuru クーポンウォレット',
        heroTitle: '일본 여행이 더 저렴해집니다',
        heroDesc: 'Bic Camera, BEAMS 등 인기 매장에서 즉시 할인을 받으세요. 회원가입 필요 없음。',
        ctaButton: '人気店で割引を受ける',
        searchPlaceholder: '店名・エリアで検索...',
        all: 'すべて',
        saved: '保存済み',
        electronics: '🔌 家電',
        fashion: '👕 ファッション', 
        dining: '🍽️ グルメ',
        transport: '🚇 交通',
        nearby: '📍 近く',
        home: 'ホーム',
        map: 'マップ',
        settings: '設定',
        languageChanged: '言語を変更しました',
        detailShow: '詳細を見る',
        backToList: 'リストに戻る',
        backButton: '← 戻る',
        closeDetail: '詳細を閉じる',
        copyCode: 'コードをコピー',
        copied: 'コピーしました',
        codeCopied: 'クーポンコードをコピーしました！',
        copyFailed: 'コピーに失敗しました。長押しして手動でコピーしてください。',
        saveCoupon: 'クーポンを保存',
        unsaveCoupon: 'クーポンの保存を解除',
        savedCoupon: '保存しました',
        unsavedCoupon: '保存を解除しました',
        locationError: '現在地を使用できません',
        locationObtained: '現在地を取得しました',
        locationDenied: '位置情報の取得を拒否されました',
        mapView: '地図で見る',
        mapShown: '地図を表示しました',
        mapViewTab: 'マップビュー',
        nearbySort: '現在地に基づく並び替え',
        noExpiry: '期限なし',
        store: '店舗',
        benefit: '特典',
        expiry: '有効期限',
        notFound: 'クーポンが見つかりません',
        notFoundDesc: '検索条件を変えてください',
        suggestions: ['渋谷', '新宿', '電気屋'],
        codeSelected: 'コードを選択しました',
        whyThisStore: '💬 なぜこの店？',
        daysLeft: 'あと{days}日',
        expiryWarning: '期限間近',
        darkMode: 'ダークモード',
        lightMode: 'ライトモード',
        filterChanged: 'フィルターを変更しました',
        cardFlipped: 'カードを裏返しました',
        focusRestored: 'フォーカスを復元しました',
        termsLabel: '利用条件',
        terms: ['타 할인과 중복 사용 불가', '일부 품목 제외', '계산 전에 제시해주세요', '1인 1회 한정'],
        openInGoogleMaps: 'Google Mapsで開く',
        officialWebsite: '公式サイト',
        viewSite: '見る',
        relatedArticle: '関連記事',
        readArticle: '記事を読む',
        errorLoadingCoupons: 'クーポン情報の取得に失敗しました。しばらくしてから再度お試しください。',
        cacheCleared: 'キャッシュをクリアしました',
        savedCouponsCleared: '保存済みクーポンをすべて削除しました',
        confirmClearSaved: '本当にすべての保存済みクーポンを削除しますか？',
        shareCoupon: '共有する'
      },
      
      ko: {
        pageTitle: 'Japankuru 쿠폰 월렛',
        heroTitle: '일본 여행이 더 저렴해집니다',
        heroDesc: 'Bic Camera, BEAMS 등 인기 매장에서 즉시 할인을 받으세요. 회원가입 필요 없음。',
        ctaButton: '인기 매장에서 할인받기',
        searchPlaceholder: '매장명・지역으로 검색...',
        all: '전체',
        saved: '저장됨',
        electronics: '🔌 가전',
        fashion: '👕 패션',
        dining: '🍽️ 맛집',
        transport: '🚇 교통',
        nearby: '📍 근처',
        home: '홈',
        map: '지도',
        settings: '설정',
        languageChanged: '언어가 변경되었습니다',
        detailShow: '상세 보기',
        backToList: '목록으로 돌아가기',
        backButton: '← 돌아가기',
        closeDetail: '상세 닫기',
        copyCode: '코드 복사',
        copied: '복사됨',
        codeCopied: '쿠폰 코드를 복사했습니다!',
        copyFailed: '복사에 실패했습니다. 길게 눌러서 수동으로 복사해주세요.',
        saveCoupon: '쿠폰 저장',
        unsaveCoupon: '쿠폰 저장 해제',
        savedCoupon: '저장했습니다',
        unsavedCoupon: '저장을 해제했습니다',
        locationError: '현재 위치를 사용할 수 없습니다',
        locationObtained: '현재 위치를 가져왔습니다',
        locationDenied: '위치 정보 접근이 거부되었습니다',
        mapView: '지도에서 보기',
        mapShown: '지도를 표시했습니다',
        mapViewTab: '지도 보기',
        nearbySort: '현재 위치 기준 정렬',
        noExpiry: '기한 없음',
        store: '매장',
        benefit: '혜택',
        expiry: '유효기한',
        notFound: '쿠폰을 찾을 수 없습니다',
        notFoundDesc: '검색 조건을 변경해보세요',
        suggestions: ['시부야', '신주쿠', '전자상가'],
        codeSelected: '코드를 선택했습니다',
        whyThisStore: '💬 왜 이 매장일까?',
        daysLeft: '{days}일 남음',
        expiryWarning: '만료 임박',
        darkMode: '다크모드',
        lightMode: '라이트모드',
        filterChanged: '필터를 변경했습니다',
        cardFlipped: '카드를 뒤집었습니다',
        focusRestored: '포커스를 복원했습니다',
        termsLabel: '이용 조건',
        terms: ['타 할인과 중복 사용 불가', '일부 품목 제외', '계산 전에 제시해주세요', '1인 1회 한정'],
        openInGoogleMaps: 'Google Maps에서 열기',
        officialWebsite: '공식 웹사이트',
        viewSite: '보기',
        relatedArticle: '관련 기사',
        readArticle: '기사 읽기',
        errorLoadingCoupons: '쿠폰 정보를 가져오는데 실패했습니다. 잠시 후 다시 시도해주세요.',
        cacheCleared: '캐시를 삭제했습니다',
        savedCouponsCleared: '저장된 쿠폰을 모두 삭제했습니다',
        confirmClearSaved: '정말로 모든 저장된 쿠폰을 삭제하시겠습니까?',
        shareCoupon: '共有する'
      },
      
      en: {
        pageTitle: 'Japankuru Coupon Wallet',
        heroTitle: 'Make Your Japan Trip More Affordable',
        heroDesc: 'Get instant discounts at popular stores like Bic Camera and BEAMS. No sign-up required.',
        ctaButton: 'Get Discounts at Popular Stores',
        searchPlaceholder: 'Search by store name or area...',
        all: 'All',
        saved: 'Saved',
        electronics: '🔌 Electronics',
        fashion: '👕 Fashion',
        dining: '🍽️ Dining',
        transport: '🚇 Transport', 
        nearby: '📍 Nearby',
        home: 'Home',
        map: 'Map',
        settings: 'Settings',
        languageChanged: 'Language changed',
        detailShow: 'Show Details',
        backToList: 'Back to List',
        backButton: '← Back',
        closeDetail: 'Close Details',
        copyCode: 'Copy Code',
        copied: 'Copied',
        codeCopied: 'Coupon code copied!',
        copyFailed: 'Copy failed. Please copy manually.',
        saveCoupon: 'Save Coupon',
        unsaveCoupon: 'Unsave Coupon',
        savedCoupon: 'Saved',
        unsavedCoupon: 'Unsaved',
        locationError: 'Cannot access location',
        locationObtained: 'Location obtained',
        locationDenied: 'Location access denied',
        mapView: 'View on Map',
        mapShown: 'Map displayed',
        mapViewTab: 'Map View',
        nearbySort: 'Sort by location',
        noExpiry: 'No Expiry',
        store: 'Store',
        benefit: 'Benefit',
        expiry: 'Expiry Date',
        notFound: 'No coupons found',
        notFoundDesc: 'Try changing your search criteria',
        suggestions: ['Shibuya', 'Shinjuku', 'Electronics'],
        codeSelected: 'Code selected',
        whyThisStore: '💬 Why this store?',
        daysLeft: '{days} days left',
        expiryWarning: 'Expiring Soon',
        darkMode: 'Dark Mode',
        lightMode: 'Light Mode',
        filterChanged: 'Filter changed',
        cardFlipped: 'Card flipped',
        focusRestored: 'Focus restored',
        termsLabel: 'Terms & Conditions',
        terms: ['Cannot be combined with other discounts', 'Some items excluded', 'Please present before payment', 'Limit once per person'],
        openInGoogleMaps: 'Open in Google Maps',
        officialWebsite: 'Official Website',
        viewSite: 'View',
        relatedArticle: 'Related Article',
        readArticle: 'Read Article',
        errorLoadingCoupons: 'Failed to load coupon information. Please try again later.',
        cacheCleared: 'Cache cleared',
        savedCouponsCleared: 'All saved coupons deleted',
        confirmClearSaved: 'Are you sure you want to delete all saved coupons?',
        shareCoupon: '共有する'
      },

      th: {
        pageTitle: 'Japankuru Coupon Wallet',
        heroTitle: 'ทำให้การเดินทางญี่ปุ่นของคุณประหยัดขึ้น',
        heroDesc: 'รับส่วนลดทันทีที่ร้านค้ายอดนิยมอย่าง Bic Camera และ BEAMS ไม่ต้องสมัครสมาชิก',
        ctaButton: 'รับส่วนลดที่ร้านยอดนิยม',
        searchPlaceholder: 'ค้นหาตามชื่อร้านหรือพื้นที่...',
        all: 'ทั้งหมด',
        saved: 'บันทึกแล้ว', 
        electronics: '🔌 อิเล็กทรอนิกส์',
        fashion: '👕 แฟชั่น',
        dining: '🍽️ อาหาร',
        transport: '🚇 การเดินทาง',
        nearby: '📍 ใกล้เคียง',
        home: 'หน้าแรก',
        map: 'แผนที่',
        settings: 'ตั้งค่า',
        languageChanged: 'เปลี่ยนภาษาแล้ว',
        detailShow: 'ดูรายละเอียด',
        backToList: 'กลับไปที่รายการ',
        backButton: '← กลับ',
        closeDetail: 'ปิดรายละเอียด',
        copyCode: 'คัดลอกโค้ด',
        copied: 'คัดลอกแล้ว',
        codeCopied: 'สำเนาโค้ดคูปองแล้ว!',
        copyFailed: 'การคัดลอกล้มเหลว กรุณาคัดลอกด้วยตนเอง',
        saveCoupon: 'บันทึกคูปอง',
        unsaveCoupon: 'ยกเลิกการบันทึก',
        savedCoupon: 'บันทึกแล้ว',
        unsavedCoupon: 'ยกเลิกการบันทึกแล้ว',
        locationError: 'ไม่สามารถเข้าถึงตำแหน่งได้',
        locationObtained: 'ได้รับตำแหน่งแล้ว',
        locationDenied: 'การเข้าถึงตำแหน่งถูกปฏิเสธ',
        mapView: 'ดูบนแผนที่',
        mapShown: 'แสดงแผนที่แล้ว',
        mapViewTab: 'มุมมองแผนที่',
        nearbySort: 'จัดเรียงตามตำแหน่ง',
        noExpiry: 'ไม่มีวันหมดอายุ',
        store: 'ร้าน',
        benefit: 'ผลประโยชน์',
        expiry: 'วันหมดอายุ',
        notFound: 'ไม่พบคูปอง',
        notFoundDesc: 'ลองเปลี่ยนเกณฑ์การค้นหา',
        suggestions: ['ชิบูย่า', 'ชินจูกุ', 'อิเล็กทรอนิกส์'],
        codeSelected: 'เลือกโค้ดแล้ว',
        whyThisStore: '💬 ทำไมร้านนี้?',
        daysLeft: 'เหลือ {days} วัน',
        expiryWarning: 'ใกล้หมดอายุ',
        darkMode: 'โหมดมืด',
        lightMode: 'โหมดสว่าง',
        filterChanged: 'เปลี่ยนตัวกรองแล้ว',
        cardFlipped: 'พลิกการ์ดแล้ว',
        focusRestored: 'คืนค่าโฟกัสแล้ว',
        termsLabel: 'เงื่อนไขการใช้งาน',
        terms: ['ไม่สามารถใช้ร่วมกับส่วนลดอื่น', 'ยกเว้นสินค้าบางรายการ', 'กรุณาแสดงก่อนชำระเงิน', 'จำกัด 1 ครั้งต่อคน'],
        openInGoogleMaps: 'เปิดใน Google Maps',
        officialWebsite: 'เว็บไซต์อย่างเป็นทางการ',
        viewSite: 'ดู',
        relatedArticle: 'บทความที่เกี่ยวข้อง',
        readArticle: 'อ่านบทความ',
        errorLoadingCoupons: 'ไม่สามารถโหลดข้อมูลคูปองได้ กรุณาลองใหม่อีกครั้ง',
        cacheCleared: 'ล้างแคชแล้ว',
        savedCouponsCleared: 'ลบคูปองที่บันทึกไว้ทั้งหมดแล้ว',
        confirmClearSaved: 'คุณแน่ใจหรือไม่ที่จะลบคูปองที่บันทึกไว้ทั้งหมด?',
        shareCoupon: '共有する'
      }
    };

    // ===========================================
    // 언어 관리자 (개선)
    // ===========================================
    const LanguageManager = {
      currentLang: 'ja',
      supportedLangs: ['ja', 'ko', 'en', 'th'],
      
      init() {
        this.currentLang = this.detectLanguage();
        this.initToggle();
        this.updatePageLanguage();
      },

      detectLanguage() {
        // 1. URL 파라미터 확인
        const urlLang = Utils.getUrlParam('lang');
        if (urlLang && this.supportedLangs.includes(urlLang)) {
          return urlLang;
        }

        // 2. localStorage 확인
        const savedLang = localStorage.getItem('preferredLang');
        if (savedLang && this.supportedLangs.includes(savedLang)) {
          return savedLang;
        }

        // 3. 브라우저 언어 확인
        const browserLang = navigator.language.slice(0, 2);
        if (this.supportedLangs.includes(browserLang)) {
          return browserLang;
        }

        return 'ja';
      },

      // 통합된 언어 토글 초기화 (키보드 내비게이션 포함)
      initToggle() {
        const langBtn = DOMCache.get('langBtn');
        const langMenu = DOMCache.get('langMenu');
        
        if (!langBtn || !langMenu) return;

        // 언어 버튼 클릭
        langBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggleMenu();
        });

        // 키보드 내비게이션
        langBtn.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.openMenu();
          }
        });

        // 메뉴 키보드 내비게이션
        langMenu.addEventListener('keydown', (e) => {
          this.handleMenuKeyboard(e);
        });

        // 메뉴 클릭 (이벤트 위임)
        langMenu.addEventListener('click', (e) => {
          const button = e.target.closest('button[role="menuitem"]');
          if (button) {
            const lang = button.dataset.lang;
            this.setLanguage(lang);
            this.closeMenu();
          }
        });

        // 외부 클릭시 메뉴 닫기
        document.addEventListener('click', () => {
          this.closeMenu();
        });

        // Escape 키로 닫기
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && langMenu.classList.contains('show')) {
            this.closeMenu();
            langBtn.focus();
          }
        });

        // 초기 활성 버튼 설정
        this.updateActiveMenuItem();
      },

      toggleMenu() {
        const langMenu = DOMCache.get('langMenu');
        if (langMenu.classList.contains('show')) {
          this.closeMenu();
        } else {
          this.openMenu();
        }
      },

      openMenu() {
        const langBtn = DOMCache.get('langBtn');
        const langMenu = DOMCache.get('langMenu');
        
        langMenu.classList.add('show');
        langBtn.setAttribute('aria-expanded', 'true');
        
        // 현재 언어 항목에 포커스
        const activeItem = langMenu.querySelector('[aria-selected="true"]');
        if (activeItem) {
          activeItem.focus();
        }
      },

      closeMenu() {
        const langBtn = DOMCache.get('langBtn');
        const langMenu = DOMCache.get('langMenu');
        
        langMenu.classList.remove('show');
        langBtn.setAttribute('aria-expanded', 'false');
      },

      handleMenuKeyboard(e) {
        const langMenu = DOMCache.get('langMenu');
        const items = Array.from(langMenu.querySelectorAll('button[role="menuitem"]'));
        const currentIndex = items.findIndex(item => item === document.activeElement);

        switch(e.key) {
          case 'ArrowDown':
            e.preventDefault();
            const nextIndex = (currentIndex + 1) % items.length;
            items[nextIndex].focus();
            break;
            
          case 'ArrowUp':
            e.preventDefault();
            const prevIndex = currentIndex <= 0 ? items.length - 1 : currentIndex - 1;
            items[prevIndex].focus();
            break;
            
          case 'Home':
            e.preventDefault();
            items[0].focus();
            break;
            
          case 'End':
            e.preventDefault();
            items[items.length - 1].focus();
            break;
            
          case 'Enter':
          case ' ':
            e.preventDefault();
            document.activeElement.click();
            break;
        }
      },

      setLanguage(lang) {
        if (!this.supportedLangs.includes(lang)) return;
        
        this.currentLang = lang;
        localStorage.setItem('preferredLang', lang);
        Utils.updateUrlParam('lang', lang);
        
        this.updatePageLanguage();
        this.updateActiveMenuItem();
        
        // 쿠폰 리스트 재렌더링
        if (window.app) {
          window.app.render();
        }
        
        Toast.show(T[lang].languageChanged || '언어가 변경되었습니다');
      },

      updateActiveMenuItem() {
        const langMenu = DOMCache.get('langMenu');
        const langBtn = DOMCache.get('langBtn');
        
        // 메뉴 아이템 업데이트
        langMenu.querySelectorAll('button[role="menuitem"]').forEach(btn => {
          const isActive = btn.dataset.lang === this.currentLang;
          btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
        
        // 버튼 텍스트 업데이트
        const langNames = {ja:'日本語',ko:'한국어',en:'English',th:'ภาษาไทย'};
        const langFlags = {ja:'🇯🇵',ko:'🇰🇷',en:'🇺🇸',th:'🇹🇭'};
        
        langBtn.querySelector('.lang-name').textContent = langNames[this.currentLang];
        langBtn.querySelector('.lang-flag').textContent = langFlags[this.currentLang];
      },

      updatePageLanguage() {
        // HTML lang 속성 업데이트
        document.documentElement.lang = this.currentLang;
        
        // 페이지 제목
        document.title = T[this.currentLang].pageTitle || 'Japankuru クーポンウォレット';
        
        // 네비게이션 텍스트 업데이트
        this.updateNavigation();
        
        // 필터 텍스트 업데이트  
        this.updateFilters();
        
        // 기타 UI 텍스트 업데이트
        this.updateStaticTexts();
      },

      updateNavigation() {
        const navItems = DOMCache.get('navContainer').querySelectorAll('.nav-item');
        const navLabels = ['home', 'saved', 'map', 'settings'];
        
        navItems.forEach((item, index) => {
          const textEl = item.querySelector('.nav-text');
          if (textEl && navLabels[index]) {
            textEl.textContent = T[this.currentLang][navLabels[index]] || '';
          }
        });
      },

      updateFilters() {
        const filterContainer = DOMCache.get('filterContainer');
        const filters = filterContainer.querySelectorAll('.pill');
        
        filters.forEach(pill => {
          const filter = pill.dataset.filter;
          const span = pill.querySelector('span:first-child');
          if (span && filter && T[this.currentLang][filter]) {
            span.textContent = T[this.currentLang][filter];
          }
        });
      },

      updateStaticTexts() {
        // 검색 placeholder
        const searchInput = DOMCache.get('searchInput');
        if (searchInput) {
          searchInput.placeholder = T[this.currentLang].searchPlaceholder || '店名・エリアで検索...';
        }

        // 히어로 섹션
        const heroTitle = document.querySelector('.hero-section h1');
        const heroDesc = document.querySelector('.hero-section p');
        const ctaBtn = document.querySelector('.cta-button');
        
        if (heroTitle) heroTitle.textContent = T[this.currentLang].heroTitle;
        if (heroDesc) heroDesc.textContent = T[this.currentLang].heroDesc;
        if (ctaBtn) ctaBtn.textContent = T[this.currentLang].ctaButton;
      }
    };

    // 쿠폰 필드 다국어 헬퍼 함수
    function getCouponField(coupon, field, fallback = '') {
      const langField = `${field}_${LanguageManager.currentLang}`;
      const jaField = `${field}_ja`;
      
      return coupon[langField] || coupon[jaField] || coupon[field] || fallback;
    }

    // ===========================================
    // 쿠폰 데이터 로더
    // ===========================================
    class CouponLoader {
      constructor(config = {}) {
        this.config = {
          retryAttempts: 3,
          retryDelay: 1000,
          timeout: 10000,
          ...config
        };
      }

      async loadFromAPI() {
        try {
          // WordPress API 엔드포인트 결정
          let apiUrl;
          
          if (window.wpApiSettings && window.wpApiSettings.root) {
            apiUrl = `${window.wpApiSettings.root}jkwallet/v1/coupons`;
          } else if (window.location.pathname.includes('/wp-admin/') || 
                     window.location.pathname.includes('/wp-content/')) {
            const baseUrl = window.location.origin;
            apiUrl = `${baseUrl}/wp-json/jkwallet/v1/coupons`;
          } else {
            apiUrl = './wp-json/jkwallet/v1/coupons';
          }

          console.log('API 요청:', apiUrl);
          
          const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              ...(window.wpApiSettings?.nonce && {
                'X-WP-Nonce': window.wpApiSettings.nonce
              })
            }
          });

          if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          
          if (!Array.isArray(data) || data.length === 0) {
            throw new Error('Invalid API response format');
          }

          this.cacheData(data);
          console.log(`✅ API에서 ${data.length}개 쿠폰 로드 성공`);
          
          return data;

        } catch (error) {
          console.warn('🔄 API 로드 실패, 캐시/폴백 데이터 시도:', error.message);
          
          // 사용자에게 에러 알림
          Toast.show(T[LanguageManager.currentLang].errorLoadingCoupons || 'クーポン情報の取得に失敗しました', 3000);
          
          const cached = this.getCachedData();
          if (cached) {
            console.log('📦 캐시된 데이터 사용');
            return cached;
          }
          
          console.log('⚠️  하드코딩 데이터 사용');
          return this.getFallbackData();
        }
      }

      getCachedData() {
        try {
          const cached = localStorage.getItem('cachedCoupons');
          const cacheTime = localStorage.getItem('cacheTime');
          
          if (cached && cacheTime) {
            const age = Date.now() - parseInt(cacheTime);
            const maxAge = 24 * 60 * 60 * 1000; // 24시간
            
            if (age < maxAge) {
              return JSON.parse(cached);
            } else {
              localStorage.removeItem('cachedCoupons');
              localStorage.removeItem('cacheTime');
            }
          }
        } catch (e) {
          console.error('캐시 로드 실패:', e);
        }
        return null;
      }

      cacheData(data) {
        try {
          localStorage.setItem('cachedCoupons', JSON.stringify(data));
          localStorage.setItem('cacheTime', Date.now().toString());
          console.log('💿 데이터 캐시 저장 완료');
        } catch (e) {
          console.warn('캐시 저장 실패:', e);
        }
      }

      getFallbackData() {
        return [
          { 
            id: 1, 
            store_ja: 'コジマ x ビックカメラ', 
            store_ko: '코지마 x 빅카메라',
            store_en: 'Kojima x BicCamera',
            store_th: 'โคจิมะ x บิกคาเมร่า',
            offer_ja: '最大 17% OFF', 
            offer_ko: '최대 17% 할인',
            offer_en: 'Up to 17% OFF',
            offer_th: 'ลดสูงสุด 17%',
            description_ja: '免税10% + 追加7%割引！最新の電子製品を安く。',
            description_ko: '면세 10% + 추가 7% 할인! 최신 전자제품을 저렴하게.',
            description_en: 'Tax-free 10% + Additional 7% discount! Latest electronics at great prices.',
            description_th: 'ปลอดภาษี 10% + ส่วนลดเพิ่ม 7%! อิเล็กทรอนิกส์ล่าสุดในราคาดี',
            category: 'electronics', 
            expiry: '2025-12-31', 
            image: 'https://japankuru.com/gld-kanri/data/uploads/2023/11/kojima%E8%8B%B1%E8%AA%9E%E7%89%88%E4%BC%81%E6%A5%AD%E6%9C%89_kojima_EN_B-2.jpg',
            code: 'JK-BIC2025', 
            lat: 35.6909, 
            lng: 139.7003, 
            rating: 4.2,
            terms: ['他の割引との併用不可', '一部商品を除く', 'お会計前にご提示ください', 'お一人様1回限り'],
            official_url: 'https://www.biccamera.com/',
            article_url: 'https://www.japankuru.com/jp/e1878.html'
          },
          { 
            id: 2, 
            store_ja: 'JINS', 
            store_ko: '진스',
            store_en: 'JINS',
            store_th: 'จินส์',
            offer_ja: '10% OFF', 
            offer_ko: '10% 할인',
            offer_en: '10% OFF',
            offer_th: 'ลด 10%',
            description_ja: '免税+割引のメガネ。',
            description_ko: '면세+할인 안경.',
            description_en: 'Tax-free + discount glasses.',
            description_th: 'แว่นตาปลอดภาษี+ลดราคา',
            category: 'fashion', 
            expiry: '2025-02-05', 
            image: 'https://japankuru.com/gld-kanri/data/uploads/2024/06/japankuru_1800-1200-1536x1024.jpg',
            code: 'JK-JINS2025', 
            lat: 35.6581, 
            lng: 139.6986, 
            rating: 4.1,
            terms: ['他の割引との併用不可', '一部商品を除く', 'お会計前にご提示ください', 'お一人様1回限り'],
            official_url: 'https://www.jins.com/jp/',
            article_url: 'https://www.japankuru.com/en/e2290.html'
          },
          { 
            id: 3, 
            store_ja: 'BEAMS JAPAN', 
            store_ko: 'BEAMS JAPAN',
            store_en: 'BEAMS JAPAN',
            store_th: 'บีมส์ ญี่ปุ่น',
            offer_ja: '5% 追加割引', 
            offer_ko: '5% 추가 할인',
            offer_en: '5% Additional Discount',
            offer_th: 'ส่วนลดเพิ่ม 5%',
            description_ja: 'トレンドを発信するセレクトショップ。',
            description_ko: '트렌드를 선도하는 셀렉트샵.',
            description_en: 'Trend-setting select shop.',
            description_th: 'ร้านเซเลกต์ที่นำเทรนด์',
            category: 'fashion', 
            expiry: '2025-09-30', 
            image: 'https://img.japankuru.com/prg_img/img/img2024011517461371466800.jpg',
            code: 'JK-BEAMS25', 
            lat: 35.6702, 
            lng: 139.7073, 
            rating: 4.3,
            terms: ['他の割引との併用不可', '一部商品を除く', 'お会計前にご提示ください', 'お一人様1回限り'],
            official_url: 'https://www.beams.co.jp/beamsjapan/',
            article_url: 'https://www.japankuru.com/jp/e2303.html'
          },
          { 
            id: 4, 
            store_ja: 'サムライレストラン', 
            store_ko: '사무라이 레스토랑',
            store_en: 'Samurai Restaurant',
            store_th: 'ร้านอาหารซามูไร',
            offer_ja: 'ドリンク1杯無料', 
            offer_ko: '음료 1잔 무료',
            offer_en: '1 Free Drink',
            offer_th: 'เครื่องดื่มฟรี 1 แก้ว',
            description_ja: '華麗なショーと食事。',
            description_ko: '화려한 쇼와 식사.',
            description_en: 'Spectacular show and dining.',
            description_th: 'การแสดงอลังการและอาหาร',
            recommendation_ja: 'Japankuruレビュー4.5点、旅行者に「一度は体験すべき」と人気急上昇！',
            recommendation_ko: 'Japankuru 리뷰 4.5점, 여행자들에게 "한 번은 경험해봐야 할" 곳으로 인기 급상승!',
            recommendation_en: 'Japankuru review 4.5 stars, rapidly gaining popularity among travelers as a "must-experience" destination!',
            recommendation_th: 'Japankuru รีวิว 4.5 ดาว ได้รับความนิยมอย่างรวดเร็วจากนักท่องเที่ยวในฐานะสถานที่ "ต้องลอง"!',
            category: 'dining', 
            expiry: '2026-03-31', 
            image: 'https://japankuru.com/gld-kanri/data/uploads/2024/06/%E4%BE%8D%E3%82%AF%E3%83%BC%E3%83%9D%E3%83%B3c-2_0_0-1536x864.jpeg',
            code: 'JK-SAMURAI', 
            lat: 35.6947, 
            lng: 139.7006, 
            rating: 4.5,
            terms: ['他の割引との併用不可', '一部商品を除く', 'お会計前にご提示ください', 'お一人様1回限り'],
            official_url: 'https://www.samurai-restaurant.com/',
            article_url: 'https://www.japankuru.com/jp/e2290.html'
          },
          { 
            id: 5, 
            store_ja: '東急線', 
            store_ko: '도큐선',
            store_en: 'Tokyu Line',
            store_th: 'โตเก็ยว ไลน์',
            offer_ja: '1日乗車券', 
            offer_ko: '1일 승차권',
            offer_en: '1-Day Pass',
            offer_th: 'บัตรโดยสาร 1 วัน',
            description_ja: '東京旅行の必須アイテム。',
            description_ko: '도쿄 여행의 필수 아이템.',
            description_en: 'Essential item for Tokyo travel.',
            description_th: 'สิ่งจำเป็นสำหรับการเดินทางโตเกียว',
            category: 'transport', 
            expiry: '9999-12-31', 
            image: 'https://japankuru.com/gld-kanri/data/uploads/2025/03/tokyu-cover-16-9-1-1536x864.png',
            code: 'JK-TOKYU', 
            lat: 35.6580, 
            lng: 139.7016, 
            rating: 4.0,
            terms: ['他の割引との併用不可', '一部商品を除く', 'お会計前にご提示ください', 'お一人様1回限り'],
            official_url: 'https://www.tokyu.co.jp/'
          },
          { 
            id: 6, 
            store_ja: 'ヨドバシカメラ', 
            store_ko: '요도바시카메라',
            store_en: 'Yodobashi Camera',
            store_th: 'โยโดบาชิคาเมร่า',
            offer_ja: '最大 15% OFF', 
            offer_ko: '최대 15% 할인',
            offer_en: 'Up to 15% OFF',
            offer_th: 'ลดสูงสุด 15%',
            description_ja: '免税10% + VISAカード決済で5%追加割引！',
            description_ko: '면세 10% + VISA 카드 결제 시 5% 추가 할인!',
            description_en: 'Tax-free 10% + Additional 5% discount with VISA card payment!',
            description_th: 'ปลอดภาษี 10% + ส่วนลดเพิ่ม 5% เมื่อชำระด้วยบัตร VISA!',
            category: 'electronics', 
            expiry: '2025-11-30', 
            image: 'https://img.japankuru.com/prg_img/thumbnail1/img2023112417190332724100.png',
            code: 'JK-Yodobashi', 
            lat: 35.6938, 
            lng: 139.7706, 
            rating: 4.4,
            terms: ['他の割引との併用不可', '一部商品を除く', 'お会計前にご提示ください', 'お一人様1回限り'],
            official_url: 'https://www.yodobashi.com/'
          }
        ];
      }
    }

    // ===========================================
    // 토스트 관리자 (개선)
    // ===========================================
    const Toast = {
      el: null,
      timeout: null,
      queue: [],
      
      init() {
        this.el = DOMCache.get('toast');
      },
      
      show(msg, duration = 2000) {
        // 기존 토스트 취소
        if (this.timeout) {
          clearTimeout(this.timeout);
          this.el.classList.remove('show');
        }
        
        // 새 메시지 표시
        this.el.textContent = msg;
        this.el.classList.add('show');
        
        this.timeout = setTimeout(() => {
          this.el.classList.remove('show');
          this.timeout = null;
        }, duration);
      }
    };

    // ===========================================
    // 저장소 관리자
    // ===========================================
    const StorageManager = {
      getSaved() {
        try {
          const saved = localStorage.getItem('savedCoupons');
          return saved ? JSON.parse(saved) : [];
        } catch (e) {
          console.error('저장된 쿠폰 로드 실패:', e);
          return [];
        }
      },
      
      setSaved(data) {
        try {
          localStorage.setItem('savedCoupons', JSON.stringify(data));
        } catch (e) {
          console.error('쿠폰 저장 실패:', e);
          Toast.show(T[LanguageManager.currentLang].copyFailed || '저장에 실패했습니다', 3000);
        }
      },
      
      getTheme() {
        return localStorage.getItem('darkMode') === 'true';
      },
      
      setTheme(isDark) {
        localStorage.setItem('darkMode', isDark.toString());
      }
    };

    // ===========================================
    // 위치 관리자
    // ===========================================
    const Location = {
      async request() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            Toast.show('位置情報が利用できません', 2000);
            reject(new Error('Geolocation not supported'));
            return;
          }
          
          navigator.geolocation.getCurrentPosition(
            pos => {
              const location = { 
                lat: pos.coords.latitude, 
                lng: pos.coords.longitude 
              };
              Toast.show(T[LanguageManager.currentLang].locationObtained || '現在地を取得しました', 1000);
              resolve(location);
            },
            err => {
              Toast.show(T[LanguageManager.currentLang].locationDenied || '位置情報の取得を拒否されました', 2000);
              reject(err);
            },
            { enableHighAccuracy: true, timeout: 10000 }
          );
        });
      },
      
      showError() {
        const errorEl = DOMCache.get('locationError');
        if (errorEl) {
          const lang = LanguageManager.currentLang;
          const strongEl = document.createElement('strong');
          strongEl.textContent = T[lang].locationError || '現在地を使用できません';
          
          const pEl = document.createElement('p');
          pEl.textContent = '位置情報を利用するには、ブラウザの設定で許可してください。';
          
          errorEl.innerHTML = '';
          errorEl.appendChild(strongEl);
          errorEl.appendChild(pEl);
          errorEl.classList.add('show');
        }
      },
      
      hideError() {
        const errorEl = DOMCache.get('locationError');
        if (errorEl) {
          errorEl.classList.remove('show');
        }
      }
    };

    // ===========================================
    // 지도 관리자 (재시도 로직 추가)
    // ===========================================
    const MapManager = {
      mapInstance: null,
      markerGroup: null, 
      leafletLoaded: false,
      initialized: false,
      initPromise: null,
      retryCount: 0,
      maxRetries: 3,
      
      showMap() {
        const mapEl = DOMCache.get('map');
        if (mapEl) {
          mapEl.classList.add('show');
        }
      },
      
      hideMap() {
        const mapEl = DOMCache.get('map');
        if (mapEl) {
          mapEl.classList.remove('show');
        }
      },
      
      async init() {
        if (this.initPromise) {
          return this.initPromise;
        }
        
        if (this.initialized) {
          this.showMap();
          return Promise.resolve();
        }
        
        this.initPromise = this._doInit();
        return this.initPromise;
      },
      
      async _doInit() {
        try {
          this.showMap();
          
          if (!window.L && !this.leafletLoaded) {
            await this.loadLeaflet();
          }
          
          if (!this.mapInstance) {
            const center = window.app?.state.userLocation ? 
              [window.app.state.userLocation.lat, window.app.state.userLocation.lng] : 
              [35.6804, 139.7690];
            
            this.mapInstance = window.mapInstance = L.map('map', { 
              zoomControl: true 
            }).setView(center, 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              maxZoom: 19,
              attribution: '&copy; OSM'
            }).addTo(this.mapInstance);
            
            this.hideError();
            this.initialized = true;
            this.retryCount = 0; // 성공시 리셋
          }
          
          this.renderMarkers();
        } catch (e) {
          this.showError();
          throw e;
        } finally {
          this.initPromise = null;
        }
      },
      
      async loadLeaflet() {
        return new Promise((resolve, reject) => {
          const css = document.createElement('link');
          css.rel = 'stylesheet';
          css.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
          document.head.appendChild(css);
          
          const script = document.createElement('script');
          script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
          script.onload = () => {
            this.leafletLoaded = true;
            resolve();
          };
          script.onerror = async () => {
            if (this.retryCount < this.maxRetries) {
              this.retryCount++;
              Toast.show(`地図の読み込みを再試行中... (${this.retryCount}/${this.maxRetries})`, 2000);
              
              // Exponential backoff
              await new Promise(r => setTimeout(r, Math.pow(2, this.retryCount) * 1000));
              return this.loadLeaflet();
            } else {
              Toast.show('地図の読み込みに失敗しました', 3000);
              reject(new Error('Failed to load Leaflet'));
            }
          };
          document.body.appendChild(script);
        });
      },
      
      renderMarkers() {
        if (!this.mapInstance || !this.initialized || !window.app) return;
        
        if (this.markerGroup) {
          this.markerGroup.clearLayers();
        } else {
          this.markerGroup = L.layerGroup().addTo(this.mapInstance);
        }
        
        // 사용자 위치 표시
        if (window.app.state.userLocation) {
          L.circleMarker([window.app.state.userLocation.lat, window.app.state.userLocation.lng], {
            radius: 8, 
            fillColor: '#2563eb', 
            color: '#fff', 
            weight: 2, 
            fillOpacity: 1
          }).addTo(this.markerGroup).bindPopup('現在地');
        }
        
        // 쿠폰 마커
        window.app.state.coupons.forEach(c => {
          if (c.lat != null && c.lng != null) {
            const marker = L.marker([c.lat, c.lng]);
            const store = getCouponField(c, 'store');
            const offer = getCouponField(c, 'offer');
            
            let popup = `<strong>${Utils.escapeHtml(store)}</strong><br>${Utils.escapeHtml(offer)}<br>`;
            popup += c.expiry === '9999-12-31' ? 
              (T[LanguageManager.currentLang].noExpiry || '期限なし') : 
              c.expiry.replace(/-/g,'/');
            
            if (window.app.state.userLocation) {
              const d = Utils.distance(window.app.state.userLocation.lat, window.app.state.userLocation.lng, c.lat, c.lng);
              popup += `<br>${d < 1 ? Math.round(d * 1000) + 'm' : d.toFixed(1) + 'km'}`;
            }
            
            marker.bindPopup(popup);
            marker.on('click', () => {
              const card = document.querySelector(`[data-id="${c.id}"]`);
              if (card) { 
                card.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                card.focus(); 
              }
            });
            marker.addTo(this.markerGroup);
          }
        });
      },
      
      centerTo(loc) {
        if (this.mapInstance && loc && loc.lat && loc.lng) {
          this.mapInstance.setView([loc.lat, loc.lng], 13);
        }
      },
      
      updateLocation() {
        this.renderMarkers();
        if (window.app?.state.userLocation) {
          this.centerTo(window.app.state.userLocation);
        }
      },
      
      showError() {
        const errorEl = DOMCache.get('mapError');
        if (errorEl) {
          errorEl.style.display = 'block';
        }
      },
      
      hideError() {
        const errorEl = DOMCache.get('mapError');
        if (errorEl) {
          errorEl.style.display = 'none';
        }
      }
    };

    // ===========================================
    // 이미지 레이지 로더 (IntersectionObserver)
    // ===========================================
    const ImageLazyLoader = {
      observer: null,
      
      init() {
        this.observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              if (img.dataset.src) {
                img.src = img.dataset.src;
                img.classList.add('loaded');
                this.observer.unobserve(img);
              }
            }
          });
        }, {
          rootMargin: '50px 0px',
          threshold: 0.01
        });
      },
      
      observe(img) {
        if (this.observer) {
          this.observer.observe(img);
        }
      },
      
      disconnect() {
        if (this.observer) {
          this.observer.disconnect();
        }
      }
    };

    // ===========================================
    // 포커스 매니저 (접근성)
    // ===========================================
    const FocusManager = {
      lastFocusedElement: null,
      
      saveFocus() {
        this.lastFocusedElement = document.activeElement;
      },
      
      restoreFocus() {
        if (this.lastFocusedElement && this.lastFocusedElement.focus) {
          this.lastFocusedElement.focus();
          
          // 스크린리더 알림
          const srAnnouncement = DOMCache.get('srAnnouncement');
          if (srAnnouncement) {
            srAnnouncement.textContent = T[LanguageManager.currentLang].focusRestored || 'フォーカスを復元しました';
          }
        }
      },
      
      trapFocus(container) {
        const focusableElements = container.querySelectorAll(
          'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'
        );
        
        const firstFocusable = focusableElements[0];
        const lastFocusable = focusableElements[focusableElements.length - 1];
        
        if (firstFocusable) {
          firstFocusable.focus();
        }
        
        container.addEventListener('keydown', (e) => {
          if (e.key === 'Tab') {
            if (e.shiftKey) {
              if (document.activeElement === firstFocusable) {
                e.preventDefault();
                lastFocusable.focus();
              }
            } else {
              if (document.activeElement === lastFocusable) {
                e.preventDefault();
                firstFocusable.focus();
              }
            }
          }
        });
      }
    };

    // ===========================================
    // 카드 생성 및 관련 함수들 (간결하게 정리)
    // ===========================================
    function createCard(coupon) {
      const card = document.createElement('div');
      card.className = 'card';
      card.setAttribute('data-id', coupon.id);
      card.setAttribute('tabindex', '0');
      card.setAttribute('role', 'button');
      
      const store = getCouponField(coupon, 'store');
      const offer = getCouponField(coupon, 'offer');
      
      card.setAttribute('aria-label', `${store}のクーポン: ${offer}`);
      card.setAttribute('aria-expanded', 'false');
      
      const cardInner = document.createElement('div');
      cardInner.className = 'card-inner';
      
      // 앞면 생성
      const cardFront = createCardFront(coupon, store, offer);
      
      // 뒷면 생성  
      const cardBack = createCardBack(coupon, store, offer);
      
      cardInner.appendChild(cardFront);
      cardInner.appendChild(cardBack);
      card.appendChild(cardInner);
      
      // 이벤트 리스너
      setupCardEvents(card);
      
      return card;
    }

    // 앞면 생성 (간결하게)
    function createCardFront(coupon, store, offer) {
      const cardFront = document.createElement('div');
      cardFront.className = 'card-face card-front';
      cardFront.setAttribute('aria-hidden', 'false');

      // 이미지
      const img = document.createElement('img');
      img.dataset.src = coupon.image;
      img.alt = store;
      img.loading = 'lazy';
      img.className = 'lazy';
      cardFront.appendChild(img);
      ImageLazyLoader.observe(img);

      // 할인 배지
      const offerBadge = document.createElement('div');
      offerBadge.className = 'offer-badge';
      offerBadge.textContent = offer;
      cardFront.appendChild(offerBadge);

      // 카드 바디
      const body = document.createElement('div');
      body.className = 'card-body';

      // 제목
      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = store;
      body.appendChild(title);

      // 설명 (짧게)
      const description = getCouponField(coupon, 'description');
      const desc = document.createElement('div');
      desc.className = 'desc';
      desc.textContent = description;
      body.appendChild(desc);

      // 지역 태그
      if (coupon.tags && Array.isArray(coupon.tags) && coupon.tags.length > 0) {
        const area = document.createElement('div');
        area.className = 'area';
        area.innerHTML = `📍 <span>${coupon.tags.join(', ')}</span>`;
        body.appendChild(area);
      }

      // 추천 이유 (rating 조건)
      const recommendation = getCouponField(coupon, 'recommendation');
      if (recommendation && coupon.rating >= 4.5) {
        const recWrapper = createRecommendationSection(recommendation);
        body.appendChild(recWrapper);
      }

      // 상세보기 버튼
      const detailBtn = document.createElement('button');
      detailBtn.className = 'btn btn-show-detail';
      detailBtn.textContent = T[LanguageManager.currentLang].detailShow || '詳細を見る';
      detailBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const card = detailBtn.closest('.card');
        flipCard(card, true);
      });
      body.appendChild(detailBtn);

      cardFront.appendChild(body);

      // 저장 버튼
      const saveBtn = createSaveButton(coupon.id);
      cardFront.appendChild(saveBtn);

      return cardFront;
    }

    // 뒷면 생성 (컴팩트하게)
    function createCardBack(coupon, store, offer) {
      const cardBack = document.createElement('div');
      cardBack.className = 'card-face card-back';
      cardBack.setAttribute('aria-hidden', 'true');

      const lang = LanguageManager.currentLang;

      // 헤더
      const header = document.createElement('div');
      header.className = 'back-header';
      
      const title = document.createElement('h3');
      title.textContent = store;
      header.appendChild(title);
      
      const closeBtn = document.createElement('button');
      closeBtn.className = 'close-btn';
      closeBtn.textContent = '✕';
      closeBtn.setAttribute('aria-label', T[lang].closeDetail || '詳細を閉じる');
      closeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const card = e.target.closest('.card');
        flipCard(card, false);
      });
      header.appendChild(closeBtn);
      
      cardBack.appendChild(header);

      // 바코드
      const barcodeSection = document.createElement('div');
      barcodeSection.className = 'barcode-section';
      const barcodeImg = document.createElement('img');
      barcodeImg.src = `https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(coupon.code)}&code=Code128&dpi=96`;
      barcodeImg.alt = `Barcode for ${coupon.code}`;
      barcodeSection.appendChild(barcodeImg);
      cardBack.appendChild(barcodeSection);

      // 정보 그리드
      const infoGrid = document.createElement('div');
      infoGrid.className = 'info-grid';

      // 혜택
      infoGrid.appendChild(createInfoItem(T[lang].benefit || '特典', offer));

      // 유효기한
      const expiryText = coupon.expiry === '9999-12-31' ? 
        T[lang].noExpiry || '期限なし' : 
        Utils.formatDate(coupon.expiry);
      infoGrid.appendChild(createInfoItem(T[lang].expiry || '有効期限', expiryText));

      // 설명
      const description = getCouponField(coupon, 'description');
      infoGrid.appendChild(createInfoItem('説明', description));

      // 이용조건 (첫번째만)
      if (coupon.terms && coupon.terms.length > 0) {
        const localizedTerm = T[lang].terms && T[lang].terms[0] ? T[lang].terms[0] : coupon.terms[0];
        infoGrid.appendChild(createInfoItem(T[lang].termsLabel || '利用条件', localizedTerm));
      }

      // 링크들
      if (coupon.lat != null && coupon.lng != null) {
        const mapLink = document.createElement('a');
        mapLink.href = `https://www.google.com/maps/search/?api=1&query=${coupon.lat},${coupon.lng}`;
        mapLink.target = '_blank';
        mapLink.rel = 'noopener';
        mapLink.textContent = T[lang].openInGoogleMaps || 'Google Maps';
        infoGrid.appendChild(createInfoItem(T[lang].mapView || '地図', mapLink.outerHTML));
      }

      if (coupon.official_url) {
        const link = document.createElement('a');
        link.href = coupon.official_url;
        link.target = '_blank';
        link.rel = 'noopener';
        link.textContent = T[lang].viewSite || '見る';
        infoGrid.appendChild(createInfoItem(T[lang].officialWebsite || '公式サイト', link.outerHTML));
      }

      cardBack.appendChild(infoGrid);

      // 복사 버튼
      const shareBtn = createShareButton(coupon);
      cardBack.appendChild(shareBtn);
      

      // 저장 버튼
      const saveBtn = createSaveButton(coupon.id);
      cardBack.appendChild(saveBtn);

      return cardBack;
    }

    // 정보 아이템 생성
    function createInfoItem(label, value) {
      const item = document.createElement('div');
      item.className = 'info-item';
      
      const labelEl = document.createElement('span');
      labelEl.className = 'info-label';
      labelEl.textContent = label;
      
      const valueEl = document.createElement('span');
      valueEl.className = 'info-value';
      
      // HTML 문자열인 경우 처리
      if (typeof value === 'string' && value.includes('<')) {
        valueEl.innerHTML = value;
      } else {
        valueEl.textContent = value;
      }
      
      item.appendChild(labelEl);
      item.appendChild(valueEl);
      
      return item;
    }

    function createRecommendationSection(recommendation) {
      const recWrapper = document.createElement('div');
      recWrapper.style.marginTop = '0.25rem';

      const recBtn = document.createElement('button');
      recBtn.className = 'btn btn-sm';
      recBtn.style.fontSize = '0.7rem';
      recBtn.style.padding = '3px 6px';
      recBtn.style.marginTop = '4px';
      recBtn.textContent = T[LanguageManager.currentLang].whyThisStore || '💬 なぜこの店？';

      const bubble = document.createElement('div');
      bubble.className = 'speech-bubble hidden';
      bubble.textContent = recommendation;

      recBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        bubble.classList.toggle('hidden');
      });

      recWrapper.appendChild(recBtn);
      recWrapper.appendChild(bubble);
      
      return recWrapper;
    }

    function createSaveButton(couponId) {
      const saveBtn = document.createElement('button');
      saveBtn.className = 'save';
      const isSaved = window.app?.state.saved.includes(couponId);
      saveBtn.setAttribute('aria-label', isSaved ? 
        (T[LanguageManager.currentLang].unsaveCoupon || 'クーポンの保存を解除') : 
        (T[LanguageManager.currentLang].saveCoupon || 'クーポンを保存'));
      saveBtn.textContent = isSaved ? '⭐' : '☆';
      if (isSaved) saveBtn.classList.add('saved');
      
      saveBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        toggleSave(couponId, saveBtn);
      });
      
      return saveBtn;
    }

    function createCopyButton(code) {
      const copyBtn = document.createElement('button');
      copyBtn.className = 'copy-btn';
      const lang = LanguageManager.currentLang;
      
      const span = document.createElement('span');
      span.textContent = `📋 ${T[lang].copyCode || 'コードをコピー'}`;
      copyBtn.appendChild(span);
      
      copyBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const success = await copyToClipboard(code);
        
        if (success) {
          Toast.show(T[lang].codeCopied || 'クーポンコードをコピーしました！', 2000);
          copyBtn.classList.add('success');
          setTimeout(() => {
            copyBtn.classList.remove('success');
          }, 2000);
        } else {
          Toast.show(T[lang].copyFailed || 'コピーに失敗しました', 3000);
        }
      });
      
      return copyBtn;
    }
    function createShareButton(coupon) {
    const shareBtn = document.createElement('button');
    shareBtn.className = 'share-btn';
    const lang = LanguageManager.currentLang;
    
    const span = document.createElement('span');
    span.textContent = `📤 ${T[lang].shareCoupon || '공유하기'}`;
    shareBtn.appendChild(span);
    
    shareBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        
        const shareUrl = `${window.location.origin}${window.location.pathname}?coupon=${coupon.id}&lang=${lang}`;
        const shareData = {
        title: getCouponField(coupon, 'store'),
        text: `${getCouponField(coupon, 'offer')} - ${getCouponField(coupon, 'description')}`,
        url: shareUrl
        };
        
        try {
        if (navigator.share && /Android|iPhone|iPad/i.test(navigator.userAgent)) {
            await navigator.share(shareData);
            Toast.show('공유되었습니다', 1500);
        } else {
            await navigator.clipboard.writeText(shareUrl);
            Toast.show('링크가 복사되었습니다', 2000);
        }
        } catch (err) {
        Toast.show('공유 실패', 2000);
        }
    });
    
    return shareBtn;
    }
    // 카드 플립 애니메이션
    function flipCard(card, show = true) {
      const cardFront = card.querySelector('.card-front');
      const cardBack = card.querySelector('.card-back');
      
      if (show) {
        card.classList.add('flipped');
        card.setAttribute('aria-expanded', 'true');
        cardFront.setAttribute('aria-hidden', 'true');
        cardBack.setAttribute('aria-hidden', 'false');
        
        // 포커스를 닫기 버튼으로
        setTimeout(() => {
          const closeBtn = cardBack.querySelector('.close-btn');
          if (closeBtn) closeBtn.focus();
        }, 300);
      } else {
        card.classList.remove('flipped');
        card.setAttribute('aria-expanded', 'false');
        cardFront.setAttribute('aria-hidden', 'false');
        cardBack.setAttribute('aria-hidden', 'true');
        FocusManager.restoreFocus();
      }
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (err) {
        try {
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.cssText = 'position:fixed;left:-999999px;';
          document.body.appendChild(textArea);
          textArea.select();
          const success = document.execCommand('copy');
          document.body.removeChild(textArea);
          return success;
        } catch {
          return false;
        }
      }
    }

    function setupCardEvents(card) {
      // 카드 클릭 이벤트
      card.addEventListener('click', (e) => {
        // 특정 요소 클릭은 무시
        if (e.target.closest('.save, .copy-btn, .close-btn, .btn-show-detail, .speech-bubble button, a')) {
          return;
        }
        
        const isFlipped = card.classList.contains('flipped');
        flipCard(card, !isFlipped);
      });
      
      // 키보드 접근성
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          if (!e.target.closest('.save, .copy-btn, .close-btn, .btn-show-detail')) {
            card.click();
          }
        }
      });
    }

    // 저장 토글
    function toggleSave(id, btn) {
      if (!window.app) return;
      
      const lang = LanguageManager.currentLang;
      
      if (window.app.state.saved.includes(id)) {
        window.app.state.saved = window.app.state.saved.filter(x => x !== id);
        Toast.show(T[lang].unsavedCoupon || '保存を解除しました');
        
        // saved 필터 중이면 바로 재적용
        if (window.app.state.currentFilter === 'saved') {
          window.app.applyFilters();
        }
      } else {
        window.app.state.saved.push(id);
        Toast.show(T[lang].savedCoupon || '保存しました');
      }
      
      // 모든 동일한 쿠폰의 저장 버튼 업데이트
      const card = document.querySelector(`[data-id="${id}"]`);
      if (card) {
        const saveBtns = card.querySelectorAll('.save');
        const isSaved = window.app.state.saved.includes(id);
        
        saveBtns.forEach(saveBtn => {
          saveBtn.textContent = isSaved ? '⭐' : '☆';
          if (isSaved) {
            saveBtn.classList.add('saved');
            saveBtn.setAttribute('aria-label', T[lang].unsaveCoupon || 'クーポンの保存を解除');
          } else {
            saveBtn.classList.remove('saved');
            saveBtn.setAttribute('aria-label', T[lang].saveCoupon || 'クーポンを保存');
          }
        });
      }
      
      // 로컬스토리지에 저장
      StorageManager.setSaved(window.app.state.saved);
      
      // 저장 카운트 업데이트
      window.app.updateSavedCount();
    }

    // ===========================================
    // 메인 애플리케이션 클래스 (최적화)
    // ===========================================
    class JKWalletApp {
      constructor() {
        this.state = {
          coupons: [],
          filtered: [],
          saved: [],
          userLocation: null,
          currentFilter: 'all',
          currentSearch: '',
          currentView: 'home',
          isLoading: true,
          hasError: false
        };
        
        this.config = {
          api: {
            retryAttempts: 3,
            retryDelay: 1000,
            timeout: 10000
          },
          performance: {
            pageSize: 20,
            renderThrottle: 16,
            searchDebounce: 300
          }
        };

        // 바인딩
        this.handleSearch = Utils.debounce(this.handleSearch.bind(this), this.config.performance.searchDebounce);
        this.handleResize = Utils.throttle(this.handleResize.bind(this), 250);
      }

      // 초기화 시퀀스
      async init() {
        try {
          // 1. DOM 캐시 초기화
          DOMCache.init();
          
          // 2. 유틸리티 초기화
          Toast.init();
          ImageLazyLoader.init();
          HeaderManager.init();
          
          // 3. 언어 시스템 초기화
          LanguageManager.init();
          
          // 4. URL 상태 복원
          this.restoreUrlState();
          
          // 5. 테마 로드
          this.loadTheme();
          
          // 6. 데이터 로드 (병렬)
          const [coupons, saved] = await Promise.all([
            this.loadCoupons(),
            this.loadSavedCoupons()
          ]);
          
          this.state.coupons = coupons;
          this.state.saved = saved;
          this.state.filtered = [...coupons];
          
          // 7. UI 초기화
          this.setupUI();
          
          // 8. 이벤트 리스너 설정
          this.setupEventListeners();
          
          // 9. 초기 렌더링
          this.state.isLoading = false;
          this.render();
          
          // 10. 저장 카운트 업데이트
          this.updateSavedCount();
          
          console.log('✅ JK Wallet 초기화 완료');
          
        } catch (error) {
          this.handleInitError(error);
        }
      }

      restoreUrlState() {
        // URL에서 상태 복원
        const filter = Utils.getUrlParam('filter');
        if (filter && ['all', 'saved', 'electronics', 'fashion', 'dining', 'transport', 'nearby'].includes(filter)) {
          this.state.currentFilter = filter;
        }
        
        const search = Utils.getUrlParam('q');
        if (search) {
          this.state.currentSearch = search;
          const searchInput = DOMCache.get('searchInput');
          if (searchInput) searchInput.value = search;
        }

        const couponId = Utils.getUrlParam('coupon');
         if (couponId) {
             setTimeout(() => {
              const card = document.querySelector(`[data-id="${couponId}"]`);
               if (card) {
               card.scrollIntoView({ behavior: 'smooth', block: 'center' });
             flipCard(card, true);
             Toast.show('공유된 쿠폰입니다', 2000);
         }
          }, 500);
         }
        }

      async loadCoupons() {
        const loader = new CouponLoader(this.config.api);
        return await loader.loadFromAPI();
      }

      async loadSavedCoupons() {
        return StorageManager.getSaved();
      }

      loadTheme() {
        const isDark = StorageManager.getTheme();
        if (isDark) document.body.classList.add('dark-mode');
      }

      setupUI() {
        // 필터 버튼 설정 (이벤트 위임)
        this.setupFilters();
        
        // 네비게이션 설정 (이벤트 위임)
        this.setupNavigation();
        
        // 검색 설정
        this.setupSearch();
        
        // 추천 검색어 이벤트 위임
        this.setupSuggestions();
      }

      setupEventListeners() {
        // 테마 토글
        DOMCache.get('themeToggle')?.addEventListener('click', () => {
          this.toggleTheme();
        });
        
        // Settings 이벤트 (Settings 뷰가 있을 때만)
        const settingsLang = DOMCache.get('settingsLang');
        if (settingsLang) {
          settingsLang.addEventListener('change', (e) => {
            LanguageManager.setLanguage(e.target.value);
          });
        }
        
        const settingsTheme = DOMCache.get('settingsTheme');
        if (settingsTheme) {
          settingsTheme.addEventListener('click', () => {
            this.toggleTheme();
            settingsTheme.textContent = document.body.classList.contains('dark-mode') ? 
              T[LanguageManager.currentLang].darkMode : T[LanguageManager.currentLang].lightMode;
          });
        }
        
        const clearCache = DOMCache.get('clearCache');
        if (clearCache) {
          clearCache.addEventListener('click', () => {
            localStorage.removeItem('cachedCoupons');
            localStorage.removeItem('cacheTime');
            Toast.show(T[LanguageManager.currentLang].cacheCleared || 'キャッシュをクリアしました');
          });
        }
        
        const clearSaved = DOMCache.get('clearSaved');
        if (clearSaved) {
          clearSaved.addEventListener('click', () => {
            const confirmMsg = T[LanguageManager.currentLang].confirmClearSaved || '本当にすべての保存済みクーポンを削除しますか？';
            if (confirm(confirmMsg)) {
              this.state.saved = [];
              StorageManager.setSaved([]);
              this.updateSavedCount();
              if (this.state.currentFilter === 'saved') {
                this.applyFilters();
              }
              Toast.show(T[LanguageManager.currentLang].savedCouponsCleared || '保存済みクーポンをすべて削除しました');
            }
          });
        }
        
        // 리사이즈 처리
        window.addEventListener('resize', this.handleResize);
      }

      setupFilters() {
        const filterContainer = DOMCache.get('filterContainer');
        
        // 이벤트 위임
        filterContainer.addEventListener('click', async (e) => {
          const pill = e.target.closest('.pill');
          if (pill) {
            const filter = pill.dataset.filter;
            await this.setFilter(filter);
          }
        });
        
        // 키보드 접근성
        filterContainer.addEventListener('keydown', (e) => {
          const pill = e.target.closest('.pill');
          if (pill && (e.key === 'Enter' || e.key === ' ')) {
            e.preventDefault();
            pill.click();
          }
        });
      }

      setupNavigation() {
        const navContainer = DOMCache.get('navContainer');
        
        // 이벤트 위임
        navContainer.addEventListener('click', async (e) => {
          e.preventDefault();
          const navItem = e.target.closest('.nav-item');
          if (navItem) {
            const view = navItem.dataset.view;
            await this.setView(view);
          }
        });
      }

      setupSearch() {
        const searchInput = DOMCache.get('searchInput');
        const searchClear = DOMCache.get('searchClear');
        
        if (searchInput) {
          searchInput.addEventListener('input', this.handleSearch);
        }
        
        if (searchClear) {
          searchClear.addEventListener('click', () => {
            searchInput.value = '';
            this.handleSearch({target: searchInput});
          });
        }
      }

      setupSuggestions() {
        // 이벤트 위임으로 동적 suggestion-chip 처리
        document.addEventListener('click', (e) => {
          const chip = e.target.closest('.suggestion-chip');
          if (chip) {
            const suggestion = chip.dataset.suggestion;
            if (suggestion) {
              const searchInput = DOMCache.get('searchInput');
              searchInput.value = suggestion;
              this.handleSearch({target: searchInput});
            }
          }
        });
      }

      async setFilter(filter) {
        if (this.state.isLoading) return;
        
        // UI 업데이트
        const filterContainer = DOMCache.get('filterContainer');
        filterContainer.querySelectorAll('.pill').forEach(p => {
          const isActive = p.dataset.filter === filter;
          if (isActive) {
            p.classList.add('active');
            p.setAttribute('aria-selected', 'true');
          } else {
            p.classList.remove('active');
            p.setAttribute('aria-selected', 'false');
          }
        });
        
        const prevFilter = this.state.currentFilter;
        this.state.currentFilter = filter;
        
        // URL 업데이트
        Utils.updateUrlParam('filter', filter === 'all' ? null : filter);
        
        try {
          // nearby 필터 특별 처리
          if (filter === 'nearby') {
            if (!this.state.userLocation) {
              await this.requestLocation();
            }
            await MapManager.init();
            MapManager.centerTo(this.state.userLocation);
            this.showNearbyHint();
          } else {
            this.hideNearbyHint();
            if (filter === 'all' || filter === 'saved') {
              MapManager.hideMap();
            }
          }
          
          this.applyFilters();
          Toast.show(T[LanguageManager.currentLang].filterChanged || 'フィルターを変更しました');
          
        } catch (error) {
          // 실패시 이전 필터로 복원
          this.state.currentFilter = prevFilter;
          filterContainer.querySelectorAll('.pill').forEach(p => {
            const isActive = p.dataset.filter === prevFilter;
            if (isActive) {
              p.classList.add('active');
              p.setAttribute('aria-selected', 'true');
            } else {
              p.classList.remove('active');
              p.setAttribute('aria-selected', 'false');
            }
          });
          
          if (filter === 'nearby') {
            Location.showError();
          }
        }
      }

      async setView(view) {
        if (this.state.currentView === view) return;
        
        // 네비게이션 UI 업데이트
        const navContainer = DOMCache.get('navContainer');
        navContainer.querySelectorAll('.nav-item').forEach(item => {
          const isActive = item.dataset.view === view;
          item.setAttribute('aria-selected', isActive ? 'true' : 'false');
          if (isActive) {
            item.classList.add('active');
          } else {
            item.classList.remove('active');
          }
        });
        
        this.state.currentView = view;
        
        // 뷰별 처리
        switch(view) {
          case 'home':
            this.hideSettings();
            await this.setFilter('all');
            MapManager.hideMap();
            break;
            
          case 'saved':
            this.hideSettings();
            await this.setFilter('saved');
            MapManager.hideMap();
            break;
            
          case 'map':
            this.hideSettings();
            await MapManager.init();
            MapManager.showMap();
            if (this.state.userLocation) {
              MapManager.centerTo(this.state.userLocation);
            }
            this.showNearbyHint();
            Toast.show(T[LanguageManager.currentLang].mapViewTab || 'マップビュー');
            break;
            
          case 'settings':
            this.showSettings();
            break;
        }
      }

      handleSearch(e) {
        this.state.currentSearch = e.target.value.trim();
        
        // 검색 클리어 버튼 표시
        const searchClear = DOMCache.get('searchClear');
        if (searchClear) {
          searchClear.classList.toggle('show', this.state.currentSearch.length > 0);
        }
        
        // URL 업데이트
        Utils.updateUrlParam('q', this.state.currentSearch || null);
        
        this.applyFilters();
      }

      applyFilters() {
        if (this.state.isLoading) return;
        
        let filtered = [...this.state.coupons];
        
        // 필터 적용
        switch(this.state.currentFilter) {
          case 'saved':
            filtered = filtered.filter(c => this.state.saved.includes(c.id));
            break;
            
          case 'nearby':
            if (this.state.userLocation) {
              filtered.sort((a, b) => {
                const distA = Utils.distance(this.state.userLocation.lat, this.state.userLocation.lng, a.lat, a.lng);
                const distB = Utils.distance(this.state.userLocation.lat, this.state.userLocation.lng, b.lat, b.lng);
                return distA - distB;
              });
            }
            break;
            
          case 'electronics':
          case 'fashion':
          case 'dining':
          case 'transport':
            filtered = filtered.filter(c => c.category === this.state.currentFilter);
            break;
        }
        
        // 검색어 적용
        if (this.state.currentSearch) {
          const query = this.state.currentSearch.toLowerCase();
          filtered = filtered.filter(c => {
            const store = getCouponField(c, 'store').toLowerCase();
            const description = getCouponField(c, 'description').toLowerCase();
            const category = c.category?.toLowerCase() || '';
            
            return store.includes(query) || 
                   description.includes(query) || 
                   category.includes(query);
          });
        }
        
        this.state.filtered = filtered;
        this.render();
      }

      render() {
        this.renderCoupons();
        this.updateUI();
      }

      renderCoupons() {
        const grid = DOMCache.get('couponGrid');
        if (!grid) return;
        
        // 로딩 상태 제거
        grid.classList.remove('loading');
        
        grid.innerHTML = '';
        
        if (this.state.filtered.length === 0) {
          this.renderNoResults();
          return;
        }
        
        const fragment = document.createDocumentFragment();
        this.state.filtered.forEach(coupon => {
          fragment.appendChild(createCard(coupon));
        });
        
        grid.appendChild(fragment);
      }

      renderNoResults() {
        const grid = DOMCache.get('couponGrid');
        const lang = LanguageManager.currentLang;
        const suggestions = T[lang].suggestions || ['渋谷', '新宿', '電気屋'];
        
        const noResults = document.createElement('div');
        noResults.className = 'no-results';
        
        const icon = document.createElement('div');
        icon.className = 'no-results-icon';
        icon.textContent = '🔍';
        
        const title = document.createElement('div');
        title.className = 'no-results-title';
        title.textContent = T[lang].notFound || 'クーポンが見つかりません';
        
        const desc = document.createElement('div');
        desc.className = 'no-results-desc';
        desc.textContent = T[lang].notFoundDesc || '検索条件を変えてください';
        
        const chips = document.createElement('div');
        chips.className = 'suggestion-chips';
        
        // 안전한 suggestion chip 생성
        suggestions.forEach(s => {
          const chip = document.createElement('button');
          chip.className = 'suggestion-chip';
          chip.dataset.suggestion = s;
          chip.textContent = s;
          chips.appendChild(chip);
        });
        
        noResults.appendChild(icon);
        noResults.appendChild(title);
        noResults.appendChild(desc);
        noResults.appendChild(chips);
        
        grid.appendChild(noResults);
      }

      updateUI() {
        // 지도 마커 업데이트
        if (window.mapInstance) {
          MapManager.renderMarkers();
        }
      }

      updateSavedCount() {
        const count = this.state.saved.length;
        
        // 필터 뱃지
        const savedCount = DOMCache.get('savedCount');
        if (savedCount) {
          savedCount.textContent = count;
          savedCount.classList.toggle('show', count > 0);
        }
        
        // 네비게이션 뱃지
        const navBadge = DOMCache.get('navBadge');
        if (navBadge) {
          navBadge.textContent = count;
          navBadge.classList.toggle('show', count > 0);
        }
      }

      async requestLocation() {
        if (this.state.isLoading) return;
        
        this.state.isLoading = true;
        
        try {
          this.state.userLocation = await Location.request();
          Location.hideError();
          
          // 지도 업데이트
          if (window.mapInstance) {
            MapManager.updateLocation();
          }
          
          // nearby 필터가 활성화되어 있으면 재정렬
          if (this.state.currentFilter === 'nearby') {
            this.applyFilters();
          }
          
        } catch (error) {
          Location.showError();
        } finally {
          this.state.isLoading = false;
        }
      }

      toggleTheme() {
        const isDark = document.body.classList.toggle('dark-mode');
        StorageManager.setTheme(isDark);
        
        const lang = LanguageManager.currentLang;
        Toast.show(isDark ? T[lang].darkMode : T[lang].lightMode, 1000);
      }

      // 에러 처리
      handleInitError(error) {
        console.error('초기화 실패:', error);
        this.state.hasError = true;
        this.showErrorState(error);
      }

      // UI 상태 관리
      showLoadingState() {
        document.body.classList.add('loading');
      }

      hideLoadingState() {
        document.body.classList.remove('loading');
      }

      showErrorState(error) {
        const grid = DOMCache.get('couponGrid');
        if (grid) {
          const errorDiv = document.createElement('div');
          errorDiv.style.cssText = 'grid-column:1/-1;text-align:center;padding:2rem;';
          
          const title = document.createElement('h2');
          title.textContent = '오류가 발생했습니다';
          
          const desc = document.createElement('p');
          desc.textContent = error.message;
          
          const retryBtn = document.createElement('button');
          retryBtn.className = 'btn btn-primary';
          retryBtn.textContent = '새로고침';
          retryBtn.onclick = () => location.reload();
          
          errorDiv.appendChild(title);
          errorDiv.appendChild(desc);
          errorDiv.appendChild(retryBtn);
          
          grid.innerHTML = '';
          grid.appendChild(errorDiv);
        }
      }

      showNearbyHint() {
        const hint = DOMCache.get('nearbyHint');
        if (hint) hint.classList.add('show');
      }

      hideNearbyHint() {
        const hint = DOMCache.get('nearbyHint');
        if (hint) hint.classList.remove('show');
      }

      showSettings() {
        // 쿠폰 그리드 숨기기
        const grid = DOMCache.get('couponGrid');
        const settingsView = DOMCache.get('settingsView');
        
        if (grid) grid.style.display = 'none';
        if (settingsView) {
          settingsView.classList.add('show');
          
          // 현재 설정 상태 업데이트
          const settingsLang = DOMCache.get('settingsLang');
          if (settingsLang) {
            settingsLang.value = LanguageManager.currentLang;
          }
          
          const settingsTheme = DOMCache.get('settingsTheme');
          if (settingsTheme) {
            settingsTheme.textContent = document.body.classList.contains('dark-mode') ? 
              T[LanguageManager.currentLang].darkMode : T[LanguageManager.currentLang].lightMode;
          }
        }
        
        // 지도 숨기기
        MapManager.hideMap();
        
        // 검색/필터 바 숨기기
        const searchFilterBar = document.querySelector('.search-filter-bar');
        if (searchFilterBar) searchFilterBar.style.display = 'none';
      }
      
      hideSettings() {
        const grid = DOMCache.get('couponGrid');
        const settingsView = DOMCache.get('settingsView');
        const searchFilterBar = document.querySelector('.search-filter-bar');
        
        if (grid) grid.style.display = '';
        if (settingsView) settingsView.classList.remove('show');
        if (searchFilterBar) searchFilterBar.style.display = '';
      }

      // 이벤트 핸들러
      handleResize() {
        // 반응형 처리
      }
    }

    // ===========================================
    // 전역 함수들 (호환성)
    // ===========================================
    window.retryMap = () => MapManager.init();
    window.getCouponField = getCouponField;

    // ===========================================
    // 초기화
    // ===========================================
    let app;

    document.addEventListener('DOMContentLoaded', async () => {
      app = new JKWalletApp();
      window.app = app; // 전역 접근용
      await app.init();
    });

    // ===========================================
    // Service Worker 등록 (PWA 지원)
    // ===========================================
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(err => {
          console.log('ServiceWorker registration failed:', err);
        });
      });
    }
  </script>
</body>
</html>
