<!--
WordPress ì—°ë™ì„ ìœ„í•œ PHP ì½”ë“œ (functions.phpì— ì¶”ê°€):

// 1. REST API ì—”ë“œí¬ì¸íŠ¸ ë“±ë¡
add_action('rest_api_init', function () {
    register_rest_route('jkwallet/v1', '/coupons', array(
        'methods' => 'GET',
        'callback' => 'get_jkwallet_coupons',
        'permission_callback' => '__return_true'
    ));
});

// 2. ì¿ í° ë°ì´í„° ë°˜í™˜ í•¨ìˆ˜
function get_jkwallet_coupons() {
    $coupons = [];
    
    // ACF Pro Repeater Fieldì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    if( have_rows('coupons', 'option') ) {
        while( have_rows('coupons', 'option') ) {
            the_row();
            $coupons[] = [
                'id' => get_sub_field('id'),
                'store' => get_sub_field('store'),
                'offer' => get_sub_field('offer'),
                'description' => get_sub_field('description'),
                'category' => get_sub_field('category'),
                'expiry' => get_sub_field('expiry'),
                'image' => get_sub_field('image'),
                'code' => get_sub_field('code'),
                'lat' => floatval(get_sub_field('lat')),
                'lng' => floatval(get_sub_field('lng')),
                'rating' => floatval(get_sub_field('rating'))
            ];
        }
    }
    
    return rest_ensure_response($coupons);
}

// 3. JavaScriptì— API ê²½ë¡œ ì „ë‹¬ (ê¶Œì¥)
function enqueue_jkwallet_scripts() {
    wp_enqueue_script('jkwallet', get_template_directory_uri() . '/js/jkwallet.js', [], '1.0', true);
    wp_localize_script('jkwallet', 'wpApiSettings', array(
        'root' => esc_url_raw(rest_url()),
        'nonce' => wp_create_nonce('wp_rest')
    ));
}
add_action('wp_enqueue_scripts', 'enqueue_jkwallet_scripts');
-->

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>Japankuru ã‚¯ãƒ¼ãƒãƒ³ã‚¦ã‚©ãƒ¬ãƒƒãƒˆ</title>

  <!-- ìµœì†Œ í•µì‹¬ ìŠ¤íƒ€ì¼ -->
  <style>
    :root {
      --primary:#2563eb;
      --bg:#f3f4f6;
      --card:#ffffff;
      --radius:.75rem;
      --shadow:0 4px 12px rgba(0,0,0,0.08);
      --text:#111827;
      --muted:#6b7280;
      --border:#d1d5db;
      --gray-100:#f3f4f6;
      --gray-700:#374151;
    }
    .dark-mode {
      --bg:#0f172a;
      --card:#1e293b;
      --text:#f1f5f9;
      --muted:#94a3b8;
      --border:#334155;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);line-height:1.4;min-height:100vh;padding-bottom:60px;transition:background .3s,color .3s;}
    .container{max-width:1000px;margin:0 auto;padding:0 1rem;}
    .header{display:flex;justify-content:space-between;align-items:center;padding:1rem 0;}
    .logo{font-weight:700;display:flex;align-items:center;gap:.5rem;font-size:1.25rem;color:var(--primary);}
    .btn{padding:.5rem 1rem;border:none;border-radius:.5rem;cursor:pointer;font-size:.9rem;display:inline-flex;align-items:center;gap:.25rem;transition:transform .2s;}
    .btn:hover{transform:scale(1.02);}
    .btn:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .btn-primary{background:var(--primary);color:#fff;}
    .search{margin:1rem 0;display:flex;gap:.5rem;flex-wrap:wrap;}
    .search input{flex:1;min-width:150px;padding:.75rem 1rem;border:1px solid var(--border);border-radius:.5rem;font-size:1rem;outline:none;background:var(--card);color:var(--text);transition:border-color .2s;}
    .search input:focus{border-color:var(--primary);}
    .filters{display:flex;gap:.5rem;overflow-x:auto;margin-bottom:1rem;-webkit-overflow-scrolling:touch;}
    .pill{padding:.5rem .75rem;border-radius:9999px;border:1px solid var(--border);background:var(--card);cursor:pointer;font-size:.75rem;display:flex;align-items:center;gap:4px;transition:all .2s;white-space:nowrap;}
    .pill:hover{transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,0,0,0.1);}
    .pill:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .pill.active{background:var(--primary);color:#fff;border-color:var(--primary);}
    .flex{display:flex;gap:1rem;flex-wrap:wrap;}
    .coupon-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;margin-top:0;}
    .card{background:var(--card);border-radius:var(--radius);overflow:visible;box-shadow:var(--shadow);position:relative;height:380px;font-size:.9rem;cursor:pointer;transition:transform .2s,box-shadow .2s;perspective:1000px;}
    .card:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,0.12);}
    .card:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .card.flipped .card-inner{transform:rotateY(180deg);}
    .card-inner{position:absolute;width:100%;height:100%;transform-style:preserve-3d;transition:transform .6s;}
    .card-face{position:absolute;width:100%;height:100%;-webkit-backface-visibility:hidden;backface-visibility:hidden;display:flex;flex-direction:column;border-radius:var(--radius);overflow:hidden;background:var(--card);}
    .card-front{background:var(--card);}
    .card-back{background:var(--card);transform:rotateY(180deg);padding:1.5rem;}
    .card img{width:100%;height:160px;object-fit:cover;display:block;}
    .card-body{padding:1rem;flex:1;display:flex;flex-direction:column;gap:.5rem;}
    .title{font-weight:700;font-size:1.1rem;margin-bottom:2px;}
    .offer{color:#dc2626;font-weight:700;margin:4px 0;}
    .desc{flex:1;color:var(--muted);font-size:.8rem;margin-bottom:4px;}
    .footer{display:flex;justify-content:space-between;font-size:.7rem;gap:.5rem;flex-wrap:wrap;}
    .badge{background:#f59e0b;color:#fff;padding:2px 6px;border-radius:4px;font-size:.6rem;display:inline-block;}
    .small{font-size:.65rem;color:var(--muted);}
    .save{position:absolute;top:8px;right:8px;background:#fff;border:none;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.2);transition:all .2s;z-index:20;pointer-events:all;font-size:1.25rem;-webkit-tap-highlight-color:transparent;}
    .save:hover{transform:scale(1.1);}
    .save:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .save.saved{background:#10b981;color:#fff;}
    .dark-mode .save{background:var(--card);color:var(--text);}
    .dark-mode .save.saved{background:#10b981;color:#fff;}
    .qr-section{text-align:center;margin-bottom:1rem;}
    .qr-code{font-size:3rem;margin:1rem 0;background:#f0f0f0;padding:1rem;border-radius:0.5rem;display:inline-block;}
    .coupon-code{font-size:1.5rem;font-weight:700;color:var(--primary);margin-top:.5rem;user-select:all;cursor:pointer;padding:.5rem;border-radius:.25rem;transition:background .2s;}
    .coupon-code:hover{background:var(--gray-100);}
    .dark-mode .coupon-code:hover{background:var(--gray-700);}
    .back-info{flex:1;}
    .info-item{margin-bottom:.75rem;font-size:.85rem;line-height:1.4;}
    .info-item strong{display:inline-block;min-width:80px;}
    .copy-btn{width:100%;padding:.75rem;background:var(--primary);color:#fff;border:none;border-radius:.5rem;font-size:1rem;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:.5rem;}
    .copy-btn:hover{background:#1d4ed8;}
    .copy-btn:focus{outline:2px solid var(--primary);outline-offset:2px;}
    #map{width:100%;height:260px;border-radius:12px;margin:1rem 0;overflow:hidden;position:relative;background:var(--card);border:1px solid var(--border);display:none;}
    #map.show{display:block;}
    #mapError{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:1000;}
    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 16px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.2);opacity:0;pointer-events:none;transition:all .3s;max-width:90vw;z-index:1000;}
    .toast.show{opacity:1;pointer-events:auto;}
    .dark-mode .toast{background:#fff;color:#111827;}
    /* --- ê¸°ì¡´ .bottom-nav, .nav-item ìŠ¤íƒ€ì¼ì„ ì•„ë˜ ì½”ë“œë¡œ êµì²´ --- */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--card);
  display: flex;
  justify-content: space-around;
  padding: 0.5rem 0;
  border-top: 1px solid var(--border);
  /* ê·¸ë¦¼ì íš¨ê³¼ ì¶”ê°€ë¡œ ì…ì²´ê° ë¶€ì—¬ */
  box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
  z-index: 1000;
}
.dark-mode .bottom-nav {
  box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px; /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ì‚¬ì´ ê°„ê²© */
  color: var(--muted);
  text-decoration: none;
  cursor: pointer;
  padding: 4px 12px;
  border-radius: 8px;
  transition: all 0.2s;
  flex: 1; /* ëª¨ë“  ì•„ì´í…œì´ ë™ì¼í•œ ë„ˆë¹„ë¥¼ ê°–ë„ë¡ í•¨ */
  text-align: center;
}

.nav-item svg {
  width: 22px; /* ì•„ì´ì½˜ í¬ê¸° */
  height: 22px;
  margin-bottom: 2px;
}

.nav-item span {
  font-size: 0.65rem; /* í…ìŠ¤íŠ¸ í¬ê¸° */
}

.nav-item:hover {
  color: var(--primary);
  background-color: rgba(37, 99, 235, 0.05); /* í˜¸ë²„ ì‹œ ë°°ê²½ìƒ‰ */
}
.dark-mode .nav-item:hover {
  background-color: rgba(59, 130, 246, 0.1);
}

.nav-item:focus {
  outline: 2px solid var(--primary);
  outline-offset: 2px;
}

.nav-item.active {
  color: var(--primary);
  font-weight: 600; /* í™œì„± íƒ­ í…ìŠ¤íŠ¸ êµµê²Œ */
}
/* --- ì—¬ê¸°ê¹Œì§€ êµì²´ --- */

    .nearby-hint{margin-top:.5rem;font-size:.75rem;color:var(--muted);display:none;}
    .nearby-hint.show{display:block;}
    .location-error{background:#fee;color:#dc2626;padding:.75rem;border-radius:.5rem;margin:1rem 0;font-size:.8rem;display:none;}
    .location-error.show{display:block;}
    .location-error p{margin-top:.25rem;font-size:.75rem;color:#991b1b;}
    .flex-center{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;}
    .toggle-theme{background:none;border:none;cursor:pointer;font-size:1rem;padding:4px;transition:transform .2s;}
    .toggle-theme:hover{transform:scale(1.1);}
    .toggle-theme:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .retry-btn{background:#ef4444;color:#fff;padding:.25rem .5rem;border:none;border-radius:.25rem;cursor:pointer;font-size:.75rem;margin-top:.5rem;}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
    .close-detail-btn{background:none;border:none;color:var(--primary);font-size:.9rem;padding:.5rem;cursor:pointer;margin-bottom:.5rem;display:flex;align-items:center;gap:.25rem;transition:opacity .2s;}
    .close-detail-btn:hover{opacity:0.8;}
    .close-detail-btn:focus{outline:2px solid var(--primary);outline-offset:2px;}
    @media (max-width: 800px){
      .coupon-grid{grid-template-columns:1fr;}
    }
    /* ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒ­ãƒ¼ãƒ€ãƒ¼ */
    .skeleton{background:linear-gradient(90deg,var(--card) 25%,var(--bg) 50%,var(--card) 75%);background-size:200% 100%;animation:loading 1.5s infinite;}
    @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
  
/* --- ã“ã“ã‹ã‚‰è¿½åŠ ã™ã‚‹CSS --- */

/* 1. ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.hero-section {
  text-align: center;
  padding: 2rem 1rem; /* ä¸Šä¸‹ã®ä½™ç™½ã‚’èª¿æ•´ã—ã¦ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
  background: linear-gradient(135deg, #4f46e5, #2563eb);
  color: #ffffff;
  margin-bottom: 2rem;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}

.hero-section h1 {
  font-size: 1.8rem; /* è¦‹å‡ºã—ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º */
  font-weight: 700;
  margin: 0 0 0.5rem 0; /* è¦‹å‡ºã—ã¨èª¬æ˜æ–‡ã®é–“ã«å°‘ã—ä½™ç™½ */
}

.hero-section p {
  font-size: 1rem; /* èª¬æ˜æ–‡ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º */
  margin: 0 0 1rem 0; /* èª¬æ˜æ–‡ã¨ãƒœã‚¿ãƒ³ã®é–“ã«ä½™ç™½ */
  opacity: 0.9;
}

.hero-section .cta-button {
  background-color: #ffffff;
  color: var(--primary);
  font-size: 1rem;
  font-weight: 700;
  padding: 0.75rem 1.5rem;
  border-radius: 9999px; /* ä¸¸ã„ãƒœã‚¿ãƒ³ */
  text-decoration: none;
  transition: all 0.2s ease-in-out;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  display: inline-block; /* ãƒœã‚¿ãƒ³ã¨ã—ã¦æ­£ã—ãè¡¨ç¤º */
}

.hero-section .cta-button:hover {
  transform: translateY(-2px) scale(1.05); /* ãƒ›ãƒãƒ¼æ™‚ã«å°‘ã—æµ®ãä¸ŠãŒã‚‹å‹•ã */
  box-shadow: 0 6px 16px rgba(0,0,0,0.2);
}


/* 2. ã€Œã”åˆ©ç”¨æ–¹æ³•ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.how-to-use {
  padding: 2rem 1rem;
  background-color: var(--card);
  border-radius: var(--radius);
  margin-bottom: 2rem;
  box-shadow: var(--shadow);
}

.how-to-use h2 {
  text-align: center;
  font-size: 1.75rem;
  margin-bottom: 1.5rem;
  color: var(--primary);
}

.how-to-use .steps {
  display: flex;
  justify-content: space-around;
  gap: 1.5rem;
  text-align: center;
}

.how-to-use .step {
  flex: 1;
}

.how-to-use .step-icon {
  font-size: 2.5rem;
  margin-bottom: 0.5rem;
  color: var(--primary);
}

.how-to-use .step h3 {
  font-size: 1.1rem;
  margin-bottom: 0.25rem;
}


/* 3. ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã®èª¿æ•´ */
@media (max-width: 768px) {
  .hero-section h1 {
    font-size: 1.5rem; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯å°‘ã—å°ã•ã */
  }

  .hero-section p {
    font-size: 0.9rem;
  }

  .how-to-use .steps {
    flex-direction: column; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ç¸¦ä¸¦ã³ã«ã™ã‚‹ */
  }
}

  </style>
</head>
<body>
  <div class="container">
    <header class="header" aria-label="ãƒ˜ãƒƒãƒ€ãƒ¼">
      <div class="logo" aria-label="JK Wallet">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M22.46,6C21.69,6.18 21.06,6.65 20.64,7.25C20.18,5.53 18.54,4.24 16.64,4.24C15.07,4.24 13.71,5.19 13.12,6.56C12.61,6.34 12.06,6.22 11.5,6.22C9.84,6.22 8.5,7.56 8.5,9.22C8.5,9.64 8.58,10.04 8.73,10.41C7.73,10.41 6.9,11.24 6.9,12.24V19.76C6.9,20.76 7.73,21.59 8.73,21.59H20.27C21.27,21.59 22.1,20.76 22.1,19.76V12.24C22.1,11.24 21.27,10.41 20.27,10.41H20.02C20.46,9.74 20.73,8.96 20.73,8.11C20.73,7.25 20.44,6.46 19.96,5.82C21.31,6.04 22.46,6.79 22.46,6Z"/>
        </svg>
        JK Wallet
      </div>
      <div class="flex-center">
        <button class="btn btn-primary" id="locateBtn" aria-label="ç¾åœ¨åœ°ã®è¿‘ãã‚’è¡¨ç¤º">è¿‘ãã‚’è¡¨ç¤º</button>
        <button class="toggle-theme" id="themeToggle" aria-label="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ“</button>
      </div>
    </header>
    <section class="hero-section">
        <h1>æ±äº¬æ—…è¡Œã€ã“ã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆä¸€ã¤ã§å®Œçµï¼</h1>
        <p>JapankuruãŒå³é¸ã—ãŸã€ã‚ãªãŸã ã‘ã®æ±äº¬å‰²å¼•ç‰¹å…¸</p>
        <a href="#couponGrid" class="cta-button">ä»Šã™ãã‚¯ãƒ¼ãƒãƒ³ã‚’ãƒã‚§ãƒƒã‚¯</a>
      </section>
    <div class="search" aria-label="æ¤œç´¢ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼">
      <input type="search" id="searchInput" placeholder="åº—åãƒ»ã‚¨ãƒªã‚¢ã§æ¤œç´¢..." aria-label="ã‚¯ãƒ¼ãƒãƒ³æ¤œç´¢" />
    </div>

    <div class="filters" role="tablist" aria-label="ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼">
      <div class="pill active" data-filter="all" role="tab" aria-selected="true" tabindex="0">ã™ã¹ã¦</div>
      <div class="pill" data-filter="saved" role="tab" aria-selected="false" tabindex="0">ä¿å­˜æ¸ˆã¿</div>
      <div class="pill" data-filter="electronics" role="tab" aria-selected="false" tabindex="0">å®¶é›»</div>
      <div class="pill" data-filter="fashion" role="tab" aria-selected="false" tabindex="0">ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³</div>
      <div class="pill" data-filter="dining" role="tab" aria-selected="false" tabindex="0">ã‚°ãƒ«ãƒ¡</div>
      <div class="pill" data-filter="transport" role="tab" aria-selected="false" tabindex="0">äº¤é€š</div>
      <div class="pill" data-filter="nearby" role="tab" aria-selected="false" tabindex="0">è¿‘ã</div>
    </div>

    <!-- ìœ„ì¹˜ ì—ëŸ¬ í‘œì‹œ -->
    <div class="location-error" id="locationError">
      <strong>ç¾åœ¨åœ°ã‚’ä½¿ç”¨ã§ãã¾ã›ã‚“</strong>
      <p>ä½ç½®æƒ…å ±ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <!-- ì§€ë„ -->
    <div id="map" aria-label="ã‚¯ãƒ¼ãƒãƒ³ãƒãƒƒãƒ—">
      <div id="mapError">
        <p>åœ°å›³ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</p>
        <button class="retry-btn" onclick="retryMap()">å†è©¦è¡Œ</button>
      </div>
    </div>
    <div class="nearby-hint" id="nearbyHint">ã€Œè¿‘ãã€ã‚’æŠ¼ã™ã¨ç¾åœ¨åœ°ã«åŸºã¥ã„ã¦ã‚½ãƒ¼ãƒˆã—ã¾ã™ã€‚</div>

    <!-- ì¿ í° ë¦¬ìŠ¤íŠ¸ -->
    <div class="coupon-grid" id="couponGrid" aria-label="åˆ©ç”¨å¯èƒ½ãªã‚¯ãƒ¼ãƒãƒ³"></div>
  </div>

  <!-- ìŠ¤í¬ë¦°ë¦¬ë” ì•Œë¦¼ ì˜ì—­ -->
  <div id="sr-announcement" aria-live="polite" aria-atomic="true" class="sr-only"></div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div class="toast" id="toast" role="alert" aria-live="assertive"></div>

  <!-- ê°„ë‹¨í•œ í•˜ë‹¨ ë‚´ë¹„ê²Œì´ì…˜ -->
<nav class="bottom-nav" aria-label="ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
    <a href="#" class="nav-item active" data-view="home" tabindex="0">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
      <span>ãƒ›ãƒ¼ãƒ </span>
    </a>
    <a href="#" class="nav-item" data-view="saved" tabindex="0">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"></path></svg>
      <span>ä¿å­˜æ¸ˆã¿</span>
    </a>
    <a href="#" class="nav-item" data-view="map" tabindex="0">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>
      <span>ãƒãƒƒãƒ—</span>
    </a>
    <a href="#" class="nav-item" data-view="settings" tabindex="0">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
      <span>è¨­å®š</span>
    </a>
  </nav>  

  <!-- ìµœì†Œ ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    // ìœ í‹¸ë¦¬í‹°
    const Utils = {
      // ë””ë°”ìš´ìŠ¤
      debounce(func, wait) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      },
      
      // ê±°ë¦¬ ê³„ì‚° (km)
      distance(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) ** 2 + 
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                  Math.sin(dLng/2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }
    };

    // ë‹¨ìˆœ ìƒíƒœ
    const State = {
      coupons: [],
      filtered: [],
      saved: [],
      userLocation: null,
      currentFilter: 'all',
      currentSearch: '',
      currentView: 'home', // home, map, saved, settings
      saveDebounce: null
    };

    // í† ìŠ¤íŠ¸
    const Toast = {
      el: document.getElementById('toast'),
      show(msg, duration = 2000) {
        this.el.textContent = msg;
        this.el.classList.add('show');
        setTimeout(() => this.el.classList.remove('show'), duration);
      }
    };

    // ì¿ í° ë°ì´í„° ë¡œë”
    const CouponLoader = {
      async loadFromAPI() {
        try {
          // WordPress REST API ì—”ë“œí¬ì¸íŠ¸ (ACF ë°ì´í„°)
          // TODO: WordPressì— ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ í›„ í™œì„±í™”
          
          // ë°©ë²• 1: ìƒëŒ€ ê²½ë¡œ (ì„œë¸Œë””ë ‰í† ë¦¬ ëŒ€ì‘)
          // const baseUrl = window.location.pathname.split('/').slice(0, -1).join('/');
          // const response = await fetch(`${baseUrl}/wp-json/jkwallet/v1/coupons`);
          
          // ë°©ë²• 2: ì ˆëŒ€ ê²½ë¡œ
          // const response = await fetch(`${window.location.origin}/wp-json/jkwallet/v1/coupons`);
          
          // ë°©ë²• 3: WordPress localize_scriptë¡œ ì „ë‹¬ëœ ê²½ë¡œ ì‚¬ìš© (ê¶Œì¥)
          // if (window.wpApiSettings) {
          //   const response = await fetch(`${window.wpApiSettings.root}jkwallet/v1/coupons`);
          // }
          
          // if (!response.ok) throw new Error('API Error');
          // const data = await response.json();
          // return data;
          
          // ì„ì‹œ: API êµ¬í˜„ ì „ê¹Œì§€ í•˜ë“œì½”ë”© ë°ì´í„° ì‚¬ìš©
          return couponData;
        } catch (error) {
          console.warn('API ë¡œë“œ ì‹¤íŒ¨, ë¡œì»¬ ë°ì´í„° ì‚¬ìš©:', error);
          // í´ë°±: ë¡œì»¬ ìºì‹œ í™•ì¸
          const cached = localStorage.getItem('cachedCoupons');
          if (cached) {
            try {
              return JSON.parse(cached);
            } catch (e) {
              console.error('ìºì‹œ íŒŒì‹± ì‹¤íŒ¨:', e);
            }
          }
          // ìµœì¢… í´ë°±: í•˜ë“œì½”ë”© ë°ì´í„°
          return couponData;
        }
      },
      
      cacheData(data) {
        try {
          localStorage.setItem('cachedCoupons', JSON.stringify(data));
          localStorage.setItem('cacheTime', Date.now().toString());
        } catch (e) {
          console.warn('ìºì‹œ ì €ì¥ ì‹¤íŒ¨:', e);
        }
      }
    };

    // ì¿ í° ë°ì´í„° (í•˜ë“œì½”ë”© - API ì‹¤íŒ¨ì‹œ í´ë°±ìš©)
    const couponData = [
      { id:1, store:'ã‚³ã‚¸ãƒ x ãƒ“ãƒƒã‚¯ã‚«ãƒ¡ãƒ©', offer:'æœ€å¤§ 17% OFF', description:'å…ç¨10% + è¿½åŠ 7%å‰²å¼•ï¼æœ€æ–°ã®é›»å­è£½å“ã‚’å®‰ãã€‚', category:'electronics', expiry:'2025-12-31', image:'https://japankuru.com/gld-kanri/data/uploads/2023/11/kojima%E8%8B%B1%E8%AA%9E%E7%89%88%E4%BC%81%E6%A5%AD%E6%9C%89_kojima_EN_B-2.jpg', code:'JK-BIC2025', lat:35.6909, lng:139.7003, rating:4.2 },
      { id:2, store:'JINS', offer:'10% OFF', description:'å…ç¨+å‰²å¼•ã®ãƒ¡ã‚¬ãƒã€‚', category:'fashion', expiry:'2025-07-30', image:'https://japankuru.com/gld-kanri/data/uploads/2024/06/japankuru_1800-1200-1536x1024.jpg', code:'JK-JINS2025', lat:35.6581, lng:139.6986, rating:4.1 },
      { id:3, store:'BEAMS JAPAN', offer:'5% è¿½åŠ å‰²å¼•', description:'ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ç™ºä¿¡ã™ã‚‹ã‚»ãƒ¬ã‚¯ãƒˆã‚·ãƒ§ãƒƒãƒ—ã€‚', category:'fashion', expiry:'2025-09-30', image:'https://img.japankuru.com/prg_img/img/img2024011517461371466800.jpg', code:'JK-BEAMS25', lat:35.6702, lng:139.7073, rating:4.3 },
      { id:4, store:'ã‚µãƒ ãƒ©ã‚¤ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³', offer:'ãƒ‰ãƒªãƒ³ã‚¯1æ¯ç„¡æ–™', description:'è¯éº—ãªã‚·ãƒ§ãƒ¼ã¨é£Ÿäº‹ã€‚', category:'dining', expiry:'2026-03-31', image:'https://japankuru.com/gld-kanri/data/uploads/2024/06/%E4%BE%8D%E3%82%AF%E3%83%BC%E3%83%9D%E3%83%B3c-2_0_0-1536x864.jpeg', code:'JK-SAMURAI', lat:35.6947, lng:139.7006, rating:4.5 },
      { id:5, store:'æ±æ€¥ç·š', offer:'1æ—¥ä¹—è»Šåˆ¸', description:'æ±äº¬æ—…è¡Œã®å¿…é ˆã‚¢ã‚¤ãƒ†ãƒ ã€‚', category:'transport', expiry:'9999-12-31', image:'https://japankuru.com/gld-kanri/data/uploads/2025/03/tokyu-cover-16-9-1-1536x864.png', code:'JK-TOKYU', lat:35.6580, lng:139.7016, rating:4.0 },
      { id:6, store:'ãƒ¨ãƒ‰ãƒã‚·ã‚«ãƒ¡ãƒ©', offer:'æœ€å¤§ 15% OFF', description:'å…ç¨10% + VISAã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆã§5%è¿½åŠ å‰²å¼•ï¼', category:'electronics', expiry:'2025-11-30', image:'https://img.japankuru.com/prg_img/thumbnail1/img2023112417190332724100.png', code:'JK-Yodobashi', lat:35.6938, lng:139.7706, rating:4.4 }
    ];

    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬
    const Storage = {
      load(key, defaultValue = []) {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : defaultValue;
        } catch (e) {
          console.error(`Failed to load ${key}:`, e);
          return defaultValue;
        }
      },
      
      save: Utils.debounce((key, data) => {
        try {
          localStorage.setItem(key, JSON.stringify(data));
        } catch (e) {
          console.error(`Failed to save ${key}:`, e);
          Toast.show('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 3000);
        }
      }, 100)
    };

    // í…Œë§ˆ ê´€ë¦¬
    const Theme = {
      load() {
        const isDark = StorageManager.getTheme();
        if (isDark) document.body.classList.add('dark-mode');
      },
      
      toggle() {
        const isDark = document.body.classList.toggle('dark-mode');
        StorageManager.setTheme(isDark);
        Toast.show(isDark ? t('darkMode') : t('lightMode'), 1000);
      }
    };

    // í•„í„°/ê²€ìƒ‰ ì ìš©
    function applyFilters() {
      let list = [...State.coupons];
      
      // í•„í„° ì ìš©
      if (State.currentFilter === 'saved') {
        list = list.filter(c => State.saved.includes(c.id));
      } else if (State.currentFilter === 'nearby' && State.userLocation) {
        list.sort((a, b) => {
          const da = Utils.distance(State.userLocation.lat, State.userLocation.lng, a.lat, a.lng);
          const db = Utils.distance(State.userLocation.lat, State.userLocation.lng, b.lat, b.lng);
          return da - db;
        });
      } else if (['electronics','fashion','dining','transport'].includes(State.currentFilter)) {
        list = list.filter(c => c.category === State.currentFilter);
      }
      
      // ê²€ìƒ‰ì–´ ì ìš©
      if (State.currentSearch) {
        const q = State.currentSearch.toLowerCase();
        list = list.filter(c => 
          c.store.toLowerCase().includes(q) ||
          c.description.toLowerCase().includes(q) ||
          (c.category && c.category.toLowerCase().includes(q))
        );
      }
      
      State.filtered = list;
      renderCoupons();
    }

    // ì €ì¥ì†Œ ê´€ë¦¬ (ì¼ê´€ì„± ê°œì„ )
    const StorageManager = {
      getSaved() {
        try {
          const saved = localStorage.getItem('savedCoupons');
          return saved ? JSON.parse(saved) : [];
        } catch (e) {
          console.error('ì €ì¥ëœ ì¿ í° ë¡œë“œ ì‹¤íŒ¨:', e);
          return [];
        }
      },
      
      setSaved(data) {
        try {
          localStorage.setItem('savedCoupons', JSON.stringify(data));
        } catch (e) {
          console.error('ì¿ í° ì €ì¥ ì‹¤íŒ¨:', e);
          Toast.show(t('saveFailed'), 3000);
        }
      },
      
      getTheme() {
        return localStorage.getItem('darkMode') === 'true';
      },
      
      setTheme(isDark) {
        localStorage.setItem('darkMode', isDark.toString());
      }
    };

    // ë‹¤êµ­ì–´ í…ìŠ¤íŠ¸
    const T = {
      ja: {
        detailShow: 'è©³ç´°ã‚’è¡¨ç¤º',
        backToList: 'ãƒªã‚¹ãƒˆã«æˆ»ã‚‹',
        backButton: 'â† æˆ»ã‚‹',
        closeDetail: 'è©³ç´°ã‚’é–‰ã˜ã‚‹',
        couponDetail: 'ã‚¯ãƒ¼ãƒãƒ³è©³ç´°ã‚’è¡¨ç¤ºä¸­',
        listReturned: 'ã‚¯ãƒ¼ãƒãƒ³ä¸€è¦§ã«æˆ»ã‚Šã¾ã—ãŸ',
        copyCode: 'ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼',
        copied: 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ',
        codeCopied: 'ã‚¯ãƒ¼ãƒãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼',
        copyFailed: 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é•·æŠ¼ã—ã—ã¦æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚',
        saveCoupon: 'ã‚¯ãƒ¼ãƒãƒ³ã‚’ä¿å­˜',
        unsaveCoupon: 'ã‚¯ãƒ¼ãƒãƒ³ã®ä¿å­˜ã‚’è§£é™¤',
        saved: 'ä¿å­˜ã—ã¾ã—ãŸ',
        unsaved: 'ä¿å­˜ã‚’è§£é™¤ã—ã¾ã—ãŸ',
        saveFailed: 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ',
        locationError: 'ç¾åœ¨åœ°ã‚’ä½¿ç”¨ã§ãã¾ã›ã‚“',
        locationErrorDetail: 'ä½ç½®æƒ…å ±ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚',
        mapView: 'åœ°å›³ã§è¦‹ã‚‹',
        mapShown: 'åœ°å›³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ',
        nearbySort: 'ç¾åœ¨åœ°ã«åŸºã¥ãä¸¦ã³æ›¿ãˆ',
        locationObtained: 'ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¾ã—ãŸ',
        locationDenied: 'ä½ç½®æƒ…å ±ã®å–å¾—ã‚’æ‹’å¦ã•ã‚Œã¾ã—ãŸ',
        mapLoadFailed: 'åœ°å›³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ',
        noExpiry: 'æœŸé™ãªã—',
        store: 'åº—èˆ—',
        benefit: 'ç‰¹å…¸',
        expiry: 'æœ‰åŠ¹æœŸé™',
        notFound: 'ã‚¯ãƒ¼ãƒãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ¤œç´¢æ¡ä»¶ã‚’å¤‰ãˆã¦ãã ã•ã„ã€‚',
        darkMode: 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰',
        lightMode: 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰',
        codeSelected: 'ã‚³ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¾ã—ãŸ',
        mapViewTab: 'ãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼'
      }
    };
    const currentLang = 'ja';
    const t = (key) => T[currentLang][key] || key;

    // ìŠ¤í¬ë¦°ë¦¬ë” ì•Œë¦¼
    function announceToScreenReader(message) {
      const announcement = document.getElementById('sr-announcement');
      if (announcement) {
        announcement.textContent = message;
        setTimeout(() => {
          announcement.textContent = '';
        }, 1000);
      }
    }

    // ì¿ í° ì¹´ë“œ ìƒì„±
    function createCard(coupon) {
      const card = document.createElement('div');
      card.className = 'card';
      card.setAttribute('data-id', coupon.id);
      card.setAttribute('tabindex', '0');
      card.setAttribute('role', 'button');
      card.setAttribute('aria-label', `${coupon.store}ã®ã‚¯ãƒ¼ãƒãƒ³: ${coupon.offer}`);
      card.setAttribute('aria-expanded', 'false');
      
      // ì¹´ë“œ ë‚´ë¶€ ì»¨í…Œì´ë„ˆ
      const cardInner = document.createElement('div');
      cardInner.className = 'card-inner';
      
      // ì•ë©´
      const cardFront = document.createElement('div');
      cardFront.className = 'card-face card-front';
      cardFront.setAttribute('aria-hidden', 'false');
      
      // ì´ë¯¸ì§€
      const img = document.createElement('img');
      img.src = coupon.image;
      img.alt = coupon.store;
      img.loading = 'lazy';
      cardFront.appendChild(img);
      
      // body
      const body = document.createElement('div');
      body.className = 'card-body';
      
      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = coupon.store;
      
      const offer = document.createElement('div');
      offer.className = 'offer';
      offer.textContent = coupon.offer;
      
      const desc = document.createElement('div');
      desc.className = 'desc';
      desc.textContent = coupon.description;
      
      const footer = document.createElement('div');
      footer.className = 'footer';
      
      const expiry = document.createElement('div');
      expiry.className = 'small';
      expiry.textContent = coupon.expiry === '9999-12-31' ? t('noExpiry') : coupon.expiry.replace(/-/g,'/');
      
      const dist = document.createElement('div');
      dist.className = 'small';
      if (State.userLocation) {
        const d = Utils.distance(State.userLocation.lat, State.userLocation.lng, coupon.lat, coupon.lng);
        dist.textContent = d < 1 ? `${Math.round(d * 1000)}m` : `${d.toFixed(1)}km`;
      }
      
      footer.appendChild(expiry);
      if (State.userLocation) footer.appendChild(dist);
      
      body.appendChild(title);
      body.appendChild(offer);
      body.appendChild(desc);
      body.appendChild(footer);
      cardFront.appendChild(body);
      
      // ì €ì¥ ë²„íŠ¼
      const saveBtn = document.createElement('button');
      saveBtn.className = 'save';
      saveBtn.setAttribute('aria-label', State.saved.includes(coupon.id) ? t('unsaveCoupon') : t('saveCoupon'));
      saveBtn.innerHTML = State.saved.includes(coupon.id) ? 'â˜…' : 'â˜†';
      if (State.saved.includes(coupon.id)) saveBtn.classList.add('saved');
      
      saveBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        toggleSave(coupon.id, saveBtn);
      });
      
      cardFront.appendChild(saveBtn);
      
      // ë’·ë©´
      const cardBack = document.createElement('div');
      cardBack.className = 'card-face card-back';
      cardBack.setAttribute('aria-hidden', 'true');
      
      // ë‹«ê¸° ë²„íŠ¼ ì¶”ê°€
      const closeBtn = document.createElement('button');
      closeBtn.className = 'close-detail-btn';
      closeBtn.innerHTML = t('backButton');
      closeBtn.setAttribute('aria-label', t('closeDetail'));
      closeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        card.classList.remove('flipped');
        card.setAttribute('aria-expanded', 'false');
        cardFront.setAttribute('aria-hidden', 'false');
        cardBack.setAttribute('aria-hidden', 'true');
        Toast.show(t('backToList'), 500);
        announceToScreenReader(t('listReturned'));
      });
      
      cardBack.appendChild(closeBtn);
      
      const qrSection = document.createElement('div');
      qrSection.className = 'qr-section';
      
      // QR ì½”ë“œ ëŒ€ì‹  í° ì¿ í° ì½”ë“œ í‘œì‹œ
      const qrCode = document.createElement('div');
      qrCode.className = 'qr-code';
      qrCode.style.fontSize = '4rem';
      qrCode.style.background = '#f0f0f0';
      qrCode.style.padding = '1rem';
      qrCode.style.borderRadius = '0.5rem';
      qrCode.innerHTML = 'ğŸ«';
      
      const couponCode = document.createElement('div');
      couponCode.className = 'coupon-code';
      couponCode.style.fontSize = '1.5rem';
      couponCode.style.userSelect = 'all';
      couponCode.textContent = coupon.code;
      
      // ì½”ë“œ í´ë¦­ì‹œ ì„ íƒë˜ë„ë¡
      couponCode.addEventListener('click', (e) => {
        e.stopPropagation();
        const selection = window.getSelection();
        const range = document.createRange();
        range.selectNodeContents(couponCode);
        selection.removeAllRanges();
        selection.addRange(range);
        Toast.show(t('codeSelected'), 1000);
      });
      
      qrSection.appendChild(qrCode);
      qrSection.appendChild(couponCode);
      
      const backInfo = document.createElement('div');
      backInfo.className = 'back-info';
      
      const storeInfo = document.createElement('div');
      storeInfo.className = 'info-item';
      storeInfo.innerHTML = `<strong>${t('store')}:</strong> ${coupon.store}`;
      
      const offerInfo = document.createElement('div');
      offerInfo.className = 'info-item';
      offerInfo.innerHTML = `<strong>${t('benefit')}:</strong> ${coupon.offer}`;
      
      const expiryInfo = document.createElement('div');
      expiryInfo.className = 'info-item';
      expiryInfo.innerHTML = `<strong>${t('expiry')}:</strong> ${coupon.expiry === '9999-12-31' ? t('noExpiry') : coupon.expiry}`;
      
      // åœ°å›³ãƒªãƒ³ã‚¯è¿½åŠ 
      const mapLink = document.createElement('div');
      mapLink.className = 'info-item';
      mapLink.style.cursor = 'pointer';
      mapLink.style.color = 'var(--primary)';
      mapLink.innerHTML = `<strong>ğŸ“ ${t('mapView')}</strong>`;
      mapLink.addEventListener('click', async (e) => {
        e.stopPropagation();
        await MapManager.init();
        MapManager.centerTo({lat: coupon.lat, lng: coupon.lng});
        card.classList.remove('flipped');
        Toast.show(t('mapShown'), 1000);
      });
      
      backInfo.appendChild(storeInfo);
      backInfo.appendChild(offerInfo);
      backInfo.appendChild(expiryInfo);
      backInfo.appendChild(mapLink);
      
      const copyBtn = document.createElement('button');
      copyBtn.className = 'copy-btn';
      copyBtn.innerHTML = `ğŸ“‹ ${t('copyCode')}`;
      copyBtn.setAttribute('aria-label', t('copyCode'));
      copyBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        try {
          await navigator.clipboard.writeText(coupon.code);
          Toast.show(t('codeCopied'), 2000);
          copyBtn.innerHTML = `âœ… ${t('copied')}`;
          setTimeout(() => {
            copyBtn.innerHTML = `ğŸ“‹ ${t('copyCode')}`;
          }, 2000);
        } catch (err) {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          const textArea = document.createElement('textarea');
          textArea.value = coupon.code;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand('copy');
            Toast.show(t('codeCopied'), 2000);
          } catch {
            Toast.show(t('copyFailed'), 3000);
          }
          document.body.removeChild(textArea);
        }
      });
      
      cardBack.appendChild(qrSection);
      cardBack.appendChild(backInfo);
      cardBack.appendChild(copyBtn);
      
      // ì¹´ë“œ ì¡°ë¦½
      cardInner.appendChild(cardFront);
      cardInner.appendChild(cardBack);
      card.appendChild(cardInner);
      
      // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ (cardInnerì— ë°”ì¸ë”©)
      cardInner.addEventListener('click', (e) => {
        // ë³µì‚¬ ë²„íŠ¼ì´ë‚˜ ì§€ë„ ë§í¬ í´ë¦­ì€ ë¬´ì‹œ
        if (e.target.closest('.copy-btn') || e.target.closest('.info-item')) {
          return;
        }
        
        // ì¹´ë“œ ë’¤ì§‘ê¸°
        card.classList.toggle('flipped');
        const isFlipped = card.classList.contains('flipped');
        card.setAttribute('aria-expanded', isFlipped.toString());
        
        cardFront.setAttribute('aria-hidden', isFlipped.toString());
        cardBack.setAttribute('aria-hidden', (!isFlipped).toString());
        
        if (isFlipped) {
          Toast.show(t('detailShow'), 1000);
          announceToScreenReader(t('couponDetail'));
        } else {
          Toast.show(t('backToList'), 1000);
          announceToScreenReader(t('listReturned'));
        }
        
        // ì§€ë„ ì„¼í„°ë§ (ì•ë©´ì¼ ë•Œë§Œ)
        if (!isFlipped && coupon.lat && coupon.lng && window.mapInstance) {
          MapManager.centerTo({lat: coupon.lat, lng: coupon.lng});
        }
      });
      
      // í‚¤ë³´ë“œ ì ‘ê·¼ì„±
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          // í¬ì»¤ìŠ¤ê°€ ì €ì¥ ë²„íŠ¼ì— ìˆì§€ ì•Šì„ ë•Œë§Œ ì¹´ë“œ ë’¤ì§‘ê¸°
          if (!e.target.closest('.save')) {
            cardInner.click();
          }
        }
      });
      
      return card;
    }

    // ì €ì¥ í† ê¸€
    function toggleSave(id, btn) {
      if (State.saved.includes(id)) {
        State.saved = State.saved.filter(x => x !== id);
        btn.innerHTML = 'â˜†';
        btn.classList.remove('saved');
        btn.setAttribute('aria-label', t('saveCoupon'));
        Toast.show(t('unsaved'));
        
        // saved í•„í„° ì¤‘ì´ë©´ ë°”ë¡œ ì¬ì ìš©
        if (State.currentFilter === 'saved') {
          applyFilters();
        }
      } else {
        State.saved.push(id);
        btn.innerHTML = 'â˜…';
        btn.classList.add('saved');
        btn.setAttribute('aria-label', t('unsaveCoupon'));
        Toast.show(t('saved'));
      }
      
      // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
      StorageManager.setSaved(State.saved);
    }

    // ë Œë”ë§ (ì„±ëŠ¥ ìµœì í™” ì¤€ë¹„)
    const RenderManager = {
      pageSize: 20,
      currentPage: 0,
      isLoading: false,
      
      renderPage(coupons, page = 0) {
        const start = page * this.pageSize;
        const end = start + this.pageSize;
        const pageCoupons = coupons.slice(start, end);
        
        const grid = document.getElementById('couponGrid');
        if (page === 0) {
          grid.innerHTML = '';
        }
        
        const fragment = document.createDocumentFragment();
        pageCoupons.forEach(c => {
          fragment.appendChild(createCard(c));
        });
        grid.appendChild(fragment);
        
        this.currentPage = page;
        return pageCoupons.length === this.pageSize;
      }
    };
    
    // ë Œë”ë§
    function renderCoupons() {
      const grid = document.getElementById('couponGrid');
      grid.innerHTML = '';
      
      if (State.filtered.length === 0) {
        grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--muted);">
          ${t('notFound')}
        </div>`;
        return;
      }
      
      // TODO: ì„±ëŠ¥ ìµœì í™” - ì¿ í°ì´ ë§ì„ ê²½ìš°
      // 1. Virtual Scrolling êµ¬í˜„ (Intersection Observer í™œìš©)
      // 2. í˜ì´ì§€ë„¤ì´ì…˜ (20ê°œì”© ë¡œë“œ)
      // 3. RequestAnimationFrameìœ¼ë¡œ ë Œë”ë§ ìµœì í™”
      
      // í˜„ì¬ëŠ” ì „ì²´ ë Œë”ë§ (ì¿ í°ì´ ì ì„ ë•ŒëŠ” ë¬¸ì œ ì—†ìŒ)
      if (State.filtered.length > 100) {
        // ë§ì€ ê²½ìš° ì²« í˜ì´ì§€ë§Œ ë Œë”ë§
        RenderManager.renderPage(State.filtered, 0);
        // TODO: ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ë¡œ ì¶”ê°€ ë¡œë“œ
      } else {
        // ì ì€ ê²½ìš° ì „ì²´ ë Œë”ë§
        State.filtered.forEach(c => {
          grid.appendChild(createCard(c));
        });
      }
    }

    // í•„í„° UI ì„¤ì •
    function setupFilters() {
      const pills = document.querySelectorAll('.pill');
      
      pills.forEach(p => {
        p.addEventListener('click', async () => {
          // ì´ì „ í•„í„° ì €ì¥ (nearby ì‹¤íŒ¨ ì‹œ ë³µì›ìš©)
          const prevFilter = State.currentFilter;
          const prevActive = document.querySelector('.pill.active');
          
          // UI ì—…ë°ì´íŠ¸
          pills.forEach(x => { 
            x.classList.remove('active'); 
            x.setAttribute('aria-selected', 'false'); 
          });
          p.classList.add('active');
          p.setAttribute('aria-selected', 'true');
          
          const filter = p.dataset.filter;
          State.currentFilter = filter;
          
          // nearby íŠ¹ë³„ ì²˜ë¦¬
          if (filter === 'nearby') {
            if (State.userLocation) {
              Toast.show(t('nearbySort'));
              await MapManager.init();
              MapManager.centerTo(State.userLocation);
              applyFilters();
              // nearby hint í‘œì‹œ
              const hint = document.getElementById('nearbyHint');
              if (hint) hint.classList.add('show');
            } else {
              try {
                await Location.request();
                applyFilters();
                // nearby hint í‘œì‹œ
                const hint = document.getElementById('nearbyHint');
                if (hint) hint.classList.add('show');
              } catch (e) {
                // ìœ„ì¹˜ ì‹¤íŒ¨ ì‹œ ì´ì „ í•„í„°ë¡œ ë³µì›
                State.currentFilter = prevFilter;
                p.classList.remove('active');
                p.setAttribute('aria-selected', 'false');
                if (prevActive) {
                  prevActive.classList.add('active');
                  prevActive.setAttribute('aria-selected', 'true');
                }
                Location.showError();
              }
            }
          } else {
            applyFilters();
            Location.hideError();
            // nearbyê°€ ì•„ë‹Œ ê²½ìš° hint ìˆ¨ê¸°ê¸°
            const hint = document.getElementById('nearbyHint');
            if (hint) hint.classList.remove('show');
            // home í•„í„°ì¼ ë•Œ ì§€ë„ ìˆ¨ê¸°ê¸°
            if (filter === 'all' || filter === 'saved') {
              MapManager.hideMap();
            }
          }
        });
        
        // í‚¤ë³´ë“œ ì ‘ê·¼ì„±
        p.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            p.click();
          }
        });
      });
    }

    // ê²€ìƒ‰ ì²˜ë¦¬
    function setupSearch() {
      const input = document.getElementById('searchInput');
      const handleSearch = Utils.debounce((e) => {
        State.currentSearch = e.target.value.trim();
        applyFilters();
      }, 200);
      
      input.addEventListener('input', handleSearch);
    }

    // ìœ„ì¹˜ ê´€ë¦¬
    const Location = {
      async request() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            Toast.show('ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 2000);
            reject(new Error('Geolocation not supported'));
            return;
          }
          
          navigator.geolocation.getCurrentPosition(
            pos => {
              State.userLocation = { 
                lat: pos.coords.latitude, 
                lng: pos.coords.longitude 
              };
              Toast.show(t('locationObtained'), 1000);
              if (window.mapInstance) {
                MapManager.updateLocation();
              }
              resolve(State.userLocation);
            },
            err => {
              Toast.show(t('locationDenied'), 2000);
              reject(err);
            },
            { enableHighAccuracy: true, timeout: 10000 }
          );
        });
      },
      
      showError() {
        const errorEl = document.getElementById('locationError');
        if (errorEl) {
          errorEl.innerHTML = `
            <strong>${t('locationError')}</strong>
            <p>${t('locationErrorDetail')}</p>
          `;
          errorEl.classList.add('show');
        }
      },
      
      hideError() {
        document.getElementById('locationError').classList.remove('show');
      }
    };

    // ì§€ë„ ê´€ë¦¬
    const MapManager = {
      mapInstance: null,
      markerGroup: null, 
      leafletLoaded: false,
      initialized: false,
      initPromise: null, // ì¤‘ë³µ ì´ˆê¸°í™” ë°©ì§€ìš©
      
      showMap() {
        const mapEl = document.getElementById('map');
        if (mapEl) {
          mapEl.classList.add('show');
        }
      },
      
      hideMap() {
        const mapEl = document.getElementById('map');
        if (mapEl) {
          mapEl.classList.remove('show');
        }
      },
      
      async init() {
        // ì´ë¯¸ ì´ˆê¸°í™” ì¤‘ì´ë©´ ê¸°ì¡´ Promise ë°˜í™˜
        if (this.initPromise) {
          return this.initPromise;
        }
        
        // ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆìœ¼ë©´ ì§€ë„ë§Œ í‘œì‹œ
        if (this.initialized) {
          this.showMap();
          return Promise.resolve();
        }
        
        // ì´ˆê¸°í™” ì‹œì‘
        this.initPromise = this._doInit();
        return this.initPromise;
      },
      
      async _doInit() {
        try {
          // ì§€ë„ ì»¨í…Œì´ë„ˆ í‘œì‹œ
          this.showMap();
          
          if (!window.L && !this.leafletLoaded) {
            await this.loadLeaflet();
          }
          
          if (!this.mapInstance) {
            const center = State.userLocation ? 
              [State.userLocation.lat, State.userLocation.lng] : 
              [35.6804, 139.7690];
            
            this.mapInstance = window.mapInstance = L.map('map', { 
              zoomControl: true 
            }).setView(center, 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              maxZoom: 19,
              attribution: '&copy; OSM'
            }).addTo(this.mapInstance);
            
            this.hideError();
            this.initialized = true;
          }
          
          this.renderMarkers();
        } catch (e) {
          this.showError();
          throw e;
        } finally {
          this.initPromise = null;
        }
      },
      
      async loadLeaflet() {
        return new Promise((resolve, reject) => {
          // CSS
          const css = document.createElement('link');
          css.rel = 'stylesheet';
          css.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
          document.head.appendChild(css);
          
          // JS
          const script = document.createElement('script');
          script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
          script.onload = () => {
            this.leafletLoaded = true;
            resolve();
          };
          script.onerror = () => {
            Toast.show(t('mapLoadFailed'), 3000);
            reject(new Error('Failed to load Leaflet'));
          };
          document.body.appendChild(script);
        });
      },
      
      renderMarkers() {
        if (!this.mapInstance || !this.initialized) return;
        
        // ê¸°ì¡´ ë§ˆì»¤ í´ë¦¬ì–´
        if (this.markerGroup) {
          this.markerGroup.clearLayers();
        } else {
          this.markerGroup = L.layerGroup().addTo(this.mapInstance);
        }
        
        // ì‚¬ìš©ì ìœ„ì¹˜ í‘œì‹œ
        if (State.userLocation) {
          L.circleMarker([State.userLocation.lat, State.userLocation.lng], {
            radius: 8, 
            fillColor: '#2563eb', 
            color: '#fff', 
            weight: 2, 
            fillOpacity: 1
          }).addTo(this.markerGroup).bindPopup('ç¾åœ¨åœ°');
        }
        
        // ì¿ í° ë§ˆì»¤
        State.coupons.forEach(c => {
          if (c.lat != null && c.lng != null) {
            const marker = L.marker([c.lat, c.lng]);
            let popup = `<strong>${c.store}</strong><br>${c.offer}<br>`;
            popup += c.expiry === '9999-12-31' ? 'æœŸé™ãªã—' : c.expiry.replace(/-/g,'/');
            
            if (State.userLocation) {
              const d = Utils.distance(State.userLocation.lat, State.userLocation.lng, c.lat, c.lng);
              popup += `<br>${d < 1 ? Math.round(d * 1000) + 'm' : d.toFixed(1) + 'km'}`;
            }
            
            marker.bindPopup(popup);
            marker.on('click', () => {
              const card = document.querySelector(`[data-id="${c.id}"]`);
              if (card) { 
                card.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                card.focus(); 
              }
            });
            marker.addTo(this.markerGroup);
          }
        });
      },
      
      centerTo(loc) {
        if (this.mapInstance && loc && loc.lat && loc.lng) {
          this.mapInstance.setView([loc.lat, loc.lng], 13);
        }
      },
      
      updateLocation() {
        this.renderMarkers();
        if (State.userLocation) this.centerTo(State.userLocation);
      },
      
      showError() {
        document.getElementById('mapError').style.display = 'block';
      },
      
      hideError() {
        document.getElementById('mapError').style.display = 'none';
      }
    };

    // ì§€ë„ ì¬ì‹œë„
    window.retryMap = async function() {
      MapManager.hideError();
      await MapManager.init();
    };

    // ì´ë²¤íŠ¸ ìœ„ì„ (ëŒ€ëŸ‰ ì¹´ë“œ ëŒ€ë¹„)
    function setupEventDelegation() {
      const grid = document.getElementById('couponGrid');
      if (!grid) return;
      
      // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ìœ„ì„
      grid.addEventListener('click', (e) => {
        // ì €ì¥ ë²„íŠ¼
        const saveBtn = e.target.closest('.save');
        if (saveBtn) {
          e.preventDefault();
          e.stopPropagation();
          const card = saveBtn.closest('.card');
          const id = parseInt(card.getAttribute('data-id'));
          toggleSave(id, saveBtn);
          return;
        }
        
        // ë³µì‚¬ ë²„íŠ¼
        const copyBtn = e.target.closest('.copy-btn');
        if (copyBtn) {
          e.stopPropagation();
          // ë³µì‚¬ ë¡œì§ì€ ê¸°ì¡´ ìœ ì§€ (ì½”ë“œê°€ ë²„íŠ¼ì— ë°”ì¸ë”©ë¨)
          return;
        }
        
        // ì¹´ë“œ ë’¤ì§‘ê¸°
        const cardInner = e.target.closest('.card-inner');
        if (cardInner && !e.target.closest('.info-item')) {
          const card = cardInner.closest('.card');
          if (card) {
            // ê¸°ì¡´ ë’¤ì§‘ê¸° ë¡œì§ ì‹¤í–‰
            // TODO: ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ ì™„ì „ ì „í™˜ ì‹œ êµ¬í˜„
          }
        }
      });
    }

    // ì´ë²¤íŠ¸ ì„¤ì •
    function setupEvents() {
      // ì´ë²¤íŠ¸ ìœ„ì„ ì„¤ì • (ëŒ€ëŸ‰ ì¹´ë“œ ëŒ€ë¹„)
      setupEventDelegation();
      
      // í…Œë§ˆ í† ê¸€
      document.getElementById('themeToggle').addEventListener('click', Theme.toggle);
      
      // ê·¼ì²˜ ë²„íŠ¼
      document.getElementById('locateBtn').addEventListener('click', async () => {
        try {
          await Location.request();
          await MapManager.init();
          // nearby í•„í„° ìë™ ì ìš©
          const nearbyPill = document.querySelector('[data-filter="nearby"]');
          if (nearbyPill) nearbyPill.click();
          // hint í‘œì‹œ
          const hint = document.getElementById('nearbyHint');
          if (hint) hint.classList.add('show');
        } catch (e) {
          Location.showError();
        }
      });
      
      // ë„¤ë¹„ê²Œì´ì…˜
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', async (e) => {
          e.preventDefault();
          const view = item.dataset.view;
          
          // í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
          document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
          item.classList.add('active');
          State.currentView = view;
          
          // ë·° ì²˜ë¦¬
          switch(view) {
            case 'home':
              document.querySelector('[data-filter="all"]').click();
              MapManager.hideMap();
              break;
            case 'saved':
              document.querySelector('[data-filter="saved"]').click();
              MapManager.hideMap();
              break;
            case 'map':
              await MapManager.init();
              MapManager.showMap();
              MapManager.centerTo(State.userLocation || {lat: 35.6804, lng: 139.7690});
              Toast.show(t('mapViewTab'));
              // hint í‘œì‹œ
              const hint = document.getElementById('nearbyHint');
              if (hint) hint.classList.add('show');
              break;
            case 'settings':
              Toast.show('è¨­å®šã¯æº–å‚™ä¸­ã§ã™');
              MapManager.hideMap();
              break;
          }
        });
      });
    }

    // ì´ˆê¸°í™”
    async function boot() {
      // í…Œë§ˆ ë¡œë“œ
      Theme.load();
      
      // ì €ì¥ëœ ë°ì´í„° ë¡œë“œ
      State.saved = StorageManager.getSaved();
      
      // ì¿ í° ë°ì´í„° ë¡œë“œ (API ì‹œë„ â†’ ìºì‹œ â†’ í•˜ë“œì½”ë”© ìˆœ)
      State.coupons = await CouponLoader.loadFromAPI();
      State.filtered = [...State.coupons];
      
      // ìºì‹œ ì—…ë°ì´íŠ¸
      if (State.coupons.length > 0) {
        CouponLoader.cacheData(State.coupons);
      }
      
      // UI ì„¤ì •
      setupFilters();
      setupSearch();
      setupEvents();
      
      // ì´ˆê¸° ë Œë”ë§
      applyFilters();
    }

    // DOMContentLoaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', boot);
    } else {
      boot();
    }

    
  </script>
</body>
</html>
