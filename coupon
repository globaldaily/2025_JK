<!--
WordPress Ïó∞ÎèôÏùÑ ÏúÑÌïú PHP ÏΩîÎìú (functions.phpÏóê Ï∂îÍ∞Ä):

// 1. REST API ÏóîÎìúÌè¨Ïù∏Ìä∏ Îì±Î°ù
add_action('rest_api_init', function () {
    register_rest_route('jkwallet/v1', '/coupons', array(
        'methods' => 'GET',
        'callback' => 'get_jkwallet_coupons',
        'permission_callback' => '__return_true'
    ));
});

// 2. Ïø†Ìè∞ Îç∞Ïù¥ÌÑ∞ Î∞òÌôò Ìï®Ïàò
function get_jkwallet_coupons() {
    $coupons = [];
    
    // ACF Pro Repeater FieldÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
    if( have_rows('coupons', 'option') ) {
        while( have_rows('coupons', 'option') ) {
            the_row();
            $coupons[] = [
                'id' => get_sub_field('id'),
                'store' => get_sub_field('store'),
                'offer' => get_sub_field('offer'),
                'description' => get_sub_field('description'),
                'category' => get_sub_field('category'),
                'expiry' => get_sub_field('expiry'),
                'image' => get_sub_field('image'),
                'code' => get_sub_field('code'),
                'lat' => floatval(get_sub_field('lat')),
                'lng' => floatval(get_sub_field('lng')),
                'rating' => floatval(get_sub_field('rating'))
            ];
        }
    }
    
    return rest_ensure_response($coupons);
}

// 3. JavaScriptÏóê API Í≤ΩÎ°ú Ï†ÑÎã¨ (Í∂åÏû•)
function enqueue_jkwallet_scripts() {
    wp_enqueue_script('jkwallet', get_template_directory_uri() . '/js/jkwallet.js', [], '1.0', true);
    wp_localize_script('jkwallet', 'wpApiSettings', array(
        'root' => esc_url_raw(rest_url()),
        'nonce' => wp_create_nonce('wp_rest')
    ));
}
add_action('wp_enqueue_scripts', 'enqueue_jkwallet_scripts');
-->

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>Japankuru „ÇØ„Éº„Éù„É≥„Ç¶„Ç©„É¨„ÉÉ„Éà</title>

  <!-- ÏµúÏÜå ÌïµÏã¨ Ïä§ÌÉÄÏùº -->
  <style>
    :root {
      --primary:#2563eb;
      --bg:#f3f4f6;
      --card:#ffffff;
      --radius:.75rem;
      --shadow:0 4px 12px rgba(0,0,0,0.08);
      --text:#111827;
      --muted:#6b7280;
      --border:#d1d5db;
      --gray-100:#f3f4f6;
      --gray-700:#374151;
    }
    .dark-mode {
      --bg:#0f172a;
      --card:#1e293b;
      --text:#f1f5f9;
      --muted:#94a3b8;
      --border:#334155;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);line-height:1.4;min-height:100vh;padding-bottom:60px;transition:background .3s,color .3s;}
    .container{max-width:1000px;margin:0 auto;padding:0 1rem;}
    .header{display:flex;justify-content:space-between;align-items:center;padding:1rem 0;}
    .logo{font-weight:700;display:flex;align-items:center;gap:.5rem;font-size:1.25rem;color:var(--primary);}
    .btn{padding:.5rem 1rem;border:none;border-radius:.5rem;cursor:pointer;font-size:.9rem;display:inline-flex;align-items:center;gap:.25rem;transition:transform .2s;}
    .btn:hover{transform:scale(1.02);}
    .btn:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .btn-primary{background:var(--primary);color:#fff;}
    .search{margin:1rem 0;display:flex;gap:.5rem;flex-wrap:wrap;}
    .search input{flex:1;min-width:150px;padding:.75rem 1rem;border:1px solid var(--border);border-radius:.5rem;font-size:1rem;outline:none;background:var(--card);color:var(--text);transition:border-color .2s;}
    .search input:focus{border-color:var(--primary);}
    .filters{display:flex;gap:.5rem;overflow-x:auto;margin-bottom:1rem;-webkit-overflow-scrolling:touch;}
    .pill{padding:.5rem .75rem;border-radius:9999px;border:1px solid var(--border);background:var(--card);cursor:pointer;font-size:.75rem;display:flex;align-items:center;gap:4px;transition:all .2s;white-space:nowrap;}
    .pill:hover{transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,0,0,0.1);}
    .pill:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .pill.active{background:var(--primary);color:#fff;border-color:var(--primary);}
    .flex{display:flex;gap:1rem;flex-wrap:wrap;}
    .coupon-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;margin-top:0;}
    .card{background:var(--card);border-radius:var(--radius);overflow:visible;box-shadow:var(--shadow);position:relative;height:380px;font-size:.9rem;cursor:pointer;transition:transform .2s,box-shadow .2s;perspective:1000px;}
    .card:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,0.12);}
    .card:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .card.flipped .card-inner{transform:rotateY(180deg);}
    .card-inner{position:absolute;width:100%;height:100%;transform-style:preserve-3d;transition:transform .6s;}
    .card-face{position:absolute;width:100%;height:100%;-webkit-backface-visibility:hidden;backface-visibility:hidden;display:flex;flex-direction:column;border-radius:var(--radius);overflow:hidden;background:var(--card);}
    .card-front{background:var(--card);}
    .card-back{background:var(--card);transform:rotateY(180deg);padding:1.5rem;}
    .card img{width:100%;height:160px;object-fit:cover;display:block;}
    .card-body{padding:1rem;flex:1;display:flex;flex-direction:column;gap:.5rem;}
    .title{font-weight:700;font-size:1.1rem;margin-bottom:2px;}
    .offer{color:#dc2626;font-weight:700;margin:4px 0;}
    .desc{flex:1;color:var(--muted);font-size:.8rem;margin-bottom:4px;}
    .footer{display:flex;justify-content:space-between;font-size:.7rem;gap:.5rem;flex-wrap:wrap;}
    .badge{background:#f59e0b;color:#fff;padding:2px 6px;border-radius:4px;font-size:.6rem;display:inline-block;}
    .small{font-size:.65rem;color:var(--muted);}
    .save{position:absolute;top:8px;right:8px;background:#fff;border:none;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.2);transition:all .2s;z-index:20;pointer-events:all;font-size:1.25rem;-webkit-tap-highlight-color:transparent;}
    .save:hover{transform:scale(1.1);}
    .save:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .save.saved{background:#10b981;color:#fff;}
    .dark-mode .save{background:var(--card);color:var(--text);}
    .dark-mode .save.saved{background:#10b981;color:#fff;}
    .qr-section{text-align:center;margin-bottom:1rem;}
    .qr-code{font-size:3rem;margin:1rem 0;background:#f0f0f0;padding:1rem;border-radius:0.5rem;display:inline-block;}
    .coupon-code{font-size:1.5rem;font-weight:700;color:var(--primary);margin-top:.5rem;user-select:all;cursor:pointer;padding:.5rem;border-radius:.25rem;transition:background .2s;}
    .coupon-code:hover{background:var(--gray-100);}
    .dark-mode .coupon-code:hover{background:var(--gray-700);}
    .back-info{flex:1;}
    .info-item{margin-bottom:.75rem;font-size:.85rem;line-height:1.4;}
    .info-item strong{display:inline-block;min-width:80px;}
    .copy-btn{width:100%;padding:.75rem;background:var(--primary);color:#fff;border:none;border-radius:.5rem;font-size:1rem;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:.5rem;}
    .copy-btn:hover{background:#1d4ed8;}
    .copy-btn:focus{outline:2px solid var(--primary);outline-offset:2px;}
    #map{width:100%;height:260px;border-radius:12px;margin:1rem 0;overflow:hidden;position:relative;background:var(--card);border:1px solid var(--border);display:none;}
    #map.show{display:block;}
    #mapError{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:1000;}
    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 16px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.2);opacity:0;pointer-events:none;transition:all .3s;max-width:90vw;z-index:1000;}
    .toast.show{opacity:1;pointer-events:auto;}
    .dark-mode .toast{background:#fff;color:#111827;}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--card);display:flex;justify-content:space-around;padding:.5rem 0;border-top:1px solid var(--border);font-size:.65rem;}
    .nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--muted);text-decoration:none;cursor:pointer;padding:4px 8px;border-radius:4px;transition:color .2s;}
    .nav-item:hover{color:var(--primary);}
    .nav-item:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .nav-item.active{color:var(--primary);}
    .nearby-hint{margin-top:.5rem;font-size:.75rem;color:var(--muted);display:none;}
    .nearby-hint.show{display:block;}
    .location-error{background:#fee;color:#dc2626;padding:.75rem;border-radius:.5rem;margin:1rem 0;font-size:.8rem;display:none;}
    .location-error.show{display:block;}
    .location-error p{margin-top:.25rem;font-size:.75rem;color:#991b1b;}
    .flex-center{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;}
    .toggle-theme{background:none;border:none;cursor:pointer;font-size:1rem;padding:4px;transition:transform .2s;}
    .toggle-theme:hover{transform:scale(1.1);}
    .toggle-theme:focus{outline:2px solid var(--primary);outline-offset:2px;}
    .retry-btn{background:#ef4444;color:#fff;padding:.25rem .5rem;border:none;border-radius:.25rem;cursor:pointer;font-size:.75rem;margin-top:.5rem;}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
    .close-detail-btn{background:none;border:none;color:var(--primary);font-size:.9rem;padding:.5rem;cursor:pointer;margin-bottom:.5rem;display:flex;align-items:center;gap:.25rem;transition:opacity .2s;}
    .close-detail-btn:hover{opacity:0.8;}
    .close-detail-btn:focus{outline:2px solid var(--primary);outline-offset:2px;}
    @media (max-width: 800px){
      .coupon-grid{grid-template-columns:1fr;}
    }
    /* „Çπ„Ç±„É´„Éà„É≥„É≠„Éº„ÉÄ„Éº */
    .skeleton{background:linear-gradient(90deg,var(--card) 25%,var(--bg) 50%,var(--card) 75%);background-size:200% 100%;animation:loading 1.5s infinite;}
    @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
  </style>
</head>
<body>
  <div class="container">
    <header class="header" aria-label="„Éò„ÉÉ„ÉÄ„Éº">
      <div class="logo" aria-label="JK Wallet">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M22.46,6C21.69,6.18 21.06,6.65 20.64,7.25C20.18,5.53 18.54,4.24 16.64,4.24C15.07,4.24 13.71,5.19 13.12,6.56C12.61,6.34 12.06,6.22 11.5,6.22C9.84,6.22 8.5,7.56 8.5,9.22C8.5,9.64 8.58,10.04 8.73,10.41C7.73,10.41 6.9,11.24 6.9,12.24V19.76C6.9,20.76 7.73,21.59 8.73,21.59H20.27C21.27,21.59 22.1,20.76 22.1,19.76V12.24C22.1,11.24 21.27,10.41 20.27,10.41H20.02C20.46,9.74 20.73,8.96 20.73,8.11C20.73,7.25 20.44,6.46 19.96,5.82C21.31,6.04 22.46,6.79 22.46,6Z"/>
        </svg>
        JK Wallet
      </div>
      <div class="flex-center">
        <button class="btn btn-primary" id="locateBtn" aria-label="ÁèæÂú®Âú∞„ÅÆËøë„Åè„ÇíË°®Á§∫">Ëøë„Åè„ÇíË°®Á§∫</button>
        <button class="toggle-theme" id="themeToggle" aria-label="„ÉÜ„Éº„ÉûÂàáÊõø">üåì</button>
      </div>
    </header>

    <div class="search" aria-label="Ê§úÁ¥¢„Å®„Éï„Ç£„É´„Çø„Éº">
      <input type="search" id="searchInput" placeholder="Â∫óÂêç„Éª„Ç®„É™„Ç¢„ÅßÊ§úÁ¥¢..." aria-label="„ÇØ„Éº„Éù„É≥Ê§úÁ¥¢" />
    </div>

    <div class="filters" role="tablist" aria-label="„Éï„Ç£„É´„Çø„Éº">
      <div class="pill active" data-filter="all" role="tab" aria-selected="true" tabindex="0">„Åô„Åπ„Å¶</div>
      <div class="pill" data-filter="saved" role="tab" aria-selected="false" tabindex="0">‰øùÂ≠òÊ∏à„Åø</div>
      <div class="pill" data-filter="electronics" role="tab" aria-selected="false" tabindex="0">ÂÆ∂Èõª</div>
      <div class="pill" data-filter="fashion" role="tab" aria-selected="false" tabindex="0">„Éï„Ç°„ÉÉ„Ç∑„Éß„É≥</div>
      <div class="pill" data-filter="dining" role="tab" aria-selected="false" tabindex="0">„Ç∞„É´„É°</div>
      <div class="pill" data-filter="transport" role="tab" aria-selected="false" tabindex="0">‰∫§ÈÄö</div>
      <div class="pill" data-filter="nearby" role="tab" aria-selected="false" tabindex="0">Ëøë„Åè</div>
    </div>

    <!-- ÏúÑÏπò ÏóêÎü¨ ÌëúÏãú -->
    <div class="location-error" id="locationError">
      <strong>ÁèæÂú®Âú∞„Çí‰ΩøÁî®„Åß„Åç„Åæ„Åõ„Çì</strong>
      <p>‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂà©Áî®„Åô„Çã„Å´„ÅØ„ÄÅ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÅßË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
    </div>

    <!-- ÏßÄÎèÑ -->
    <div id="map" aria-label="„ÇØ„Éº„Éù„É≥„Éû„ÉÉ„Éó">
      <div id="mapError">
        <p>Âú∞Âõ≥„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü</p>
        <button class="retry-btn" onclick="retryMap()">ÂÜçË©¶Ë°å</button>
      </div>
    </div>
    <div class="nearby-hint" id="nearbyHint">„ÄåËøë„Åè„Äç„ÇíÊäº„Åô„Å®ÁèæÂú®Âú∞„Å´Âü∫„Å•„ÅÑ„Å¶„ÇΩ„Éº„Éà„Åó„Åæ„Åô„ÄÇ</div>

    <!-- Ïø†Ìè∞ Î¶¨Ïä§Ìä∏ -->
    <div class="coupon-grid" id="couponGrid" aria-label="Âà©Áî®ÂèØËÉΩ„Å™„ÇØ„Éº„Éù„É≥"></div>
  </div>

  <!-- Ïä§ÌÅ¨Î¶∞Î¶¨Îçî ÏïåÎ¶º ÏòÅÏó≠ -->
  <div id="sr-announcement" aria-live="polite" aria-atomic="true" class="sr-only"></div>

  <!-- ÌÜ†Ïä§Ìä∏ -->
  <div class="toast" id="toast" role="alert" aria-live="assertive"></div>

  <!-- Í∞ÑÎã®Ìïú ÌïòÎã® ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò -->
  <nav class="bottom-nav" aria-label="„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥">
    <a href="#" class="nav-item active" data-view="home" tabindex="0">„Éõ„Éº„É†</a>
    <a href="#" class="nav-item" data-view="saved" tabindex="0">‰øùÂ≠òÊ∏à„Åø</a>
    <a href="#" class="nav-item" data-view="map" tabindex="0">„Éû„ÉÉ„Éó</a>
    <a href="#" class="nav-item" data-view="settings" tabindex="0">Ë®≠ÂÆö</a>
  </nav>

  <!-- ÏµúÏÜå Ïä§ÌÅ¨Î¶ΩÌä∏ -->
  <script>
    // Ïú†Ìã∏Î¶¨Ìã∞
    const Utils = {
      // ÎîîÎ∞îÏö¥Ïä§
      debounce(func, wait) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      },
      
      // Í±∞Î¶¨ Í≥ÑÏÇ∞ (km)
      distance(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) ** 2 + 
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                  Math.sin(dLng/2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }
    };

    // Îã®Ïàú ÏÉÅÌÉú
    const State = {
      coupons: [],
      filtered: [],
      saved: [],
      userLocation: null,
      currentFilter: 'all',
      currentSearch: '',
      currentView: 'home', // home, map, saved, settings
      saveDebounce: null
    };

    // ÌÜ†Ïä§Ìä∏
    const Toast = {
      el: document.getElementById('toast'),
      show(msg, duration = 2000) {
        this.el.textContent = msg;
        this.el.classList.add('show');
        setTimeout(() => this.el.classList.remove('show'), duration);
      }
    };

    // Ïø†Ìè∞ Îç∞Ïù¥ÌÑ∞ Î°úÎçî
    const CouponLoader = {
      async loadFromAPI() {
        try {
          // WordPress REST API ÏóîÎìúÌè¨Ïù∏Ìä∏ (ACF Îç∞Ïù¥ÌÑ∞)
          // TODO: WordPressÏóê ÏóîÎìúÌè¨Ïù∏Ìä∏ Íµ¨ÌòÑ ÌõÑ ÌôúÏÑ±Ìôî
          
          // Î∞©Î≤ï 1: ÏÉÅÎåÄ Í≤ΩÎ°ú (ÏÑúÎ∏åÎîîÎ†âÌÜ†Î¶¨ ÎåÄÏùë)
          // const baseUrl = window.location.pathname.split('/').slice(0, -1).join('/');
          // const response = await fetch(`${baseUrl}/wp-json/jkwallet/v1/coupons`);
          
          // Î∞©Î≤ï 2: Ï†àÎåÄ Í≤ΩÎ°ú
          // const response = await fetch(`${window.location.origin}/wp-json/jkwallet/v1/coupons`);
          
          // Î∞©Î≤ï 3: WordPress localize_scriptÎ°ú Ï†ÑÎã¨Îêú Í≤ΩÎ°ú ÏÇ¨Ïö© (Í∂åÏû•)
          // if (window.wpApiSettings) {
          //   const response = await fetch(`${window.wpApiSettings.root}jkwallet/v1/coupons`);
          // }
          
          // if (!response.ok) throw new Error('API Error');
          // const data = await response.json();
          // return data;
          
          // ÏûÑÏãú: API Íµ¨ÌòÑ Ï†ÑÍπåÏßÄ ÌïòÎìúÏΩîÎî© Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
          return couponData;
        } catch (error) {
          console.warn('API Î°úÎìú Ïã§Ìå®, Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©:', error);
          // Ìè¥Î∞±: Î°úÏª¨ Ï∫êÏãú ÌôïÏù∏
          const cached = localStorage.getItem('cachedCoupons');
          if (cached) {
            try {
              return JSON.parse(cached);
            } catch (e) {
              console.error('Ï∫êÏãú ÌååÏã± Ïã§Ìå®:', e);
            }
          }
          // ÏµúÏ¢Ö Ìè¥Î∞±: ÌïòÎìúÏΩîÎî© Îç∞Ïù¥ÌÑ∞
          return couponData;
        }
      },
      
      cacheData(data) {
        try {
          localStorage.setItem('cachedCoupons', JSON.stringify(data));
          localStorage.setItem('cacheTime', Date.now().toString());
        } catch (e) {
          console.warn('Ï∫êÏãú Ï†ÄÏû• Ïã§Ìå®:', e);
        }
      }
    };

    // Ïø†Ìè∞ Îç∞Ïù¥ÌÑ∞ (ÌïòÎìúÏΩîÎî© - API Ïã§Ìå®Ïãú Ìè¥Î∞±Ïö©)
    const couponData = [
      { id:1, store:'„Ç≥„Ç∏„Éû x „Éì„ÉÉ„ÇØ„Ç´„É°„É©', offer:'ÊúÄÂ§ß 17% OFF', description:'ÂÖçÁ®é10% + ËøΩÂä†7%Ââ≤ÂºïÔºÅÊúÄÊñ∞„ÅÆÈõªÂ≠êË£ΩÂìÅ„ÇíÂÆâ„Åè„ÄÇ', category:'electronics', expiry:'2025-12-31', image:'https://japankuru.com/gld-kanri/data/uploads/2023/11/kojima%E8%8B%B1%E8%AA%9E%E7%89%88%E4%BC%81%E6%A5%AD%E6%9C%89_kojima_EN_B-2.jpg', code:'JK-BIC2025', lat:35.6909, lng:139.7003, rating:4.2 },
      { id:2, store:'JINS', offer:'10% OFF', description:'ÂÖçÁ®é+Ââ≤Âºï„ÅÆ„É°„Ç¨„Éç„ÄÇ', category:'fashion', expiry:'2025-07-30', image:'https://japankuru.com/gld-kanri/data/uploads/2024/06/japankuru_1800-1200-1536x1024.jpg', code:'JK-JINS2025', lat:35.6581, lng:139.6986, rating:4.1 },
      { id:3, store:'BEAMS JAPAN', offer:'5% ËøΩÂä†Ââ≤Âºï', description:'„Éà„É¨„É≥„Éâ„ÇíÁô∫‰ø°„Åô„Çã„Çª„É¨„ÇØ„Éà„Ç∑„Éß„ÉÉ„Éó„ÄÇ', category:'fashion', expiry:'2025-09-30', image:'https://img.japankuru.com/prg_img/img/img2024011517461371466800.jpg', code:'JK-BEAMS25', lat:35.6702, lng:139.7073, rating:4.3 },
      { id:4, store:'„Çµ„É†„É©„Ç§„É¨„Çπ„Éà„É©„É≥', offer:'„Éâ„É™„É≥„ÇØ1ÊùØÁÑ°Êñô', description:'ËèØÈ∫ó„Å™„Ç∑„Éß„Éº„Å®È£ü‰∫ã„ÄÇ', category:'dining', expiry:'2026-03-31', image:'https://japankuru.com/gld-kanri/data/uploads/2024/06/%E4%BE%8D%E3%82%AF%E3%83%BC%E3%83%9D%E3%83%B3c-2_0_0-1536x864.jpeg', code:'JK-SAMURAI', lat:35.6947, lng:139.7006, rating:4.5 },
      { id:5, store:'Êù±ÊÄ•Á∑ö', offer:'1Êó•‰πóËªäÂà∏', description:'Êù±‰∫¨ÊóÖË°å„ÅÆÂøÖÈ†à„Ç¢„Ç§„ÉÜ„É†„ÄÇ', category:'transport', expiry:'9999-12-31', image:'https://japankuru.com/gld-kanri/data/uploads/2025/03/tokyu-cover-16-9-1-1536x864.png', code:'JK-TOKYU', lat:35.6580, lng:139.7016, rating:4.0 },
      { id:6, store:'„É®„Éâ„Éê„Ç∑„Ç´„É°„É©', offer:'ÊúÄÂ§ß 15% OFF', description:'ÂÖçÁ®é10% + VISA„Ç´„Éº„ÉâÊ±∫Ê∏à„Åß5%ËøΩÂä†Ââ≤ÂºïÔºÅ', category:'electronics', expiry:'2025-11-30', image:'https://img.japankuru.com/prg_img/thumbnail1/img2023112417190332724100.png', code:'JK-Yodobashi', lat:35.6938, lng:139.7706, rating:4.4 }
    ];

    // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Í¥ÄÎ¶¨
    const Storage = {
      load(key, defaultValue = []) {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : defaultValue;
        } catch (e) {
          console.error(`Failed to load ${key}:`, e);
          return defaultValue;
        }
      },
      
      save: Utils.debounce((key, data) => {
        try {
          localStorage.setItem(key, JSON.stringify(data));
        } catch (e) {
          console.error(`Failed to save ${key}:`, e);
          Toast.show('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 3000);
        }
      }, 100)
    };

    // ÌÖåÎßà Í¥ÄÎ¶¨
    const Theme = {
      load() {
        const isDark = StorageManager.getTheme();
        if (isDark) document.body.classList.add('dark-mode');
      },
      
      toggle() {
        const isDark = document.body.classList.toggle('dark-mode');
        StorageManager.setTheme(isDark);
        Toast.show(isDark ? t('darkMode') : t('lightMode'), 1000);
      }
    };

    // ÌïÑÌÑ∞/Í≤ÄÏÉâ Ï†ÅÏö©
    function applyFilters() {
      let list = [...State.coupons];
      
      // ÌïÑÌÑ∞ Ï†ÅÏö©
      if (State.currentFilter === 'saved') {
        list = list.filter(c => State.saved.includes(c.id));
      } else if (State.currentFilter === 'nearby' && State.userLocation) {
        list.sort((a, b) => {
          const da = Utils.distance(State.userLocation.lat, State.userLocation.lng, a.lat, a.lng);
          const db = Utils.distance(State.userLocation.lat, State.userLocation.lng, b.lat, b.lng);
          return da - db;
        });
      } else if (['electronics','fashion','dining','transport'].includes(State.currentFilter)) {
        list = list.filter(c => c.category === State.currentFilter);
      }
      
      // Í≤ÄÏÉâÏñ¥ Ï†ÅÏö©
      if (State.currentSearch) {
        const q = State.currentSearch.toLowerCase();
        list = list.filter(c => 
          c.store.toLowerCase().includes(q) ||
          c.description.toLowerCase().includes(q) ||
          (c.category && c.category.toLowerCase().includes(q))
        );
      }
      
      State.filtered = list;
      renderCoupons();
    }

    // Ï†ÄÏû•ÏÜå Í¥ÄÎ¶¨ (ÏùºÍ¥ÄÏÑ± Í∞úÏÑ†)
    const StorageManager = {
      getSaved() {
        try {
          const saved = localStorage.getItem('savedCoupons');
          return saved ? JSON.parse(saved) : [];
        } catch (e) {
          console.error('Ï†ÄÏû•Îêú Ïø†Ìè∞ Î°úÎìú Ïã§Ìå®:', e);
          return [];
        }
      },
      
      setSaved(data) {
        try {
          localStorage.setItem('savedCoupons', JSON.stringify(data));
        } catch (e) {
          console.error('Ïø†Ìè∞ Ï†ÄÏû• Ïã§Ìå®:', e);
          Toast.show(t('saveFailed'), 3000);
        }
      },
      
      getTheme() {
        return localStorage.getItem('darkMode') === 'true';
      },
      
      setTheme(isDark) {
        localStorage.setItem('darkMode', isDark.toString());
      }
    };

    // Îã§Íµ≠Ïñ¥ ÌÖçÏä§Ìä∏
    const T = {
      ja: {
        detailShow: 'Ë©≥Á¥∞„ÇíË°®Á§∫',
        backToList: '„É™„Çπ„Éà„Å´Êàª„Çã',
        backButton: '‚Üê Êàª„Çã',
        closeDetail: 'Ë©≥Á¥∞„ÇíÈñâ„Åò„Çã',
        couponDetail: '„ÇØ„Éº„Éù„É≥Ë©≥Á¥∞„ÇíË°®Á§∫‰∏≠',
        listReturned: '„ÇØ„Éº„Éù„É≥‰∏ÄË¶ß„Å´Êàª„Çä„Åæ„Åó„Åü',
        copyCode: '„Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº',
        copied: '„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü',
        codeCopied: '„ÇØ„Éº„Éù„É≥„Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ',
        copyFailed: '„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÈï∑Êäº„Åó„Åó„Å¶ÊâãÂãï„Åß„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        saveCoupon: '„ÇØ„Éº„Éù„É≥„Çí‰øùÂ≠ò',
        unsaveCoupon: '„ÇØ„Éº„Éù„É≥„ÅÆ‰øùÂ≠ò„ÇíËß£Èô§',
        saved: '‰øùÂ≠ò„Åó„Åæ„Åó„Åü',
        unsaved: '‰øùÂ≠ò„ÇíËß£Èô§„Åó„Åæ„Åó„Åü',
        saveFailed: '‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü',
        locationError: 'ÁèæÂú®Âú∞„Çí‰ΩøÁî®„Åß„Åç„Åæ„Åõ„Çì',
        locationErrorDetail: '‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂà©Áî®„Åô„Çã„Å´„ÅØ„ÄÅ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÅßË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        mapView: 'Âú∞Âõ≥„ÅßË¶ã„Çã',
        mapShown: 'Âú∞Âõ≥„ÇíË°®Á§∫„Åó„Åæ„Åó„Åü',
        nearbySort: 'ÁèæÂú®Âú∞„Å´Âü∫„Å•„Åè‰∏¶„Å≥Êõø„Åà',
        locationObtained: 'ÁèæÂú®Âú∞„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü',
        locationDenied: '‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„ÇíÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü',
        mapLoadFailed: 'Âú∞Âõ≥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü',
        noExpiry: 'ÊúüÈôê„Å™„Åó',
        store: 'Â∫óËàó',
        benefit: 'ÁâπÂÖ∏',
        expiry: 'ÊúâÂäπÊúüÈôê',
        notFound: '„ÇØ„Éº„Éù„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÊ§úÁ¥¢Êù°‰ª∂„ÇíÂ§â„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        darkMode: '„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ',
        lightMode: '„É©„Ç§„Éà„É¢„Éº„Éâ',
        codeSelected: '„Ç≥„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü',
        mapViewTab: '„Éû„ÉÉ„Éó„Éì„É•„Éº'
      }
    };
    const currentLang = 'ja';
    const t = (key) => T[currentLang][key] || key;

    // Ïä§ÌÅ¨Î¶∞Î¶¨Îçî ÏïåÎ¶º
    function announceToScreenReader(message) {
      const announcement = document.getElementById('sr-announcement');
      if (announcement) {
        announcement.textContent = message;
        setTimeout(() => {
          announcement.textContent = '';
        }, 1000);
      }
    }

    // Ïø†Ìè∞ Ïπ¥Îìú ÏÉùÏÑ±
    function createCard(coupon) {
      const card = document.createElement('div');
      card.className = 'card';
      card.setAttribute('data-id', coupon.id);
      card.setAttribute('tabindex', '0');
      card.setAttribute('role', 'button');
      card.setAttribute('aria-label', `${coupon.store}„ÅÆ„ÇØ„Éº„Éù„É≥: ${coupon.offer}`);
      card.setAttribute('aria-expanded', 'false');
      
      // Ïπ¥Îìú ÎÇ¥Î∂Ä Ïª®ÌÖåÏù¥ÎÑà
      const cardInner = document.createElement('div');
      cardInner.className = 'card-inner';
      
      // ÏïûÎ©¥
      const cardFront = document.createElement('div');
      cardFront.className = 'card-face card-front';
      cardFront.setAttribute('aria-hidden', 'false');
      
      // Ïù¥ÎØ∏ÏßÄ
      const img = document.createElement('img');
      img.src = coupon.image;
      img.alt = coupon.store;
      img.loading = 'lazy';
      cardFront.appendChild(img);
      
      // body
      const body = document.createElement('div');
      body.className = 'card-body';
      
      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = coupon.store;
      
      const offer = document.createElement('div');
      offer.className = 'offer';
      offer.textContent = coupon.offer;
      
      const desc = document.createElement('div');
      desc.className = 'desc';
      desc.textContent = coupon.description;
      
      const footer = document.createElement('div');
      footer.className = 'footer';
      
      const expiry = document.createElement('div');
      expiry.className = 'small';
      expiry.textContent = coupon.expiry === '9999-12-31' ? t('noExpiry') : coupon.expiry.replace(/-/g,'/');
      
      const dist = document.createElement('div');
      dist.className = 'small';
      if (State.userLocation) {
        const d = Utils.distance(State.userLocation.lat, State.userLocation.lng, coupon.lat, coupon.lng);
        dist.textContent = d < 1 ? `${Math.round(d * 1000)}m` : `${d.toFixed(1)}km`;
      }
      
      footer.appendChild(expiry);
      if (State.userLocation) footer.appendChild(dist);
      
      body.appendChild(title);
      body.appendChild(offer);
      body.appendChild(desc);
      body.appendChild(footer);
      cardFront.appendChild(body);
      
      // Ï†ÄÏû• Î≤ÑÌäº
      const saveBtn = document.createElement('button');
      saveBtn.className = 'save';
      saveBtn.setAttribute('aria-label', State.saved.includes(coupon.id) ? t('unsaveCoupon') : t('saveCoupon'));
      saveBtn.innerHTML = State.saved.includes(coupon.id) ? '‚òÖ' : '‚òÜ';
      if (State.saved.includes(coupon.id)) saveBtn.classList.add('saved');
      
      saveBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        toggleSave(coupon.id, saveBtn);
      });
      
      cardFront.appendChild(saveBtn);
      
      // Îí∑Î©¥
      const cardBack = document.createElement('div');
      cardBack.className = 'card-face card-back';
      cardBack.setAttribute('aria-hidden', 'true');
      
      // Îã´Í∏∞ Î≤ÑÌäº Ï∂îÍ∞Ä
      const closeBtn = document.createElement('button');
      closeBtn.className = 'close-detail-btn';
      closeBtn.innerHTML = t('backButton');
      closeBtn.setAttribute('aria-label', t('closeDetail'));
      closeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        card.classList.remove('flipped');
        card.setAttribute('aria-expanded', 'false');
        cardFront.setAttribute('aria-hidden', 'false');
        cardBack.setAttribute('aria-hidden', 'true');
        Toast.show(t('backToList'), 500);
        announceToScreenReader(t('listReturned'));
      });
      
      cardBack.appendChild(closeBtn);
      
      const qrSection = document.createElement('div');
      qrSection.className = 'qr-section';
      
      // QR ÏΩîÎìú ÎåÄÏã† ÌÅ∞ Ïø†Ìè∞ ÏΩîÎìú ÌëúÏãú
      const qrCode = document.createElement('div');
      qrCode.className = 'qr-code';
      qrCode.style.fontSize = '4rem';
      qrCode.style.background = '#f0f0f0';
      qrCode.style.padding = '1rem';
      qrCode.style.borderRadius = '0.5rem';
      qrCode.innerHTML = 'üé´';
      
      const couponCode = document.createElement('div');
      couponCode.className = 'coupon-code';
      couponCode.style.fontSize = '1.5rem';
      couponCode.style.userSelect = 'all';
      couponCode.textContent = coupon.code;
      
      // ÏΩîÎìú ÌÅ¥Î¶≠Ïãú ÏÑ†ÌÉùÎêòÎèÑÎ°ù
      couponCode.addEventListener('click', (e) => {
        e.stopPropagation();
        const selection = window.getSelection();
        const range = document.createRange();
        range.selectNodeContents(couponCode);
        selection.removeAllRanges();
        selection.addRange(range);
        Toast.show(t('codeSelected'), 1000);
      });
      
      qrSection.appendChild(qrCode);
      qrSection.appendChild(couponCode);
      
      const backInfo = document.createElement('div');
      backInfo.className = 'back-info';
      
      const storeInfo = document.createElement('div');
      storeInfo.className = 'info-item';
      storeInfo.innerHTML = `<strong>${t('store')}:</strong> ${coupon.store}`;
      
      const offerInfo = document.createElement('div');
      offerInfo.className = 'info-item';
      offerInfo.innerHTML = `<strong>${t('benefit')}:</strong> ${coupon.offer}`;
      
      const expiryInfo = document.createElement('div');
      expiryInfo.className = 'info-item';
      expiryInfo.innerHTML = `<strong>${t('expiry')}:</strong> ${coupon.expiry === '9999-12-31' ? t('noExpiry') : coupon.expiry}`;
      
      // Âú∞Âõ≥„É™„É≥„ÇØËøΩÂä†
      const mapLink = document.createElement('div');
      mapLink.className = 'info-item';
      mapLink.style.cursor = 'pointer';
      mapLink.style.color = 'var(--primary)';
      mapLink.innerHTML = `<strong>üìç ${t('mapView')}</strong>`;
      mapLink.addEventListener('click', async (e) => {
        e.stopPropagation();
        await MapManager.init();
        MapManager.centerTo({lat: coupon.lat, lng: coupon.lng});
        card.classList.remove('flipped');
        Toast.show(t('mapShown'), 1000);
      });
      
      backInfo.appendChild(storeInfo);
      backInfo.appendChild(offerInfo);
      backInfo.appendChild(expiryInfo);
      backInfo.appendChild(mapLink);
      
      const copyBtn = document.createElement('button');
      copyBtn.className = 'copy-btn';
      copyBtn.innerHTML = `üìã ${t('copyCode')}`;
      copyBtn.setAttribute('aria-label', t('copyCode'));
      copyBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        try {
          await navigator.clipboard.writeText(coupon.code);
          Toast.show(t('codeCopied'), 2000);
          copyBtn.innerHTML = `‚úÖ ${t('copied')}`;
          setTimeout(() => {
            copyBtn.innerHTML = `üìã ${t('copyCode')}`;
          }, 2000);
        } catch (err) {
          // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
          const textArea = document.createElement('textarea');
          textArea.value = coupon.code;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand('copy');
            Toast.show(t('codeCopied'), 2000);
          } catch {
            Toast.show(t('copyFailed'), 3000);
          }
          document.body.removeChild(textArea);
        }
      });
      
      cardBack.appendChild(qrSection);
      cardBack.appendChild(backInfo);
      cardBack.appendChild(copyBtn);
      
      // Ïπ¥Îìú Ï°∞Î¶Ω
      cardInner.appendChild(cardFront);
      cardInner.appendChild(cardBack);
      card.appendChild(cardInner);
      
      // Ïπ¥Îìú ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (cardInnerÏóê Î∞îÏù∏Îî©)
      cardInner.addEventListener('click', (e) => {
        // Î≥µÏÇ¨ Î≤ÑÌäºÏù¥ÎÇò ÏßÄÎèÑ ÎßÅÌÅ¨ ÌÅ¥Î¶≠ÏùÄ Î¨¥Ïãú
        if (e.target.closest('.copy-btn') || e.target.closest('.info-item')) {
          return;
        }
        
        // Ïπ¥Îìú Îí§ÏßëÍ∏∞
        card.classList.toggle('flipped');
        const isFlipped = card.classList.contains('flipped');
        card.setAttribute('aria-expanded', isFlipped.toString());
        
        cardFront.setAttribute('aria-hidden', isFlipped.toString());
        cardBack.setAttribute('aria-hidden', (!isFlipped).toString());
        
        if (isFlipped) {
          Toast.show(t('detailShow'), 1000);
          announceToScreenReader(t('couponDetail'));
        } else {
          Toast.show(t('backToList'), 1000);
          announceToScreenReader(t('listReturned'));
        }
        
        // ÏßÄÎèÑ ÏÑºÌÑ∞ÎßÅ (ÏïûÎ©¥Ïùº ÎïåÎßå)
        if (!isFlipped && coupon.lat && coupon.lng && window.mapInstance) {
          MapManager.centerTo({lat: coupon.lat, lng: coupon.lng});
        }
      });
      
      // ÌÇ§Î≥¥Îìú Ï†ëÍ∑ºÏÑ±
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          // Ìè¨Ïª§Ïä§Í∞Ä Ï†ÄÏû• Î≤ÑÌäºÏóê ÏûàÏßÄ ÏïäÏùÑ ÎïåÎßå Ïπ¥Îìú Îí§ÏßëÍ∏∞
          if (!e.target.closest('.save')) {
            cardInner.click();
          }
        }
      });
      
      return card;
    }

    // Ï†ÄÏû• ÌÜ†Í∏Ä
    function toggleSave(id, btn) {
      if (State.saved.includes(id)) {
        State.saved = State.saved.filter(x => x !== id);
        btn.innerHTML = '‚òÜ';
        btn.classList.remove('saved');
        btn.setAttribute('aria-label', t('saveCoupon'));
        Toast.show(t('unsaved'));
        
        // saved ÌïÑÌÑ∞ Ï§ëÏù¥Î©¥ Î∞îÎ°ú Ïû¨Ï†ÅÏö©
        if (State.currentFilter === 'saved') {
          applyFilters();
        }
      } else {
        State.saved.push(id);
        btn.innerHTML = '‚òÖ';
        btn.classList.add('saved');
        btn.setAttribute('aria-label', t('unsaveCoupon'));
        Toast.show(t('saved'));
      }
      
      // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
      StorageManager.setSaved(State.saved);
    }

    // Î†åÎçîÎßÅ (ÏÑ±Îä• ÏµúÏ†ÅÌôî Ï§ÄÎπÑ)
    const RenderManager = {
      pageSize: 20,
      currentPage: 0,
      isLoading: false,
      
      renderPage(coupons, page = 0) {
        const start = page * this.pageSize;
        const end = start + this.pageSize;
        const pageCoupons = coupons.slice(start, end);
        
        const grid = document.getElementById('couponGrid');
        if (page === 0) {
          grid.innerHTML = '';
        }
        
        const fragment = document.createDocumentFragment();
        pageCoupons.forEach(c => {
          fragment.appendChild(createCard(c));
        });
        grid.appendChild(fragment);
        
        this.currentPage = page;
        return pageCoupons.length === this.pageSize;
      }
    };
    
    // Î†åÎçîÎßÅ
    function renderCoupons() {
      const grid = document.getElementById('couponGrid');
      grid.innerHTML = '';
      
      if (State.filtered.length === 0) {
        grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--muted);">
          ${t('notFound')}
        </div>`;
        return;
      }
      
      // TODO: ÏÑ±Îä• ÏµúÏ†ÅÌôî - Ïø†Ìè∞Ïù¥ ÎßéÏùÑ Í≤ΩÏö∞
      // 1. Virtual Scrolling Íµ¨ÌòÑ (Intersection Observer ÌôúÏö©)
      // 2. ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò (20Í∞úÏî© Î°úÎìú)
      // 3. RequestAnimationFrameÏúºÎ°ú Î†åÎçîÎßÅ ÏµúÏ†ÅÌôî
      
      // ÌòÑÏû¨Îäî Ï†ÑÏ≤¥ Î†åÎçîÎßÅ (Ïø†Ìè∞Ïù¥ Ï†ÅÏùÑ ÎïåÎäî Î¨∏Ï†ú ÏóÜÏùå)
      if (State.filtered.length > 100) {
        // ÎßéÏùÄ Í≤ΩÏö∞ Ï≤´ ÌéòÏù¥ÏßÄÎßå Î†åÎçîÎßÅ
        RenderManager.renderPage(State.filtered, 0);
        // TODO: Ïä§ÌÅ¨Î°§ Ïù¥Î≤§Ìä∏Î°ú Ï∂îÍ∞Ä Î°úÎìú
      } else {
        // Ï†ÅÏùÄ Í≤ΩÏö∞ Ï†ÑÏ≤¥ Î†åÎçîÎßÅ
        State.filtered.forEach(c => {
          grid.appendChild(createCard(c));
        });
      }
    }

    // ÌïÑÌÑ∞ UI ÏÑ§Ï†ï
    function setupFilters() {
      const pills = document.querySelectorAll('.pill');
      
      pills.forEach(p => {
        p.addEventListener('click', async () => {
          // Ïù¥Ï†Ñ ÌïÑÌÑ∞ Ï†ÄÏû• (nearby Ïã§Ìå® Ïãú Î≥µÏõêÏö©)
          const prevFilter = State.currentFilter;
          const prevActive = document.querySelector('.pill.active');
          
          // UI ÏóÖÎç∞Ïù¥Ìä∏
          pills.forEach(x => { 
            x.classList.remove('active'); 
            x.setAttribute('aria-selected', 'false'); 
          });
          p.classList.add('active');
          p.setAttribute('aria-selected', 'true');
          
          const filter = p.dataset.filter;
          State.currentFilter = filter;
          
          // nearby ÌäπÎ≥Ñ Ï≤òÎ¶¨
          if (filter === 'nearby') {
            if (State.userLocation) {
              Toast.show(t('nearbySort'));
              await MapManager.init();
              MapManager.centerTo(State.userLocation);
              applyFilters();
              // nearby hint ÌëúÏãú
              const hint = document.getElementById('nearbyHint');
              if (hint) hint.classList.add('show');
            } else {
              try {
                await Location.request();
                applyFilters();
                // nearby hint ÌëúÏãú
                const hint = document.getElementById('nearbyHint');
                if (hint) hint.classList.add('show');
              } catch (e) {
                // ÏúÑÏπò Ïã§Ìå® Ïãú Ïù¥Ï†Ñ ÌïÑÌÑ∞Î°ú Î≥µÏõê
                State.currentFilter = prevFilter;
                p.classList.remove('active');
                p.setAttribute('aria-selected', 'false');
                if (prevActive) {
                  prevActive.classList.add('active');
                  prevActive.setAttribute('aria-selected', 'true');
                }
                Location.showError();
              }
            }
          } else {
            applyFilters();
            Location.hideError();
            // nearbyÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ hint Ïà®Í∏∞Í∏∞
            const hint = document.getElementById('nearbyHint');
            if (hint) hint.classList.remove('show');
            // home ÌïÑÌÑ∞Ïùº Îïå ÏßÄÎèÑ Ïà®Í∏∞Í∏∞
            if (filter === 'all' || filter === 'saved') {
              MapManager.hideMap();
            }
          }
        });
        
        // ÌÇ§Î≥¥Îìú Ï†ëÍ∑ºÏÑ±
        p.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            p.click();
          }
        });
      });
    }

    // Í≤ÄÏÉâ Ï≤òÎ¶¨
    function setupSearch() {
      const input = document.getElementById('searchInput');
      const handleSearch = Utils.debounce((e) => {
        State.currentSearch = e.target.value.trim();
        applyFilters();
      }, 200);
      
      input.addEventListener('input', handleSearch);
    }

    // ÏúÑÏπò Í¥ÄÎ¶¨
    const Location = {
      async request() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            Toast.show('‰ΩçÁΩÆÊÉÖÂ†±„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì', 2000);
            reject(new Error('Geolocation not supported'));
            return;
          }
          
          navigator.geolocation.getCurrentPosition(
            pos => {
              State.userLocation = { 
                lat: pos.coords.latitude, 
                lng: pos.coords.longitude 
              };
              Toast.show(t('locationObtained'), 1000);
              if (window.mapInstance) {
                MapManager.updateLocation();
              }
              resolve(State.userLocation);
            },
            err => {
              Toast.show(t('locationDenied'), 2000);
              reject(err);
            },
            { enableHighAccuracy: true, timeout: 10000 }
          );
        });
      },
      
      showError() {
        const errorEl = document.getElementById('locationError');
        if (errorEl) {
          errorEl.innerHTML = `
            <strong>${t('locationError')}</strong>
            <p>${t('locationErrorDetail')}</p>
          `;
          errorEl.classList.add('show');
        }
      },
      
      hideError() {
        document.getElementById('locationError').classList.remove('show');
      }
    };

    // ÏßÄÎèÑ Í¥ÄÎ¶¨
    const MapManager = {
      mapInstance: null,
      markerGroup: null, 
      leafletLoaded: false,
      initialized: false,
      initPromise: null, // Ï§ëÎ≥µ Ï¥àÍ∏∞Ìôî Î∞©ÏßÄÏö©
      
      showMap() {
        const mapEl = document.getElementById('map');
        if (mapEl) {
          mapEl.classList.add('show');
        }
      },
      
      hideMap() {
        const mapEl = document.getElementById('map');
        if (mapEl) {
          mapEl.classList.remove('show');
        }
      },
      
      async init() {
        // Ïù¥ÎØ∏ Ï¥àÍ∏∞Ìôî Ï§ëÏù¥Î©¥ Í∏∞Ï°¥ Promise Î∞òÌôò
        if (this.initPromise) {
          return this.initPromise;
        }
        
        // Ïù¥ÎØ∏ Ï¥àÍ∏∞ÌôîÎêòÏóàÏúºÎ©¥ ÏßÄÎèÑÎßå ÌëúÏãú
        if (this.initialized) {
          this.showMap();
          return Promise.resolve();
        }
        
        // Ï¥àÍ∏∞Ìôî ÏãúÏûë
        this.initPromise = this._doInit();
        return this.initPromise;
      },
      
      async _doInit() {
        try {
          // ÏßÄÎèÑ Ïª®ÌÖåÏù¥ÎÑà ÌëúÏãú
          this.showMap();
          
          if (!window.L && !this.leafletLoaded) {
            await this.loadLeaflet();
          }
          
          if (!this.mapInstance) {
            const center = State.userLocation ? 
              [State.userLocation.lat, State.userLocation.lng] : 
              [35.6804, 139.7690];
            
            this.mapInstance = window.mapInstance = L.map('map', { 
              zoomControl: true 
            }).setView(center, 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              maxZoom: 19,
              attribution: '&copy; OSM'
            }).addTo(this.mapInstance);
            
            this.hideError();
            this.initialized = true;
          }
          
          this.renderMarkers();
        } catch (e) {
          this.showError();
          throw e;
        } finally {
          this.initPromise = null;
        }
      },
      
      async loadLeaflet() {
        return new Promise((resolve, reject) => {
          // CSS
          const css = document.createElement('link');
          css.rel = 'stylesheet';
          css.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
          document.head.appendChild(css);
          
          // JS
          const script = document.createElement('script');
          script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
          script.onload = () => {
            this.leafletLoaded = true;
            resolve();
          };
          script.onerror = () => {
            Toast.show(t('mapLoadFailed'), 3000);
            reject(new Error('Failed to load Leaflet'));
          };
          document.body.appendChild(script);
        });
      },
      
      renderMarkers() {
        if (!this.mapInstance || !this.initialized) return;
        
        // Í∏∞Ï°¥ ÎßàÏª§ ÌÅ¥Î¶¨Ïñ¥
        if (this.markerGroup) {
          this.markerGroup.clearLayers();
        } else {
          this.markerGroup = L.layerGroup().addTo(this.mapInstance);
        }
        
        // ÏÇ¨Ïö©Ïûê ÏúÑÏπò ÌëúÏãú
        if (State.userLocation) {
          L.circleMarker([State.userLocation.lat, State.userLocation.lng], {
            radius: 8, 
            fillColor: '#2563eb', 
            color: '#fff', 
            weight: 2, 
            fillOpacity: 1
          }).addTo(this.markerGroup).bindPopup('ÁèæÂú®Âú∞');
        }
        
        // Ïø†Ìè∞ ÎßàÏª§
        State.coupons.forEach(c => {
          if (c.lat != null && c.lng != null) {
            const marker = L.marker([c.lat, c.lng]);
            let popup = `<strong>${c.store}</strong><br>${c.offer}<br>`;
            popup += c.expiry === '9999-12-31' ? 'ÊúüÈôê„Å™„Åó' : c.expiry.replace(/-/g,'/');
            
            if (State.userLocation) {
              const d = Utils.distance(State.userLocation.lat, State.userLocation.lng, c.lat, c.lng);
              popup += `<br>${d < 1 ? Math.round(d * 1000) + 'm' : d.toFixed(1) + 'km'}`;
            }
            
            marker.bindPopup(popup);
            marker.on('click', () => {
              const card = document.querySelector(`[data-id="${c.id}"]`);
              if (card) { 
                card.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                card.focus(); 
              }
            });
            marker.addTo(this.markerGroup);
          }
        });
      },
      
      centerTo(loc) {
        if (this.mapInstance && loc && loc.lat && loc.lng) {
          this.mapInstance.setView([loc.lat, loc.lng], 13);
        }
      },
      
      updateLocation() {
        this.renderMarkers();
        if (State.userLocation) this.centerTo(State.userLocation);
      },
      
      showError() {
        document.getElementById('mapError').style.display = 'block';
      },
      
      hideError() {
        document.getElementById('mapError').style.display = 'none';
      }
    };

    // ÏßÄÎèÑ Ïû¨ÏãúÎèÑ
    window.retryMap = async function() {
      MapManager.hideError();
      await MapManager.init();
    };

    // Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ (ÎåÄÎüâ Ïπ¥Îìú ÎåÄÎπÑ)
    function setupEventDelegation() {
      const grid = document.getElementById('couponGrid');
      if (!grid) return;
      
      // Ïπ¥Îìú ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ
      grid.addEventListener('click', (e) => {
        // Ï†ÄÏû• Î≤ÑÌäº
        const saveBtn = e.target.closest('.save');
        if (saveBtn) {
          e.preventDefault();
          e.stopPropagation();
          const card = saveBtn.closest('.card');
          const id = parseInt(card.getAttribute('data-id'));
          toggleSave(id, saveBtn);
          return;
        }
        
        // Î≥µÏÇ¨ Î≤ÑÌäº
        const copyBtn = e.target.closest('.copy-btn');
        if (copyBtn) {
          e.stopPropagation();
          // Î≥µÏÇ¨ Î°úÏßÅÏùÄ Í∏∞Ï°¥ Ïú†ÏßÄ (ÏΩîÎìúÍ∞Ä Î≤ÑÌäºÏóê Î∞îÏù∏Îî©Îê®)
          return;
        }
        
        // Ïπ¥Îìú Îí§ÏßëÍ∏∞
        const cardInner = e.target.closest('.card-inner');
        if (cardInner && !e.target.closest('.info-item')) {
          const card = cardInner.closest('.card');
          if (card) {
            // Í∏∞Ï°¥ Îí§ÏßëÍ∏∞ Î°úÏßÅ Ïã§Ìñâ
            // TODO: Ïù¥Î≤§Ìä∏ ÏúÑÏûÑÏúºÎ°ú ÏôÑÏ†Ñ Ï†ÑÌôò Ïãú Íµ¨ÌòÑ
          }
        }
      });
    }

    // Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
    function setupEvents() {
      // Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ ÏÑ§Ï†ï (ÎåÄÎüâ Ïπ¥Îìú ÎåÄÎπÑ)
      setupEventDelegation();
      
      // ÌÖåÎßà ÌÜ†Í∏Ä
      document.getElementById('themeToggle').addEventListener('click', Theme.toggle);
      
      // Í∑ºÏ≤ò Î≤ÑÌäº
      document.getElementById('locateBtn').addEventListener('click', async () => {
        try {
          await Location.request();
          await MapManager.init();
          // nearby ÌïÑÌÑ∞ ÏûêÎèô Ï†ÅÏö©
          const nearbyPill = document.querySelector('[data-filter="nearby"]');
          if (nearbyPill) nearbyPill.click();
          // hint ÌëúÏãú
          const hint = document.getElementById('nearbyHint');
          if (hint) hint.classList.add('show');
        } catch (e) {
          Location.showError();
        }
      });
      
      // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', async (e) => {
          e.preventDefault();
          const view = item.dataset.view;
          
          // ÌôúÏÑ± ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
          document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
          item.classList.add('active');
          State.currentView = view;
          
          // Î∑∞ Ï≤òÎ¶¨
          switch(view) {
            case 'home':
              document.querySelector('[data-filter="all"]').click();
              MapManager.hideMap();
              break;
            case 'saved':
              document.querySelector('[data-filter="saved"]').click();
              MapManager.hideMap();
              break;
            case 'map':
              await MapManager.init();
              MapManager.showMap();
              MapManager.centerTo(State.userLocation || {lat: 35.6804, lng: 139.7690});
              Toast.show(t('mapViewTab'));
              // hint ÌëúÏãú
              const hint = document.getElementById('nearbyHint');
              if (hint) hint.classList.add('show');
              break;
            case 'settings':
              Toast.show('Ë®≠ÂÆö„ÅØÊ∫ñÂÇô‰∏≠„Åß„Åô');
              MapManager.hideMap();
              break;
          }
        });
      });
    }

    // Ï¥àÍ∏∞Ìôî
    async function boot() {
      // ÌÖåÎßà Î°úÎìú
      Theme.load();
      
      // Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
      State.saved = StorageManager.getSaved();
      
      // Ïø†Ìè∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (API ÏãúÎèÑ ‚Üí Ï∫êÏãú ‚Üí ÌïòÎìúÏΩîÎî© Ïàú)
      State.coupons = await CouponLoader.loadFromAPI();
      State.filtered = [...State.coupons];
      
      // Ï∫êÏãú ÏóÖÎç∞Ïù¥Ìä∏
      if (State.coupons.length > 0) {
        CouponLoader.cacheData(State.coupons);
      }
      
      // UI ÏÑ§Ï†ï
      setupFilters();
      setupSearch();
      setupEvents();
      
      // Ï¥àÍ∏∞ Î†åÎçîÎßÅ
      applyFilters();
    }

    // DOMContentLoaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', boot);
    } else {
      boot();
    }
  </script>
</body>
</html>
